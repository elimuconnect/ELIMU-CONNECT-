<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Elimu Connect • ShortsGen v4 (9:16 Canvas) — Edited (Music Only)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#1976d2; --math:#ef6c00; --sci:#2e7d32; --eng:#0d47a1;
    --bubble-bg:#fff9e6; --subtitle-bg: rgba(10,25,90,0.85);
  }
  html,body{height:100%;margin:0;font-family:'Patrick Hand', ComicSans, Arial;background:linear-gradient(#e6f7ff,#ffffff);display:flex;justify-content:center;padding:12px}
  .app{width:420px;max-width:100%}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{font-size:1rem;margin:0}
  .controls{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
  select,input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #ddd;font-weight:bold}
  button{background:var(--accent);color:white;border:none;cursor:pointer}
  .small{font-size:.8rem;color:#444}
  #stageWrap{width:360px;height:640px;margin:12px auto;border-radius:18px;overflow:hidden;box-shadow:0 14px 36px rgba(0,0,0,.2);position:relative;background:#222}
  /* Canvas fits inside stageWrap but actual pixels are 720x1280 (portrait) */
  #canvasPreview{width:100%;height:100%;display:block;background:#000}
  .controls .row{display:flex;gap:6px}
  .status{font-size:.9rem;margin-top:8px}
  a.hidden{display:none}
  .hint{font-size:.8rem;color:#555;margin-top:6px}
  @keyframes flash { 0% { opacity: 0; filter: brightness(3); } 100% { opacity: 1; filter: brightness(1); } }
  /* Slight title glow */
  header h1 { background: linear-gradient(90deg,#ff9800,#2196f3); -webkit-background-clip:text; color:transparent; }
  button{ transition: transform .15s ease; }
  button:hover{ transform: scale(1.04); }
</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Elimu Connect • ShortsGen v4</h1>
      <div class="small">9:16 Canvas • Cartoon bubble subtitles • Auto WebM</div>
    </header>

    <div class="controls">
      <label>Duration:
        <select id="duration"><option value="30">30s</option><option value="45">45s</option><option value="60" selected>60s</option></select>
      </label>

      <label>Voice method:
        <select id="voiceMethod">
          <option value="mic">Mic live (embed)</option>
          <option value="upload">Upload voice file (embed)</option>
          <option value="tts">SpeechSynthesis preview (not embedded)</option>
        </select>
      </label>

      <label>Voice gender:
        <select id="voiceGender"><option value="auto">Auto</option><option value="male">Male</option><option value="female">Female</option></select>
      </label>
    </div>

    <div class="controls row">
      <input type="file" id="voiceUpload" accept="audio/*" />
      <button id="useUploadBtn">Use Upload</button>
      <button id="genBtn">🎲 Generate Preview</button>
      <button id="recordBtn">🔴 Start & Record (auto-stop)</button>
    </div>

    <div id="stageWrap" title="This box is the recorded 9:16 area">
      <canvas id="canvasPreview" width="720" height="1280"></canvas>
    </div>

    <div class="controls">
      <a id="downloadLink" class="hidden"></a>
    </div>

    <div class="status" id="status">Click Generate Preview to unlock audio, then press Start & Record.</div>
    <div class="hint">Tip: if browser prompts to allow mic, allow it. For embedded narration use Upload or Mic. TTS is disabled (no narration).</div>
  </div>

<script>


/* ---------- Configuration & assets ---------- */
const CANVAS_W = 720, CANVAS_H = 1280; // portrait 9:16

// updated to free catchy backgrounds (Pixabay/Unsplash style)

const BACKGROUNDS = [
  {name:'Sunny Schoolyard', url:'https://cdn.pixabay.com/photo/2022/10/07/06/11/verbena-7504222_640.jpg'},
  {name:'Green Park', url:'https://cdn.pixabay.com/photo/2020/06/21/10/56/flower-5324314_640.jpg'},
  {name:'Sky & Clouds', url:'https://cdn.pixabay.com/photo/2015/11/10/17/00/still-life-1037378_640.jpg'},
  {name:'Playground', url:'https://cdn.pixabay.com/photo/2022/05/12/20/59/tulips-7192345_640.jpg'},
  {name:'Chalkboard Classroom', url:'https://cdn.pixabay.com/photo/2016/11/29/05/08/chalkboard-1866616_1280.jpg'},
  {name:'Beach', url:'https://cdn.pixabay.com/photo/2024/11/08/13/40/tulips-9183358_640.jpg'},
  {name:'Space (kids)', url:'https://cdn.pixabay.com/photo/2023/12/08/10/56/mandarins-8437425_640.jpg'},
  {name:'Forest Glade', url:'https://cdn.pixabay.com/photo/2015/06/19/21/24/avenue-815297_1280.jpg'},
  {name:'Rainbow Hills', url:'https://cdn.pixabay.com/photo/2016/07/16/16/21/flowers-1522260_640.jpg'},
  {name:'Science Lab', url:'https://cdn.pixabay.com/photo/2023/04/26/16/01/lighthouse-7952718_640.jpg'},

  {name:'Sunny Schoolyard', url:'https://cdn.pixabay.com/photo/2025/09/24/11/49/ai-9852653_1280.jpg'},
  {name:'Green Park', url:'https://cdn.pixabay.com/photo/2024/08/29/12/44/images-9006886_960_720.jpg'},
  {name:'Sky & Clouds', url:'https://cdn.pixabay.com/photo/2017/12/11/15/34/lion-3012515_640.jpg'},
  {name:'Playground', url:'https://cdn.pixabay.com/photo/2024/08/29/12/36/images-9006863_1280.jpg'},
  {name:'Chalkboard Classroom', url:'https://cdn.pixabay.com/photo/2016/02/20/20/17/animals-1212716_960_720.png'},
  {name:'Beach', url:'https://cdn.pixabay.com/photo/2024/08/22/11/59/images-8989212_640.jpg'},
  {name:'Space (kids)', url:'https://cdn.pixabay.com/photo/2023/08/18/18/19/car-8199052_640.jpg'},
  {name:'Forest Glade', url:'https://cdn.pixabay.com/photo/2024/08/22/11/58/images-8989205_640.jpg'},
  {name:'Rainbow Hills', url:'https://cdn.pixabay.com/photo/2024/08/20/13/51/images-8983354_640.jpg'},
  {name:'Science Lab', url:'https://cdn.pixabay.com/photo/2024/08/20/13/51/images-8983354_640.jpg'}
];


const KNOWLEDGE_ITEMS = [
  "The Moon has moonquakes.",
  "Bananas are berries, but strawberries aren't.",
  "Octopuses have three hearts.",
  "Sharks existed before trees.",
  "Honey never spoils.",
  "Some turtles can breathe through their butts.",
  "Water can boil and freeze at the same time.",
  "Sloths can hold their breath longer than dolphins.",
  "There are more stars than grains of sand.",
  "Wombat poop is cube-shaped.",
  "Butterflies taste with their feet.",
  "A day on Venus is longer than a year.",
  "Your stomach gets a new lining every 3-4 days.",
  "Hot water freezes faster than cold water.",
  "Cats can't taste sweetness.",
  "There are more fake flamingos than real ones.",
  "Koalas have fingerprints like humans.",
  "Cows have best friends and get stressed apart.",
  "Sea otters hold hands while sleeping.",
  "Rats laugh when tickled.",
  "Humans share 60% of their DNA with bananas.",
  "A group of flamingos is called a 'flamboyance'.",
  "The heart of a shrimp is located in its head.",
  "The Eiffel Tower grows taller in summer.",
  "Bees can recognize human faces.",
  "A sneeze travels at about 160 km/h.",
  "There’s enough DNA in your body to stretch to Pluto and back.",
  "Ants don’t sleep.",
  "Some frogs can be frozen solid and still survive.",
  "There’s a species of jellyfish that can live forever.",
  "Your nose can remember 50,000 different scents.",
  "Some metals are so reactive they explode in water.",
  "Humans are the only animals that blush.",
  "Tomatoes have more genes than humans.",
  "The shortest war in history lasted only 38 minutes.",
  "A cloud can weigh more than a million kilograms.",
  "The word 'school' comes from a Greek word meaning 'leisure'.",
  "Lightning strikes the Earth about 8 million times a day.",
  "You can’t hum while holding your nose closed.",
  "The average cumulus cloud weighs about 500 tons.",
  "It rains diamonds on Saturn and Jupiter.",
  "A snail can sleep for three years.",
  "Giraffes have the same number of neck bones as humans.",
  "Earth’s rotation is gradually slowing down.",
  "Avocados are fruits, not vegetables.",
  "Penguins propose with pebbles.",
  "Space smells like burnt steak.",
  "An ostrich’s eye is bigger than its brain.",
  "There are more trees on Earth than stars in the Milky Way.",
  "Goldfish can see infrared and ultraviolet light.",
  "A day on Mercury lasts 1,408 hours.",
  "The dot over an 'i' or 'j' is called a tittle.",
  "Your brain generates about 20 watts of power — enough to power a light bulb.",
  "A teaspoon of honey is the life’s work of 12 bees.",
  "If you cut a starfish, it can regrow its arms.",
  "The human body contains enough iron to make a small nail.",
  "The fingerprints of koalas and humans are nearly identical.",
  "Every minute, 240 babies are born around the world.",
  "Polar bears have black skin under their white fur.",
  "The Great Wall of China is not visible from the Moon.",
  "Elephants can’t jump.",
  "Dolphins sleep with one eye open.",
  "Earth is hit by lightning 100 times every second.",
  "Rainbows can appear at night — they’re called moonbows.",
  "The longest hiccuping spree lasted 68 years.",
  "Mosquitoes are attracted to people who just ate bananas.",
  "Your tongue print is unique, just like your fingerprint.",
  "There are more stars in the universe than atoms in a grain of sand.",
  "Peanuts are not nuts; they’re legumes.",
  "Birds are the closest living relatives of dinosaurs.",
  "Octopuses have blue blood.",
  "The smell of freshly cut grass is a plant distress signal.",
  "Some cats are allergic to humans.",
  "Saturn’s rings could disappear in 100 million years.",
  "The inventor of the Pringles can is buried in one.",
  "A 'moment' technically means 90 seconds.",
  "Rabbits can see behind them without moving their heads.",
  "There are more possible chess moves than atoms in the known universe.",
  "Bees can’t see red but can see ultraviolet light.",
  "Humans shed about 600,000 particles of skin every hour.",
  "The longest time between two twins being born is 87 days.",
  "Octopus ink doesn't just hide them — it also dulls predators’ sense of smell.",
  "The first oranges weren’t orange — they were green.",
  "Cleopatra lived closer to the invention of the iPhone than to the building of the pyramids.",
  "Some metals can remember their shape.",
  "The shortest commercial flight lasts only 57 seconds.",
  "Dogs can smell time.",
  "There’s a type of fungus that turns ants into zombies.",
  "The hashtag symbol is technically called an octothorpe.",
  "Your small intestine is about 6 meters long.",
  "Horses can’t vomit.",
  "The word 'nerd' was first coined by Dr. Seuss.",
  "Venus rotates backward compared to most planets.",
  "You can’t fold a piece of paper more than seven times.",
  "Some spiders can fly using electricity in the air.",
  "The longest recorded echo lasted 75 seconds.",
  "Human saliva contains a painkiller stronger than morphine.",
  "Whales can communicate across entire oceans.",
  "The human eye can distinguish about 10 million colors.",
  "Bananas glow blue under black light.",
    "Butterflies can’t fly if they’re too cold.",
  "The human body glows in the dark, but our eyes can’t see it.",
  "Spiders can’t stand the smell of peppermint.",
  "There’s a planet made entirely of diamonds.",
  "A shrimp’s heart beats in its head.",
  "Apples float in water because they’re 25% air.",
  "Humans are the only animals that cook food.",
  "The tongue is the strongest muscle relative to its size.",
  "There are more bacteria in your mouth than people on Earth.",
  "Bubble wrap was originally invented as wallpaper.",
  "Koalas sleep up to 22 hours a day.",
  "The inventor of the frisbee was turned into a frisbee after he died.",
  "Your brain shrinks slightly when you’re dehydrated.",
  "Banging your head against a wall burns 150 calories an hour.",
  "Cows produce more milk when listening to music.",
  "Blue whales have hearts the size of small cars.",
  "Carrots were originally purple, not orange.",
  "Some fish can climb trees.",
  "Lobsters taste with their legs.",
  "Butterflies remember being caterpillars.",
  "Your bones are about five times stronger than steel of the same density.",
  "The average person spends six months of their life waiting for red lights.",
  "Sea cucumbers eat with their feet.",
  "Owls can’t move their eyes — that’s why they turn their heads.",
  "Some lizards can squirt blood from their eyes.",
  "The smell of rain is called petrichor.",
  "Crows can recognize and remember human faces.",
  "Pineapples take nearly two years to grow.",
  "The first alarm clock could only ring at 4 a.m.",
  "Orcas are actually dolphins.",
  "The inventor of the microwave was inspired by a melting chocolate bar.",
  "Snails have thousands of tiny teeth.",
  "A crocodile can’t stick its tongue out.",
  "Sharks are immune to cancer — mostly.",
  "Apples wake you up better than coffee in the morning.",
  "A group of owls is called a parliament.",
  "Gorillas can catch human colds.",
  "Your fingernails grow faster on your dominant hand.",
  "The average person walks around the world three times in a lifetime.",
  "Pigs can’t look up into the sky.",
  "Bamboo can grow almost one meter in a single day.",
  "Jellyfish have been around for more than 500 million years.",
  "Humans and giraffes have the same number of neck bones.",
  "The strongest muscle in your body is your jaw.",
  "There’s enough salt in the ocean to cover all land 500 feet deep.",
  "Rats multiply so quickly that in 18 months, two rats could have a million descendants.",
  "Apples, peaches, and raspberries are all members of the rose family.",
  "Birds don’t urinate.",
  "Antarctica has no official time zone.",
  "If you could fold paper 42 times, it would reach the moon.",
  "The first computer virus was created in 1986.",
  "The human stomach can dissolve razor blades.",
  "Some cats have thumbs.",
  "The first oranges were actually green.",
  "Sound travels 15 times faster through steel than through air.",
  "Earth once had two moons.",
  "Potatoes can absorb and reflect Wi-Fi signals.",
  "An octopus can taste with its tentacles.",
  "Sea lions have rhythm — they can dance to a beat.",
  "Dolphins have names for each other.",
  "In Japan, letting a sumo wrestler make your baby cry is considered good luck.",
  "Bubble tea was invented by accident.",
  "A group of frogs is called an army.",
  "Your heart beats about 100,000 times a day.",
  "Some jellyfish can clone themselves.",
  "Chewing gum helps you concentrate.",
  "A single strand of spider silk is thinner than human hair but five times stronger than steel.",
  "The average person produces 25,000 quarts of saliva in a lifetime.",
  "Bees sometimes sting other bees.",
  "The inventor of matchsticks was a pharmacist.",
  "The fingerprints of twins are different.",
  "The world’s largest desert isn’t the Sahara — it’s Antarctica.",
  "Koalas have chlamydia.",
  "Your taste buds have a lifespan of about 10 days.",
  "A single sneeze can spread over 100,000 germs.",
  "Sharks can live for up to 500 years.",
  "Some plants can count and do math.",
  "The smell of vanilla comes from beaver glands in some perfumes.",
  "A bolt of lightning is five times hotter than the sun.",
  "The average human eats 70 insects a year while sleeping.",
  "Tigers’ skin is striped, not just their fur.",
  "Dolphins sleep half their brain at a time.",
  "Bees can make colored honey if they eat colored syrup.",
  "Snakes can help predict earthquakes.",
  "Some turtles can live without food for over a year.",
  "Humans are born with 300 bones but die with 206.",
  "Caterpillars have 12 eyes.",
  "There’s a mushroom that can control ants’ minds.",
  "Elephants use their trunks as snorkels.",
  "Bats always turn left when leaving a cave.",
  "Pineapple works as a natural meat tenderizer.",
  "Ants can lift up to 50 times their body weight.",
  "Rain contains vitamin B12.",
  "You can’t breathe and swallow at the same time.",
  "Cows moo in regional accents.",
  "Goldfish lose their color if kept in dim light.",
  "There’s a phobia of long words — called hippopotomonstrosesquippedaliophobia.",
  "Humans are the only animals that cry emotional tears.",
  "The unicorn is Scotland’s national animal.",
  "Dragonflies have six legs but can’t walk.",
  "Some sea cucumbers fight by vomiting their organs.",
  "The average person will spend six years of their life dreaming.",
  "Giraffes only sleep about 30 minutes a day.",
  "Slugs have four noses.",
  "A group of porcupines is called a prickle.",
  "The inventor of the lightbulb also created the first movie camera.",
  "Male seahorses give birth to babies.",
  "Roses can grow taller than humans in some regions.",
  "Coconuts kill more people each year than sharks.",
  "Some animals dream just like humans.",
  "There are more stars in the universe than all the grains of sand on Earth.",
  "Bees can fly higher than Mount Everest.",
  "A crocodile can’t move its tongue.",
  "Kangaroos can’t walk backward.",
  "The longest wedding veil was longer than 60 football fields.",
  "Your brain is 73% water.",
  "The first person convicted of speeding was going 13 km/h.",
  "A day on Pluto lasts 153 hours.",
  "A group of jellyfish is called a smack.",
  "Sharks can smell a drop of blood from miles away.",
  "The dot on the number 9 is called a 'plume'.",
  "Ravens can solve puzzles as well as seven-year-old children.",
  "Camels have three eyelids.",
  "Some frogs give birth through their skin.",
  "Humans and cows share about 80% of their DNA.",
  "A shrimp’s heart beats 120 times per minute.",
  "Snakes can sense heat with their tongues.",
  "There’s enough water in Lake Superior to cover North and South America in one foot of water.",
  "Ants never get fat.",
  "Your left lung is smaller than your right to make room for your heart.",
  "The fingerprints of a lemur are almost identical to humans.",
  "Jellyfish don’t have brains, hearts, or bones.",
  "Sharks are older than dinosaurs.",
  "Some moths drink the tears of sleeping birds.",
  "Apples are 25% air — that’s why they float.",
  "Bananas share 50% of their DNA with humans.",
  "Sea sponges are animals, not plants.",
  "Otters use rocks as tools.",
  "You can’t tickle yourself.",
  "A sneeze can travel faster than a hurricane wind.",
  "An octopus has nine brains.",
  "It rains metal on Venus.",
  "Humans can live longer without food than sleep.",
  "There are more plastic flamingos than real ones on Earth.",
  "Dolphins can recognize themselves in mirrors.",
  "A bolt of lightning can power 200 homes for a day.",
  "You are taller in the morning than at night.",
  "Some frogs glow under UV light.",
  "The world’s largest living structure is the Great Barrier Reef.",
  "Some plants can hear themselves being eaten.",
  "A baby blue whale gains 90 kilograms every day.",
  "Sea otters have the thickest fur in the animal kingdom.",
  "Butterflies can see ultraviolet light.",
  "Your body has enough carbon to make 900 pencils.",
  "A starfish has no brain or blood.",
  "The first email was sent in 1971.",
  "Some mushrooms glow in the dark.",
  "Rabbits can’t vomit.",
  "An octopus has three hearts and blue blood.",
  "The longest time someone has hiccupped is 68 years.",
  "A bolt of lightning lasts less than one second but is 30,000°C hot.",
  "A cat’s whiskers are as wide as its body.",
  "Most of the dust in your house is made from dead skin.",
  "Sharks don’t have bones.",
  "The smell of cut grass is a distress signal.",
  "The human brain stops growing at age 25.",
  "The ocean produces 70% of the Earth’s oxygen.",
  "The first person to be called a 'nerd' was in 1950.",
  "Pigeons can recognize themselves in a mirror.",
  "Cows produce different milk when they hear happy music.",
  "Every year, millions of trees grow from squirrels forgetting their nuts.",
  "Rainbows can appear double or even triple at once."


];

let knowledgeIndex = 0; // track which item is currently shown




// animals + birds + butterflies
const ANIMALS = {
  dogs:['https://cdn.pixabay.com/photo/2025/06/20/10/47/dog-9670619_640.jpg'],
  cats:['https://cdn.pixabay.com/photo/2022/03/27/11/23/cat-7094808_640.jpg'],
  birds:['https://cdn.pixabay.com/photo/2023/07/24/22/07/european-herring-gull-8147941_640.jpg','https://cdn.pixabay.com/photo/2017/12/16/16/47/bat-3022923_640.jpg','https://cdn.pixabay.com/photo/2024/08/15/13/28/keeled-skimmer-8971155_640.jpg'],
  butterflies:['https://cdn.pixabay.com/photo/2023/05/30/15/12/blue-butterfuly-8028888_640.jpg','https://cdn.pixabay.com/photo/2021/07/12/05/02/mazarine-blue-6405362_640.jpg','https://cdn.pixabay.com/photo/2016/10/19/13/42/eagle-1753002_640.jpg']
};

/* ---------- PIXABAY TRACKS (your chosen 4)
   We use direct mp3 download CDN links (these should stream from Pixabay).
   If any fail, download them and host them locally and update the URLs.
*/
const backgroundMusicList = [
  'https://elimuconnect.github.io/ELIMU-CONNECT-/music1.mp3',
   'https://elimuconnect.github.io/ELIMU-CONNECT-/music2.mp3',
   'https://elimuconnect.github.io/ELIMU-CONNECT-/music3.mp3',
    'https://elimuconnect.github.io/ELIMU-CONNECT-/music4.mp3',
];


/* ---------- Canvas & drawing ---------- */
const canvas = document.getElementById('canvasPreview');
const ctx = canvas.getContext('2d', { alpha: false });

// scene state with flying animals & emojis
let scene = {
  backgroundImg: null,
  bgName: '',
  clouds: [
    {x:-200, y:100, w:200, h:90, speed: 0.2},
    {x:-350, y:240, w:220, h:100, speed: 0.12}
  ],
  animalA: {img:null, x:CANVAS_W*0.12, y:CANVAS_H-320, w:180, h:180, bounceTimer:0},
  animalB: {img:null, x:CANVAS_W*0.62, y:CANVAS_H-300, w:150, h:150, bounceTimer:0},
  flying: [], // additional flying animals (birds & butterflies)
  emojis: [], // moving emojis
  bubble: {text:'Welcome!', x:CANVAS_W*0.5, y:120},
  subtitle: {text:'', x:CANVAS_W*0.5, y:CANVAS_H - 120}
};

/* ---------- UI elements ---------- */
const durationSel = document.getElementById('duration');
const voiceMethodSel = document.getElementById('voiceMethod');
const voiceGenderSel = document.getElementById('voiceGender');
const voiceUploadEl = document.getElementById('voiceUpload');
const useUploadBtn = document.getElementById('useUploadBtn');
const genBtn = document.getElementById('genBtn');
const recordBtn = document.getElementById('recordBtn');
const statusEl = document.getElementById('status');
const downloadLink = document.getElementById('downloadLink');

let currentTopic = null;
let uploadedAudioBuffer = null;

/* ---------- WebAudio: master mix & music loader ---------- */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;

function ensureAudioCtx(){
  if(!audioCtx){
    audioCtx = new AudioContextClass();
    audioCtx.masterGain = audioCtx.createGain();
    audioCtx.masterGain.gain.value = 1;
    audioCtx.masterDest = audioCtx.createMediaStreamDestination();
    audioCtx.masterGain.connect(audioCtx.masterDest);
    audioCtx.masterGain.connect(audioCtx.destination);
  }
  return audioCtx;
}

// unlock audio on first gesture and also ensure background music can start
function unlockAudioOnGesture(){
  const init = async ()=>{
    ensureAudioCtx();
    if(audioCtx.state === 'suspended') try{ await audioCtx.resume(); }catch(e){}
    // allow bg music to start if prepareScene already requested it
    if(!currentBgSource){ 
      // playRandomBackgroundTrack() will be called by prepareScene if possible; but also allow click to trigger it if not loaded
    }
    document.body.removeEventListener('click', init);
    document.body.removeEventListener('keydown', init);
    statusEl.textContent = 'Audio unlocked — ready.';
  };
  document.body.addEventListener('click', init);
  document.body.addEventListener('keydown', init);
}
unlockAudioOnGesture();

// BG track handling - load as AudioBuffer for recording capture
let currentBgSource = null;
let currentBgGain = null;


async function playRandomBackgroundTrack(){
  const ctx = ensureAudioCtx();
  // stop previous
  if(currentBgSource){
    try{ currentBgSource.stop(); }catch(e){}
    try{ currentBgSource.disconnect(); }catch(e){}
    currentBgSource = null;
  }
  if(currentBgGain){ try{ currentBgGain.disconnect(); }catch(e){} currentBgGain=null; }

  const url = backgroundMusicList[Math.floor(Math.random()*backgroundMusicList.length)];
  try{
    const resp = await fetch(url);
    const ab = await resp.arrayBuffer();
    const buf = await ctx.decodeAudioData(ab);
    const src = ctx.createBufferSource();
    const gain = ctx.createGain();
    src.buffer = buf;
    src.loop = true;
    gain.gain.value = 0.8;
    src.connect(gain); gain.connect(ctx.masterGain);
    try{ src.start(); }catch(err){
      try{ await ctx.resume(); src.start(); }catch(err){ console.warn('bg start error', err); }
    }
    currentBgSource = src; currentBgGain = gain;
    return {src, gain};
  }catch(err){
    console.warn('Failed to load bg track', err);
    statusEl.textContent = 'Could not load background track (no fallback audio).';
    return null;
  }
}



function stopCurrentBgTrack(){
  try{ if(currentBgSource){ currentBgSource.stop(); currentBgSource.disconnect(); currentBgSource=null; } }catch(e){}
  if(currentBgGain){ try{ currentBgGain.disconnect(); }catch(e){} currentBgGain=null; }
}

/* ---------- Simple synth fallback patterns (kept) ---------- */
let bgPatternInterval = null, bgOscs = [];
function startBgPattern(idx){
  stopBgPattern();
  const ctx = ensureAudioCtx();
  if(idx === 0){
    const notes = [523.25, 659.25, 783.99, 1046.5];
    bgOscs = notes.map(n => {
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = n; g.gain.value = 0;
      o.connect(g); g.connect(ctx.masterGain); o.start();
      return {o,g};
    });
    bgPatternInterval = setInterval(()=>{
      const t = ctx.currentTime;
      bgOscs.forEach((og,i)=>{
        og.g.gain.cancelScheduledValues(t);
        og.g.gain.linearRampToValueAtTime(0.07, t+0.01);
        og.g.gain.linearRampToValueAtTime(0, t+0.45);
      });
    }, 520);
  } else if(idx === 1){
    const notes = [392, 523.25, 659.25, 784];
    bgOscs = notes.map(n => {
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'square'; o.frequency.value = n; g.gain.value = 0;
      o.connect(g); g.connect(ctx.masterGain); o.start();
      return {o,g};
    });
    bgPatternInterval = setInterval(()=>{
      const t = ctx.currentTime;
      bgOscs.forEach((og,i)=>{
        og.g.gain.cancelScheduledValues(t);
        og.g.gain.linearRampToValueAtTime(0.07, t+0.01);
        og.g.gain.linearRampToValueAtTime(0, t+0.5);
      });
    }, 480);
  } else {
    bgPatternInterval = setInterval(()=>{
      const o = ctx.createOscillator(); const g = ctx.createGain();
      o.type = 'triangle'; o.frequency.value = 600;
      o.connect(g); g.connect(ctx.masterGain);
      const t = ctx.currentTime;
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.14, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, t+0.5);
      o.start(); o.stop(t+0.55);
    }, 700);
  }
}
function stopBgPattern(){ if(bgPatternInterval) { clearInterval(bgPatternInterval); bgPatternInterval = null; } if(bgOscs){ bgOscs.forEach(x=>{ try{x.o.stop()}catch(e){} }); bgOscs = []; } }

/* ---------- Simple SFX (kept) ---------- */
function playBoing(){ const ctx = ensureAudioCtx(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = 'triangle'; o.frequency.value = 520; o.connect(g); g.connect(ctx.masterGain); const t = ctx.currentTime; g.gain.linearRampToValueAtTime(0.12, t+0.01); g.gain.exponentialRampToValueAtTime(0.0001, t+0.6); o.start(); o.stop(t+0.8); }
function playSparkle(){ const ctx = ensureAudioCtx(); const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = 'sine'; o.frequency.value = 1200; o.connect(g); g.connect(ctx.masterGain); const t = ctx.currentTime; g.gain.linearRampToValueAtTime(0.08, t+0.01); g.gain.exponentialRampToValueAtTime(0.001, t+0.4); o.start(); o.stop(t+0.6); }

/* ---------- Load images helper ---------- */
function loadImg(url){ return new Promise((res,rej)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>res(i); i.onerror=()=>rej(new Error('Image load error '+url)); i.src=url; }); }

/* ---------- Floating emojis setup ---------- */
const EMOJIS = ['📚','🧮','🎨','✏️','💡','🔢','🧑‍🏫','🌈','🐶','🐱'];
function spawnEmojis(count=12){
  scene.emojis = [];
  for(let i=0;i<count;i++){
    scene.emojis.push({
      ch: EMOJIS[Math.floor(Math.random()*EMOJIS.length)],
      x: Math.random()*CANVAS_W,
      y: Math.random()*CANVAS_H,
      vx: (Math.random()*2-1)*0.6,
      vy: - (0.3 + Math.random()*0.9),
      size: 20 + Math.random()*36,
      rot: Math.random()*Math.PI*2,
      rotV: (Math.random()*2-1)*0.03
    });
  }
}

/* ---------- Flying animals (birds & butterflies) ---------- */
function spawnFlyingAnimals(){
  scene.flying = [];
  // spawn 2 birds and 2 butterflies for a lively scene
  for(let i=0;i<2;i++){
    const imgUrl = ANIMALS.birds[i % ANIMALS.birds.length];
    scene.flying.push({ type:'bird', imgUrl, x: -50 - Math.random()*200, y: 100 + Math.random()*300, vx: 0.6 + Math.random()*1.2, vy: Math.sin(Math.random()*2)*0.3, size: 60 + Math.random()*60, img:null });
  }
  for(let i=0;i<2;i++){
    const imgUrl = ANIMALS.butterflies[i % ANIMALS.butterflies.length];
    scene.flying.push({ type:'butterfly', imgUrl, x: CANVAS_W + 50 + Math.random()*200, y: 200 + Math.random()*500, vx: - (0.4 + Math.random()*1.1), vy: Math.sin(Math.random()*2)*0.2, size: 50 + Math.random()*40, img:null });
  }
}

/* ---------- Randomize & prepare scene (load images & spawn objects) ---------- */
let assetsLoaded = false;

async function prepareScene() {
  statusEl.textContent = 'Preparing scene and assets...';
  assetsLoaded = false;

  // pick background
  const bg = BACKGROUNDS[Math.floor(Math.random() * BACKGROUNDS.length)];
  scene.bgName = bg.name;
  try {
    scene.backgroundImg = await loadImg(bg.url);
  } catch (e) {
    console.warn('bg load failed', e);
    scene.backgroundImg = null;
  }

  // pick animals and load them
  const dogUrl = ANIMALS.dogs[Math.floor(Math.random() * ANIMALS.dogs.length)];
  const catUrl = ANIMALS.cats[Math.floor(Math.random() * ANIMALS.cats.length)];
  try { scene.animalA.img = await loadImg(dogUrl); } catch (e) { scene.animalA.img = null; }
  try { scene.animalB.img = await loadImg(catUrl); } catch (e) { scene.animalB.img = null; }

  // load flying animals images
  spawnFlyingAnimals();
  for (const f of scene.flying) {
    try { f.img = await loadImg(f.imgUrl); } catch (e) { f.img = null; }
  }

  // spawn emojis
  spawnEmojis(16);

// --- Random fact selection without repeats ---
if (typeof window.unusedFacts === 'undefined' || window.unusedFacts.length === 0) {
  // All used or first load → reset with a shuffled copy
  window.unusedFacts = [...KNOWLEDGE_ITEMS].sort(() => Math.random() - 0.5);
}

// Get one random unused fact
const knowledge = window.unusedFacts.pop(); // removes from the end

// Assign to scene
scene.bubble.text = knowledge;
scene.subtitle.text = knowledge;

  // ensure audio unlocked
  ensureAudioCtx();

  // attempt to load background track (AudioBuffer) and play (loop)
  try {
    await playRandomBackgroundTrack();
  } catch (e) {
    console.warn('playRandomBackgroundTrack error', e);
  }

  // small burst to emojis for instant energy
  for (let e of scene.emojis) {
    e.vy -= Math.random() * 4 + 2;
  }
  playSparkle();

  assetsLoaded = true;

  // power-on visual flash
  canvas.style.animation = 'flash 0.6s ease-out';
  setTimeout(() => canvas.style.animation = '', 600);

  statusEl.textContent = `Prepared: ${scene.bgName}`;
}

/* ---------- Drawing helpers ---------- */
function drawRoundRect(x,y,w,h,r, fill, stroke, lineWidth=2){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
  if(fill){ ctx.fillStyle = fill; ctx.fill(); }
  if(stroke){ ctx.lineWidth = lineWidth; ctx.strokeStyle = stroke; ctx.stroke(); }
}
function wrapText(context, text, x, y, maxWidth, lineHeight){
  const words = text.split(' ');
  let line = '', testLine, metrics, testWidth;
  let curY = y - (lineHeight/2);
  for (let n = 0; n < words.length; n++) {
    testLine = line + words[n] + ' ';
    metrics = context.measureText(testLine);
    testWidth = metrics.width;
    if (testWidth > maxWidth && n > 0) {
      context.fillText(line, x, curY);
      line = words[n] + ' ';
      curY += lineHeight;
    } else {
      line = testLine;
    }
  }
  context.fillText(line, x, curY);
}

/* ---------- Drawing scene ---------- */
function drawScene(t){
  // clear & background
  ctx.clearRect(0,0,CANVAS_W,CANVAS_H);
  if(scene.backgroundImg) ctx.drawImage(scene.backgroundImg, 0,0,CANVAS_W,CANVAS_H);
  else { ctx.fillStyle = '#88d'; ctx.fillRect(0,0,CANVAS_W,CANVAS_H); }

  // clouds
  for(const c of scene.clouds){
    c.x += c.speed * (1 + Math.sin(t/200));
    if(c.x > CANVAS_W + 200) c.x = -250;
    ctx.save(); ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.beginPath();
    ctx.ellipse(c.x, c.y, c.w*0.6, c.h*0.6, 0, 0, Math.PI*2);
    ctx.ellipse(c.x + c.w*0.4, c.y - 10, c.w*0.5, c.h*0.45, 0,0,Math.PI*2);
    ctx.ellipse(c.x + c.w*0.7, c.y + 6, c.w*0.35, c.h*0.33, 0,0,Math.PI*2);
    ctx.fill(); ctx.restore();
  }

  // flying animals
  for(const f of scene.flying){
    // update
    f.x += f.vx * (1 + Math.sin(t/600 + f.y*0.01));
    f.y += Math.sin((t + f.x) / 600) * 0.8 + f.vy * 0.5;
    // wrap or bounce
    if(f.vx > 0 && f.x > CANVAS_W + 150) { f.x = -150; f.y = 50 + Math.random()*600; }
    if(f.vx < 0 && f.x < -150) { f.x = CANVAS_W + 150; f.y = 50 + Math.random()*600; }
    ctx.save();
    if(f.img) ctx.drawImage(f.img, f.x, f.y, f.size, f.size);
    ctx.restore();
  }

  // animals (bounce)
  function drawAnimal(a, tOffset){
    const bounce = Math.sin((t + (a.bounceTimer||0)) / 300) * 12;
    const x = a.x; const y = a.y + bounce;
    ctx.save();
    ctx.beginPath(); ctx.ellipse(x + a.w/2, y + a.h - 20, a.w*0.3, 12, 0, 0, Math.PI*2); ctx.fillStyle = 'rgba(0,0,0,0.12)'; ctx.fill();
    if(a.img) ctx.drawImage(a.img, x, y, a.w, a.h);
    ctx.restore();
  }
  scene.animalA.x = CANVAS_W*0.12; scene.animalB.x = CANVAS_W*0.62;
  drawAnimal(scene.animalA, t); drawAnimal(scene.animalB, t);

  // emojis
  for(const e of scene.emojis){
    e.x += e.vx;
    e.y += e.vy;
    e.vy += 0.01; // gravity-like slow acceleration
    e.rot += e.rotV;
    // reset if gone out of bounds
    if(e.y < -120 || e.y > CANVAS_H + 120 || e.x < -80 || e.x > CANVAS_W + 80) {
      e.y = Math.random()*CANVAS_H;
      e.x = Math.random()*CANVAS_W;
      e.vy = - (0.3 + Math.random()*0.9);
      e.vx = (Math.random()*2-1)*0.6;
    }
    ctx.save();
    ctx.translate(e.x, e.y);
    ctx.rotate(e.rot);
    ctx.font = `${e.size}px "Patrick Hand", Arial`;
    ctx.fillText(e.ch, 0, 0);
    ctx.restore();
  }

  // TOP text - "Do you Know?"
ctx.fillStyle = 'rgba(255,255,255,0.9)';
ctx.font = 'bold 72px "Patrick Hand", Arial';
ctx.textAlign = 'center';
ctx.textBaseline = 'top';
ctx.fillText("Do you Know?", CANVAS_W/2, 40);

// BOTTOM text - current knowledge item
const bottomText = KNOWLEDGE_ITEMS[knowledgeIndex % KNOWLEDGE_ITEMS.length];

ctx.fillStyle = 'yellow';
ctx.font = 'bold 56px "Patrick Hand", Arial';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
wrapText(ctx, bottomText, CANVAS_W / 2, CANVAS_H / 2, CANVAS_W - 60, 60);


// logo tag (auto-fit)
const logoText = 'Install Elimu Connect App from play store';
ctx.font = '20px "Patrick Hand", Arial';
const paddingX = 16; // horizontal padding
const paddingY = 10; // vertical padding
const textMetrics = ctx.measureText(logoText);
const rectW = textMetrics.width + paddingX * 2;
const rectH = 20 + paddingY * 2; // font size 20 + vertical padding
const rectX = CANVAS_W - rectW - 20; // 20px from right edge
const rectY = CANVAS_H - rectH - 20;  // 20px from bottom edge

drawRoundRect(rectX, rectY, rectW, rectH, 18, 'rgba(255,255,255,0.95)', 'rgba(0,0,0,0.06)', 1);

ctx.fillStyle = '#111';
ctx.textAlign = 'center';
ctx.textBaseline = 'middle';
ctx.fillText(logoText, rectX + rectW/2, rectY + rectH/2);

}

/* ---------- Animation loop ---------- */
let animRunning = false;
function startAnimation(){
  if(animRunning) return;
  animRunning = true;
  let start = performance.now();
  function loop(now){
    const t = now - start;
    scene.animalA.bounceTimer = t; scene.animalB.bounceTimer = t + 70;
    drawScene(t);
    if(animRunning) requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}
function stopAnimation(){ animRunning = false; }

/* ---------- Generate/prepare ---------- */
genBtn.addEventListener('click', async ()=>{
  statusEl.textContent = 'Preparing scene...';
  ensureAudioCtx();
  try{
    await prepareScene();
    // Wait small moment to ensure first frames drawn
    startAnimation();
    setTimeout(()=> { if(!assetsLoaded) return; statusEl.textContent = 'Preview ready: ' + scene.bgName + ' • ' + currentTopic.title; }, 350);
  }catch(e){
    statusEl.textContent = 'Prepare failed: ' + e.message;
    console.error(e);
  }
});

/* ---------- Voice upload handling (left intact) ---------- */
voiceUploadEl.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  statusEl.textContent = 'Decoding uploaded audio...';
  const ab = await f.arrayBuffer();
  ensureAudioCtx();
  uploadedAudioBuffer = await audioCtx.decodeAudioData(ab);
  statusEl.textContent = 'Uploaded voice ready (will be embedded).';
});
useUploadBtn.addEventListener('click', ()=> {
  if(!uploadedAudioBuffer){ statusEl.textContent = 'No uploaded file. Choose an audio file first.'; return; }
  voiceMethodSel.value = 'upload';
  statusEl.textContent = 'Upload selected as narration method.';
});

/* ---------- Removed speech-synthesis narration entirely ----------
   (No TTS calls; only background music will play.)
*/

/* ---------- Recording (canvas capture) ---------- */
let recordedChunks = [];
let mediaRecorder = null;

async function startRecordingAuto() {
  ensureAudioCtx();
  if (audioCtx.state === 'suspended') {
    try { await audioCtx.resume(); } catch (e) {}
  }

  // ✅ get subtitle text directly (no topics)
  const subtitleText = scene?.subtitle?.text || document.getElementById('subtitleText')?.textContent || '';
  if (!subtitleText.trim()) {
    statusEl.textContent = 'Generate preview first.';
    return;
  }

  // ✅ ensure background music
  if (!currentBgSource) await playRandomBackgroundTrack().catch(() => {});

  const dur = parseInt(durationSel.value, 10) || 60;
  statusEl.textContent = 'Recording: ' + dur + 's — preparing streams...';

  // wait for first frame
  await new Promise(r => setTimeout(r, 350));

  // capture canvas
  let videoStream;
  try {
    videoStream = canvas.captureStream(30);
  } catch (err) {
    statusEl.textContent = 'Canvas capture not supported: ' + err.message;
    return;
  }

  // build combined stream
  const combined = new MediaStream();
  videoStream.getVideoTracks().forEach(t => combined.addTrack(t));

  // live mic
  let liveMicStream = null;
  if (voiceMethodSel.value === 'mic') {
    try {
      liveMicStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      liveMicStream.getAudioTracks().forEach(t => combined.addTrack(t));
      statusEl.textContent = '🎙️ Live mic connected — speak during recording.';
    } catch (err) {
      statusEl.textContent = 'Mic unavailable. Uploaded narration will be used if present.';
      console.warn('Mic error', err);
    }
  }

  // uploaded narration
  if (voiceMethodSel.value === 'upload' && uploadedAudioBuffer) {
    const src = audioCtx.createBufferSource();
    src.buffer = uploadedAudioBuffer;
    src.connect(audioCtx.masterGain || audioCtx.destination);
    src.start();
  }

  // add background + sfx
  if (audioCtx.masterDest && audioCtx.masterDest.stream) {
    audioCtx.masterDest.stream.getAudioTracks().forEach(t => combined.addTrack(t));
  }

  // start recording
  recordedChunks = [];
  try {
    mediaRecorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp8,opus' });
  } catch (err) {
    statusEl.textContent = 'MediaRecorder failed: ' + err.message;
    return;
  }

  mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstart = () => { statusEl.textContent = 'Recording... (auto stops after ' + dur + 's)'; };
  mediaRecorder.onerror = e => { statusEl.textContent = 'Recording error: ' + e.message; };
  mediaRecorder.onstop = async () => {
  if (liveMicStream) liveMicStream.getTracks().forEach(t => t.stop());
  stopCurrentBgTrack();

  const blob = new Blob(recordedChunks, { type: 'video/mp4' });
  const url = URL.createObjectURL(blob);
  downloadLink.href = url;
  downloadLink.download = `elimu_short_${dur}s_${Date.now()}.mp4`;
  downloadLink.textContent = '⬇️ Download MP4 (9:16)';
  downloadLink.classList.remove('hidden');
  setTimeout(() => { try { downloadLink.click(); } catch (e) {} }, 300);
  statusEl.textContent = '✅ Recording complete — MP4 file ready.';
};


  mediaRecorder.start(1000);

  // ✅ subtitles and sfx
  const parts = splitText(subtitleText, 3);
  parts.forEach((p, i) => {
    setTimeout(() => {
      if (scene?.subtitle) scene.subtitle.text = p;
      playBoing();
    }, Math.floor((i + 0.5) * (dur / parts.length) * 1000));
  });

  // auto stop
  setTimeout(() => {
    try {
      if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
    } catch (e) {
      console.warn('stop error', e);
    }
  }, dur * 1000 + 500);
}

// helper
function splitText(text, n) {
  const words = text.split(' ');
  const per = Math.ceil(words.length / n);
  const out = [];
  for (let i = 0; i < n; i++) out.push(words.slice(i * per, (i + 1) * per).join(' '));
  return out;
}




/* ---------- Events ---------- */
recordBtn.addEventListener('click', async () => {
  ensureAudioCtx();
  if (audioCtx.state === 'suspended') await audioCtx.resume();

  // 1️⃣ Prepare scene if not loaded
  if (!assetsLoaded) {
    statusEl.textContent = 'Scene not ready. Preparing...';
    try {
      await prepareScene();
      startAnimation();
    } catch (e) {
      statusEl.textContent = 'Failed to prepare scene: ' + e.message;
      console.error(e);
      return;
    }
  }

  // 2️⃣ Request microphone access directly from this click handler
  if (voiceMethodSel.value === 'mic' && !navigator.mediaDevices.getUserMedia) {
    statusEl.textContent = 'Mic not supported in this browser.';
    return;
  }

  // 3️⃣ Start recording immediately
  try {
    await startRecordingAuto();
  } catch (err) {
    statusEl.textContent = 'Recording failed: ' + err.message;
    console.error(err);
  }
});


window.addEventListener('load', ()=> {
  // Warm audio context/voices (no TTS used)
  try { speechSynthesis.getVoices(); } catch(e){}
  // prepare initial scene quietly
  (async ()=>{ try{ await prepareScene(); startAnimation(); }catch(e){console.warn(e);} })();
  statusEl.textContent = 'Ready. Click Generate Preview and then Start & Record.';
});

// Change knowledge item every 3 seconds
setInterval(()=>{
  knowledgeIndex = (knowledgeIndex + 1) % KNOWLEDGE_ITEMS.length;
}, 10000);


</script>
</body>
</html>
