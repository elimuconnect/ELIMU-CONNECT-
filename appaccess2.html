<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elimu Connect - Access</title>
<style>
body {
  font-family: Arial, sans-serif;
  display:flex; justify-content:center; align-items:center; height:100vh;
  background: linear-gradient(to right, #4CAF50, #81C784);
  flex-direction: column;
}
.login-container {
  background:white; padding:30px; border-radius:12px; text-align:center; width:300px; margin-bottom:20px;
}
button {
  padding:12px 20px; margin:8px 0; font-size:16px; border:none; border-radius:8px;
  background:#4CAF50; color:white; cursor:pointer;
}
button:disabled { opacity:0.5; cursor:not-allowed; }
#accessCountdown {
  position: fixed; top: 20px; left: 50%; transform:translateX(-50%);
  background:#0078D7; color:white; padding:10px 20px; border-radius:8px; display:none;
}
#accessModal {
  position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
  display:flex; justify-content:center; align-items:center; display:none; z-index:9999;
}
#accessModal div {
  background:white; padding:25px; border-radius:12px; max-width:350px; text-align:center;
}
#accessModal button { background:#0078D7; color:white; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; }
</style>
</head>
<body>

<div class="login-container">
  <h3>üéì Student</h3>
  <button id="studentBtn">Enter (Free / Paid)</button>
</div>

<div class="login-container">
  <h3>üë®‚Äçüë©‚Äçüëß Parent</h3>
  <button onclick="window.location.href='go:parent'">Parent Dashboard (Free)</button>
</div>

<div id="accessCountdown">Loading access info...</div>

<div id="accessModal">
  <div>
    <p id="accessMessage"></p>
    <button id="accessBtn">OK</button>
  </div>
</div>

<script>
const PAYMENT_LINK = "https://paystack.shop/pay/2i-azr3wzx";

const FIRST_TRIAL_MIN = 2;
const DAILY_FREE_MIN = 1;
const PAID_DURATION = 2 * 60 * 1000;  // 24 hours
const DAILY_INTERVAL = 10 * 60 * 1000; // Renew every 24h

const KEY = "elimu_student16_";

// UI
const mainBtn = document.getElementById("studentBtn");
const countdownEl = document.getElementById("accessCountdown");
const modal = document.getElementById("accessModal");
const modalMsg = document.getElementById("accessMessage");
const modalBtn = document.getElementById("accessBtn");

function getQuery(param){ return new URLSearchParams(location.search).get(param); }
function now(){ return Date.now(); }

function format(ms){
    if(ms <= 0) return "00:00:00";
    let s = Math.floor(ms/1000);
    let h = Math.floor(s/3600);
    s %= 3600;
    let m = Math.floor(s/60);
    s %= 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function showModal(msg, btn="OK", cb=null){
    modalMsg.innerHTML = msg;
    modalBtn.textContent = btn;
    modal.style.display = "flex";
    modalBtn.onclick = ()=>{
        modal.style.display="none";
        if(cb) cb();
    };
}

/* --------------------- STORAGE --------------------- */
let paidUntil = parseInt(localStorage.getItem(KEY+"paidUntil")) || 0;
let paidRef = localStorage.getItem(KEY+"paidReference") || "";

let firstTrialEnd = parseInt(localStorage.getItem(KEY+"firstTrialEnd")) || 0;

let dailyFreeStart = parseInt(localStorage.getItem(KEY+"dailyFreeStart")) || 0;
let dailyFreeEnd = parseInt(localStorage.getItem(KEY+"dailyFreeEnd")) || 0;
let lastDailyFreeUsed = parseInt(localStorage.getItem(KEY+"lastDailyFreeUsed")) || 0;

/* ------------------- HANDLE PAYMENT ------------------- */
const reference = getQuery("reference");

if(reference && reference !== paidRef){
    paidRef = reference;
    paidUntil = now() + PAID_DURATION;

    localStorage.setItem(KEY+"paidReference", paidRef);
    localStorage.setItem(KEY+"paidUntil", paidUntil);

    // Payment overrides all free modes
    localStorage.removeItem(KEY+"firstTrialEnd");
    localStorage.removeItem(KEY+"dailyFreeStart");
    localStorage.removeItem(KEY+"dailyFreeEnd");
    localStorage.removeItem(KEY+"lastDailyFreeUsed");

    firstTrialEnd = 0;
    dailyFreeStart = 0;
    dailyFreeEnd = 0;
    lastDailyFreeUsed = 0;
}

/* ------------------ FIRST TRIAL ------------------ */
if(!firstTrialEnd){
    firstTrialEnd = now() + FIRST_TRIAL_MIN * 60 * 1000;
    localStorage.setItem(KEY+"firstTrialEnd", firstTrialEnd);
}

/* ------------------ DAILY FREE RENEW ------------------ */
/* ------------------ DAILY FREE RENEW (ONLY AFTER FIRST TRIAL ENDS!) ------------------ */
if(firstTrialEnd && now() > firstTrialEnd){  
    // First trial is over ‚Üí now we can activate daily free
    if(!lastDailyFreeUsed || now() - lastDailyFreeUsed >= DAILY_INTERVAL){
        dailyFreeStart = now();
        dailyFreeEnd = now() + DAILY_FREE_MIN * 60 * 1000;

        localStorage.setItem(KEY+"dailyFreeStart", dailyFreeStart);
        localStorage.setItem(KEY+"dailyFreeEnd", dailyFreeEnd);
        localStorage.setItem(KEY+"lastDailyFreeUsed", now());
    }
}


/* ---------------- COUNTDOWN ENGINE ---------------- */
function engine(){
    countdownEl.style.display = "block";
    setInterval(()=>{
        const t = now();

        // PAID MODE
        if(t < paidUntil){
            countdownEl.textContent = "Paid access: " + format(paidUntil - t);
            mainBtn.disabled = false;
            return;
        }

        // DAILY FREE
        if(t < dailyFreeEnd){
            countdownEl.textContent = "Daily free: " + format(dailyFreeEnd - t);
            mainBtn.disabled = false;
            return;
        }

        // FIRST TRIAL
        if(t < firstTrialEnd){
            countdownEl.textContent = "Free trial: " + format(firstTrialEnd - t);
            mainBtn.disabled = false;
            return;
        }

        // NOTHING ACTIVE ‚Üí LOCK
        countdownEl.style.display = "none";
        mainBtn.disabled = true;
        showModal(
            "‚õî Your access has ended.<br>Pay KSh 20 / $0.15 to continue.",
            "Pay Now",
            ()=> location.href = PAYMENT_LINK
        );
    }, 500);
}

engine();

/* ------------------ BUTTON CLICK ------------------ */
mainBtn.onclick = ()=>{
    const t = now();

    if(t < paidUntil) return location.href = "go:bot1";
    if(t < dailyFreeEnd) return location.href = "go:bot1";
    if(t < firstTrialEnd) return location.href = "go:bot1";

    showModal(
        "‚õî Your access has ended.<br>Pay KSh 20 / $0.15 to continue.",
        "Pay Now",
        ()=> location.href = PAYMENT_LINK
    );
};
</script>


</body>
</html>
