<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elimu Connect - Access</title>
<style>
body {
  font-family: Arial, sans-serif;
  display:flex; justify-content:center; align-items:center; height:100vh;
  background: linear-gradient(to right, #4CAF50, #81C784);
}
.login-container {
  background:white; padding:30px; border-radius:12px; text-align:center; width:300px;
}
button {
  padding:12px 20px; margin:8px 0; font-size:16px; border:none; border-radius:8px;
  background:#4CAF50; color:white; cursor:pointer;
}
button:disabled { opacity:0.5; cursor:not-allowed; }
#accessCountdown {
  position: fixed; top: 20px; left: 50%; transform:translateX(-50%);
  background:#0078D7; color:white; padding:10px 20px; border-radius:8px; display:none;
}
#accessModal {
  position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
  display:flex; justify-content:center; align-items:center; display:none; z-index:9999;
}
#accessModal div {
  background:white; padding:25px; border-radius:12px; max-width:350px; text-align:center;
}
#accessModal button { background:#0078D7; color:white; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; }
</style>
</head>
<body>

<div class="login-container">
  <h3>ðŸŽ“ Student</h3>
  <button id="studentBtn">Enter (Free / Paid)</button>
</div>

<div id="accessCountdown">Loading access info...</div>

<div id="accessModal">
  <div>
    <p id="accessMessage"></p>
    <button id="accessBtn">OK</button>
  </div>
</div>

<script>
const PAYMENT_LINK = "https://paystack.shop/pay/57-iapq34s";
const FIRST_ACCESS_MINUTES = 1; // free trial (for testing)
const ACCESS_DURATION = 2*60*1000; // paid duration (2 minutes)
const KEY_PREFIX = "elimu_student2_";

const mainBtn = document.getElementById("studentBtn");
const countdownEl = document.getElementById('accessCountdown');
const modal = document.getElementById('accessModal');
const modalMsg = document.getElementById('accessMessage');
const modalBtn = document.getElementById('accessBtn');

function getQueryParam(param){
    return new URLSearchParams(window.location.search).get(param);
}
function formatTime(ms){
    if(ms<=0) return "00:00";
    let totalSec = Math.floor(ms/1000);
    let m = Math.floor(totalSec/60);
    let s = totalSec%60;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
function showModal(message, btnText="OK", callback=null){
    modalMsg.innerHTML = message;
    modalBtn.textContent = btnText;
    modal.style.display="flex";
    modalBtn.onclick = ()=> {
        modal.style.display="none";
        if(callback) callback();
    };
}

// Load access info from localStorage
let lastPaid = parseInt(localStorage.getItem(KEY_PREFIX+'lastPaidTime')) || 0;
let paidReference = localStorage.getItem(KEY_PREFIX+'paidReference') || "";
let freeEnd = parseInt(localStorage.getItem(KEY_PREFIX+'firstAccessEnd')) || 0;

const now = Date.now();
const reference = getQueryParam('reference');

// Save new payment
if(reference && reference !== paidReference){
    lastPaid = now;
    paidReference = reference;
    localStorage.setItem(KEY_PREFIX+'lastPaidTime', lastPaid);
    localStorage.setItem(KEY_PREFIX+'paidReference', paidReference);
    localStorage.removeItem(KEY_PREFIX+'firstAccessEnd'); // remove free trial
    freeEnd = 0;
}

// Set free trial if not yet started
if(!freeEnd && !lastPaid){
    freeEnd = now + FIRST_ACCESS_MINUTES*60*1000;
    localStorage.setItem(KEY_PREFIX+'firstAccessEnd', freeEnd);
}

// Countdown function
function startCountdown(){
    countdownEl.style.display="block";
    const interval = setInterval(()=>{
        const now = Date.now();

        if(lastPaid && now - lastPaid < ACCESS_DURATION){
            const remaining = ACCESS_DURATION - (now - lastPaid);
            countdownEl.textContent = `Paid access remaining: ${formatTime(remaining)}`;
            mainBtn.disabled = false;
        } else if(freeEnd && now < freeEnd){
            const remaining = freeEnd - now;
            countdownEl.textContent = `Free trial remaining: ${formatTime(remaining)}`;
            mainBtn.disabled = false;
        } else {
            countdownEl.style.display="none";
            mainBtn.disabled = true; // prevent free restart
            showModal(
                "â›” Free trial expired. Pay KSh 10/$0.08 to continue.",
                "Pay Now",
                ()=>{ window.location.href = PAYMENT_LINK; }
            );
        }
    }, 500);
}

startCountdown();

// Button click handler
mainBtn.onclick = ()=>{
    const now = Date.now();
    if(lastPaid && now - lastPaid < ACCESS_DURATION){
        window.location.href = "go:bot1"; // paid section
    } else if(freeEnd && now < freeEnd){
        window.location.href = "go:bot1"; // free section
    } else {
        mainBtn.disabled = true;
        showModal(
            "â›” Free trial expired. Pay KSh 10/$0.08 to continue.",
            "Pay Now",
            ()=>{ window.location.href = PAYMENT_LINK; }
        );
    }
};
</script>

</body>
</html>
