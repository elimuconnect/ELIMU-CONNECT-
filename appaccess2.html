<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elimu Connect - Access</title>
<style>
body {
  font-family: Arial, sans-serif;
  display:flex; justify-content:center; align-items:center; height:100vh;
  background: linear-gradient(to right, #4CAF50, #81C784);
  flex-direction: column;
}
.login-container {
  background:white; padding:30px; border-radius:12px; text-align:center; width:300px; margin-bottom:20px;
}
button {
  padding:12px 20px; margin:8px 0; font-size:16px; border:none; border-radius:8px;
  background:#4CAF50; color:white; cursor:pointer;
}
button:disabled { opacity:0.5; cursor:not-allowed; }
#accessCountdown {
  position: fixed; top: 20px; left: 50%; transform:translateX(-50%);
  background:#0078D7; color:white; padding:10px 20px; border-radius:8px; display:none;
}

/* üëâ Modal is UNDER the Start button now */
#accessModal {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.6);
  display:none;
  justify-content:center; align-items:center;
  z-index:8000;
}

#accessModal div {
  background:white; padding:25px; border-radius:12px; max-width:350px; text-align:center;
}

#accessModal button { background:#0078D7; color:white; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; }
</style>
</head>
  </body>
<!-- Start Button - Always clickable -->
<button id="startBtn" 
        style="position:fixed; top:15px; left:15px; padding:10px 14px; 
               border-radius:8px; background:#333; color:white; 
               border:none; cursor:pointer; z-index:12000;">
    ‚¨Ö Start
</button>

<!-- Remove inline z-index here -->
<div id="accessModal">
  <div>
    <p id="accessMessage"></p>
    <button id="accessBtn">OK</button>
  </div>
</div>


<div class="login-container">
  <h3>üéì Student</h3>
  <button id="studentBtn">üìö Enter (Free Trial / Pro Access)</button>
  <p style="font-size:13px;color:#444;margin-top:10px;">
    ‚è≥ Your free trial or paid access works best without using the Back button. <br>
    ‚ö†Ô∏è After your free trial or paid access ends, the access page may reload several times before it stabilizes. <br>
    ‚úÖ Please wait patiently until the page stops reloading, then click "Unlock" to continue.
  </p>
</div>




  
<div class="login-container">
  <h3>üë®‚Äçüë©‚Äçüëß Parent</h3>
  <button onclick="window.location.href='go:parent'">Parent Dashboard (Free)</button>
</div>

<div id="accessCountdown">Loading access info...</div>


<script>
// --------------------- CONFIGURATION ---------------------
const PAYMENT_LINK = "https://paystack.shop/pay/2i-azr3wzx"; 
const FIRST_TRIAL_MIN = 1;
const PAID_DURATION =   2 * 60 * 1000;
const KEY = "elimu_students19_";

const DAILY_FREE_MIN = 0;         
const DAILY_INTERVAL = 24 * 60 * 60 * 1000; 

// UI Elements
const mainBtn = document.getElementById("studentBtn");
const countdownEl = document.getElementById("accessCountdown");
const modal = document.getElementById("accessModal");
const modalMsg = document.getElementById("accessMessage");
const modalBtn = document.getElementById("accessBtn");
const startBtn = document.getElementById("startBtn");

// State Tracking
let isOnAccessPage = true; 
let modalIsVisible = false;

function now(){ return Date.now(); }

function format(ms){
    if(ms <= 0) return "00:00:00";
    let s = Math.floor(ms/1000);
    let h = Math.floor(s/3600);
    s %= 3600;
    let m = Math.floor(s/60);
    s %= 60;
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function showModal(msg, btnText="OK", cb=null){
    modalMsg.innerHTML = msg;
    modalBtn.textContent = btnText;
    modal.style.display = "flex";
    modalIsVisible = true;

    // Force Start Button to stay above the modal backdrop
    startBtn.style.zIndex = "2147483647";
    startBtn.style.display = "block";

    modalBtn.onclick = ()=>{
        modal.style.display = "none";
        modalIsVisible = false;
        if(cb) cb();
    };
}

// --------------------- STORAGE & INITIALIZATION ---------------------
let paidUntil       = parseInt(localStorage.getItem(KEY+"paidUntil")) || 0;
let firstTrialEnd   = parseInt(localStorage.getItem(KEY+"firstTrialEnd")) || 0;
let dailyFreeEnd    = parseInt(localStorage.getItem(KEY+"dailyFreeEnd"))  || 0;
let lastDailyFreeUsed = parseInt(localStorage.getItem(KEY+"lastDailyFreeUsed")) || 0;

if(!firstTrialEnd && !paidUntil){
    firstTrialEnd = now() + FIRST_TRIAL_MIN * 60 * 1000;
    localStorage.setItem(KEY+"firstTrialEnd", firstTrialEnd);
}

(function checkDailyFree(){
    const t = now();
    if(firstTrialEnd && t > firstTrialEnd){
        if(!lastDailyFreeUsed || t - lastDailyFreeUsed >= DAILY_INTERVAL){
            localStorage.setItem(KEY+"dailyFreeEnd", t + DAILY_FREE_MIN * 60 * 1000);
            localStorage.setItem(KEY+"lastDailyFreeUsed", t);
            dailyFreeEnd = t + DAILY_FREE_MIN * 60 * 1000;
        }
    }
})();

function hasAccess(){
    const t = now();
    return (t < paidUntil || t < firstTrialEnd || t < dailyFreeEnd);
}

// ------------------- UI CONTROL & KICK LOGIC -----------------
function updateUI(){
    const ok = hasAccess();
    mainBtn.disabled = !ok;

    if(!ok && !modalIsVisible){
        countdownEl.style.display = "none";
        showModal(
            "Wait till the page stabilizes<br>üöÄ Your journey to success shouldn't stop here! Unlock 24 hours of AI tutor for exam prep, homework help, quizzes past papers, and STEM labs for just $0.15/KSh 20.",
            "Unlock Daily Pass ‚Äî $0.15/KSh 20.",
            () => { window.location.href = PAYMENT_LINK; }
        );
    } else if (ok) {
        modal.style.display = "none";
        modalIsVisible = false;
    }
}

setInterval(()=>{
    if(!hasAccess()){
        window.location.replace("go:access");
    }
}, 1500);

// ------------------- COUNTDOWN ENGINE -------------------
setInterval(()=>{
    const t = now();
    if(hasAccess()){
        countdownEl.style.display = "block";
        if(t < paidUntil) countdownEl.textContent = "Paid access: " + format(paidUntil - t);
        else if(t < firstTrialEnd) countdownEl.textContent = "Free trial: " + format(firstTrialEnd - t);
        else if(t < dailyFreeEnd) countdownEl.textContent = "Daily free: " + format(dailyFreeEnd - t);
    } else {
        updateUI();
    }
}, 500);

// ------------------- BACK BUTTON PROTECTION -----------------
function forceBackToStart(){ window.location.replace("go:start"); }

window.onpopstate = forceBackToStart;
window.onhashchange = forceBackToStart;

// Memory-safe history pulse (only traps if they have access)
setInterval(()=> {
    if(isOnAccessPage) {
        window.history.pushState(null, "", window.location.href);
    }
}, 200);

document.addEventListener('touchstart', ()=>{
    window.history.pushState(null, "", window.location.href);
}, {passive:true});

// ------------------- NAVIGATION -----------------
startBtn.onclick = () => {
    isOnAccessPage = false;
    window.location.replace("go:start");
};

mainBtn.onclick = () => {
    if(hasAccess()){
        isOnAccessPage = false; // Prevents "Auto-Kick" from seeing this as an error
        window.location.replace("go:bot1");
    } else {
        updateUI();
    }
};

// Final safeguard: Initial UI check
updateUI();


// --- Detect Paystack return & unlock ---
const url = new URL(window.location.href);
const reference = url.searchParams.get("reference");

if (reference) {
    // grant paid access
    paidUntil = now() + PAID_DURATION;
    localStorage.setItem(KEY + "paidUntil", paidUntil);

    localStorage.setItem(KEY + "paidReference", reference);

    // refresh countdown + logic
    paidUntil = parseInt(localStorage.getItem(KEY + "paidUntil")) || 0;

    // clean URL
    url.searchParams.delete("reference");
    window.history.replaceState({}, "", url.toString());

    updateUI();
}



  
</script>
</body>
</html>

