<script>
const PAYMENT_LINK = "https://paystack.shop/pay/2i-azr3wzx";

// 24h trial and 30 days paid access in milliseconds
const FIRST_TRIAL_MS = 24 * 60 * 60 * 1000;       // 24 hours
const PAID_DURATION_MS = 30 * 24 * 60 * 60 * 1000; // 30 days

const KEY = "elimu_student_simple_";

// UI
const mainBtn = document.getElementById("studentBtn");
const countdownEl = document.getElementById("accessCountdown");
const modal = document.getElementById("accessModal");
const modalMsg = document.getElementById("accessMessage");
const modalBtn = document.getElementById("accessBtn");

// Helpers
function now(){ return Date.now(); }

function format(ms){
    if(ms <= 0) return "00:00:00:00";
    let s = Math.floor(ms/1000);
    let days = Math.floor(s / 86400); // 24*3600
    s %= 86400;
    let h = Math.floor(s / 3600);
    s %= 3600;
    let m = Math.floor(s / 60);
    s %= 60;
    return `${days}d ${String(h).padStart(2,'0')}h:${String(m).padStart(2,'0')}m:${String(s).padStart(2,'0')}s`;
}

function showModal(msg, btn="OK", cb=null){
    modalMsg.innerHTML = msg;
    modalBtn.textContent = btn;
    modal.style.display = "flex";
    modalBtn.onclick = ()=>{
        modal.style.display="none";
        if(cb) cb();
    };
}

// --------------------- STORAGE ---------------------
let paidUntil = parseInt(localStorage.getItem(KEY+"paidUntil")) || 0;
let paidRef = localStorage.getItem(KEY+"paidReference") || "";
let firstTrialEnd = parseInt(localStorage.getItem(KEY+"firstTrialEnd")) || 0;

// ------------------- HANDLE PAYMENT -------------------
const reference = new URLSearchParams(location.search).get("reference");
if(reference && reference !== paidRef){
    paidRef = reference;
    paidUntil = now() + PAID_DURATION_MS;

    localStorage.setItem(KEY+"paidReference", paidRef);
    localStorage.setItem(KEY+"paidUntil", paidUntil);

    // Remove trial
    localStorage.removeItem(KEY+"firstTrialEnd");
    firstTrialEnd = 0;
}

// ------------------ FIRST TRIAL ------------------
if(!firstTrialEnd){
    firstTrialEnd = now() + FIRST_TRIAL_MS;
    localStorage.setItem(KEY+"firstTrialEnd", firstTrialEnd);
}

// ---------------- COUNTDOWN ENGINE ----------------
function engine(){
    countdownEl.style.display = "block";
    setInterval(()=>{
        const t = now();

        if(t < paidUntil){
            countdownEl.textContent = "Paid access: " + format(paidUntil - t);
            mainBtn.disabled = false;
            return;
        }

        if(t < firstTrialEnd){
            countdownEl.textContent = "Free trial: " + format(firstTrialEnd - t);
            mainBtn.disabled = false;
            return;
        }

        // LOCK ACCESS
        countdownEl.style.display = "none";
        mainBtn.disabled = true;
        showModal(
            "⛔ Your access has ended.<br>Pay KSh 20 / $0.15 to continue.",
            "Pay Now",
            ()=> location.href = PAYMENT_LINK
        );
    }, 500);
}

engine();

// ------------------ BUTTON CLICK ------------------
mainBtn.onclick = ()=>{
    const t = now();
    if(t < paidUntil || t < firstTrialEnd) return location.href = "go:bot1";

    showModal(
        "⛔ Your access has ended.<br>Pay KSh 20 / $0.15 to continue.",
        "Pay Now",
        ()=> location.href = PAYMENT_LINK
    );
};
</script>
