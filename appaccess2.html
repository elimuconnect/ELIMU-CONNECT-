<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Elimu Connect - Access</title>
<style>
body {
  font-family: Arial, sans-serif;
  display:flex; justify-content:center; align-items:center; height:100vh;
  background: linear-gradient(to right, #4CAF50, #81C784);
  flex-direction: column;
}
.login-container {
  background:white; padding:30px; border-radius:12px; text-align:center; width:300px; margin-bottom:20px;
}
button {
  padding:12px 20px; margin:8px 0; font-size:16px; border:none; border-radius:8px;
  background:#4CAF50; color:white; cursor:pointer;
}
button:disabled { opacity:0.5; cursor:not-allowed; }
#accessCountdown {
  position: fixed; top: 20px; left: 50%; transform:translateX(-50%);
  background:#0078D7; color:white; padding:10px 20px; border-radius:8px; display:none;
}
#accessModal {
  position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
  display:flex; justify-content:center; align-items:center; display:none; z-index:9999;
}
#accessModal div {
  background:white; padding:25px; border-radius:12px; max-width:350px; text-align:center;
}
#accessModal button { background:#0078D7; color:white; padding:10px 18px; border:none; border-radius:8px; cursor:pointer; }
</style>
</head>
<body>

<div class="login-container">
  <h3>üéì Student</h3>
  <button id="studentBtn">Enter (Free / Paid)</button>
</div>

<div class="login-container">
  <h3>üë®‚Äçüë©‚Äçüëß Parent</h3>
  <button onclick="window.location.href='go:parent'">Parent Dashboard (Free)</button>
</div>

<div id="accessCountdown">Loading access info...</div>

<div id="accessModal">
  <div>
    <p id="accessMessage"></p>
    <button id="accessBtn">OK</button>
  </div>
</div>

<script>
const PAYMENT_LINK = "https://paystack.shop/pay/2i-azr3wzx";

// free trial (first time ever)
const FIRST_ACCESS_MINUTES = 2;

// paid duration test (2 minutes) ‚Äì in real use this will be 24 hours
const PAID_DURATION = 3 * 60 * 1000;

// new: free comeback time after 24 hours/paid ends
const RETURN_FREE_MINUTES = 2;

const KEY_PREFIX = "elimu_student6_";

// DOM
const mainBtn = document.getElementById("studentBtn");
const countdownEl = document.getElementById('accessCountdown');
const modal = document.getElementById('accessModal');
const modalMsg = document.getElementById('accessMessage');
const modalBtn = document.getElementById('accessBtn');

// Helpers
function getQueryParam(param){
    return new URLSearchParams(window.location.search).get(param);
}
function formatTime(ms){
    if(ms<=0) return "00:00";
    const totalSec = Math.floor(ms/1000);
    const m = Math.floor(totalSec/60);
    const s = totalSec % 60;
    return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
function showModal(msg, btnText="OK", callback=null){
    modalMsg.innerHTML = msg;
    modalBtn.textContent = btnText;
    modal.style.display="flex";
    modalBtn.onclick = ()=>{
        modal.style.display="none";
        if(callback) callback();
    };
}

// Load localStorage
let lastPaid = parseInt(localStorage.getItem(KEY_PREFIX+'lastPaidTime')) || 0;
let paidReference = localStorage.getItem(KEY_PREFIX+'paidReference') || "";
let freeEnd = parseInt(localStorage.getItem(KEY_PREFIX+'firstAccessEnd')) || 0;
let returnFreeEnd = parseInt(localStorage.getItem(KEY_PREFIX+'returnFreeEnd')) || 0;

const now = Date.now();
const reference = getQueryParam('reference');

// --- PAYMENT RECORD ---
if(reference && reference !== paidReference){
    lastPaid = now;
    paidReference = reference;

    localStorage.setItem(KEY_PREFIX+'lastPaidTime', lastPaid);
    localStorage.setItem(KEY_PREFIX+'paidReference', reference);

    // Clear ALL free timers so paid begins clean
    localStorage.removeItem(KEY_PREFIX+'firstAccessEnd');
    localStorage.removeItem(KEY_PREFIX+'returnFreeEnd');
    
    freeEnd = 0;
    returnFreeEnd = 0;
}

// --- INITIAL FREE TRIAL ---
if(!freeEnd && !lastPaid){
    freeEnd = now + FIRST_ACCESS_MINUTES * 60 * 1000;
    localStorage.setItem(KEY_PREFIX+'firstAccessEnd', freeEnd);
}

// --- COUNTDOWN ---
function startCountdown(){
    countdownEl.style.display="block";

    setInterval(()=>{
        const now = Date.now();

        // 1Ô∏è‚É£ PAID MODE ACTIVE
        if(lastPaid && now - lastPaid < PAID_DURATION){
            const remain = PAID_DURATION - (now - lastPaid);
            countdownEl.textContent = `Paid access remaining: ${formatTime(remain)}`;
            mainBtn.disabled = false;
            return;
        }

        // 2Ô∏è‚É£ FIRST FREE TRIAL ACTIVE
        if(freeEnd && now < freeEnd){
            const remain = freeEnd - now;
            countdownEl.textContent = `Free trial remaining: ${formatTime(remain)}`;
            mainBtn.disabled = false;
            return;
        }

        // 3Ô∏è‚É£ PAID EXPIRED ‚Üí GIVE RETURN FREE TIME (IF NOT USED)
        if(returnFreeEnd === 0 && lastPaid && now - lastPaid >= PAID_DURATION){
            returnFreeEnd = now + RETURN_FREE_MINUTES * 60 * 1000;
            localStorage.setItem(KEY_PREFIX+'returnFreeEnd', returnFreeEnd);
        }

        // 4Ô∏è‚É£ RETURN FREE MODE ACTIVE
        if(returnFreeEnd && now < returnFreeEnd){
            const remain = returnFreeEnd - now;
            countdownEl.textContent = `Free return access: ${formatTime(remain)}`;
            mainBtn.disabled = false;
            return;
        }

        // 5Ô∏è‚É£ EVERYTHING EXPIRED ‚Üí BLOCK
        countdownEl.style.display="none";
        mainBtn.disabled = true;

        showModal(
            "‚õî Your access has ended. Pay KSh 20 / $0.15 to continue.",
            "Pay Now",
            ()=> window.location.href = PAYMENT_LINK
        );
    }, 500);
}

startCountdown();

// --- BUTTON HANDLER ---
mainBtn.onclick = ()=>{
    const now = Date.now();

    if(lastPaid && now - lastPaid < PAID_DURATION){
        window.location.href = "go:bot1";
        return;
    }

    if(freeEnd && now < freeEnd){
        window.location.href = "go:bot1";
        return;
    }

    if(returnFreeEnd && now < returnFreeEnd){
        window.location.href = "go:bot1";
        return;
    }

    showModal(
        "‚õî Your access has ended. Pay KSh 20 / $0.15 to continue.",
        "Pay Now",
        ()=> window.location.href = PAYMENT_LINK
    );
};
</script>

</body>
</html>
