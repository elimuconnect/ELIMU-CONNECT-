<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Allow indexing -->
  <meta name="robots" content="index, follow" />

  <!-- Google Verification -->
  <meta name="google-site-verification" content="ZuK2pvozDS96vm0_IRjSYEsTqSdC8FJCIgJdAitGf0U" />


 <title>Free Tuition ‚Äì Free Online Math Tutor Kenya, English Tutor Kenya & Integrated Science Tutor Kenya (Grades 7‚Äì9)</title>


  <!-- SEO Meta -->
  <meta name="description" content="Smart Tutor Kenya offers FREE live online tuition for CBC & IGCSE Grades 7‚Äì9 in Math, English, and Integrated Science. Join daily lessons in Nairobi, Mombasa, Rift Valley, and across Kenya. Perfect for homeschooling and online learners.">
  <meta name="keywords" content="Smart Tutor Kenya, free online Math tutor Kenya, free online English tutor Kenya, free online Integrated Science tutor Kenya, online tuition Nairobi, online tuition Mombasa, online tuition Rift Valley, CBC tuition Kenya, IGCSE tuition Kenya, homeschooling Kenya, Grade 7 tuition, Grade 8 tuition, Grade 9 tuition, best online tutors Kenya">
  <meta name="author" content="Smart Tutor by Elimu Connect">

  <!-- Open Graph (Social Preview) -->
  <meta property="og:title" content="Smart Tutor ‚Äì Free Online Math, English & Integrated Science Tuition in Kenya (Grades 7‚Äì9)">
  <meta property="og:description" content="Join FREE daily online Math, English, and Integrated Science lessons for CBC & IGCSE Grades 7‚Äì9. Available in Nairobi, Mombasa, Rift Valley, and across Kenya. Perfect for homeschooling and online learning.">
  <meta property="og:url" content="https://elimuconnect.github.io/ELIMU-CONNECT-/alessonsbest">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://elimuconnect.github.io/ELIMU-CONNECT-/images/smart-tutor-banner.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Smart Tutor ‚Äì Free Online Math, English & Integrated Science Tuition in Kenya">
  <meta name="twitter:description" content="Daily live Math, English & Integrated Science lessons for CBC & IGCSE Grades 7‚Äì9 in Nairobi, Mombasa, Rift Valley, and across Kenya. FREE tuition for all students.">
  <meta name="twitter:image" content="https://elimuconnect.github.io/ELIMU-CONNECT-/images/smart-tutor-banner.png">

  <!-- Structured Data (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "EducationalOrganization",
    "name": "Smart Tutor",
    "url": "https://elimuconnect.github.io/ELIMU-CONNECT-/alessonsbest",
    "logo": "https://elimuconnect.github.io/ELIMU-CONNECT-/images/smart-tutor-logo.png",
    "description": "Smart Tutor Kenya provides FREE live online tuition for CBC & IGCSE Grades 7‚Äì9 in Math, English, and Integrated Science. Lessons available in Nairobi, Mombasa, Rift Valley, and across Kenya. Ideal for homeschooling and online learning.",
    "address": {
      "@type": "PostalAddress",
      "addressCountry": "KE"
    },
    "sameAs": [
      "https://elimuconnect.github.io/ELIMU-CONNECT-/"
    ],
    "department": [
      {
        "@type": "Course",
        "name": "Math Tuition Grade 7-9",
        "description": "Free online Math lessons for CBC & IGCSE students in Nairobi, Mombasa, Rift Valley, and across Kenya."
      },
      {
        "@type": "Course",
        "name": "English Tuition Grade 7-9",
        "description": "Free online English lessons for CBC & IGCSE students in Nairobi, Mombasa, Rift Valley, and across Kenya."
      },
      {
        "@type": "Course",
        "name": "Integrated Science Tuition Grade 7-9",
        "description": "Free online Integrated Science lessons for CBC & IGCSE students in Nairobi, Mombasa, Rift Valley, and across Kenya."
      }
    ]
  }
  </script>
  
<style>
* { box-sizing: border-box; }
html, body {
  margin: 0; padding: 0; height: 100%;
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(to right,#e0f7fa,#fce4ec);
}
#app { display: flex; flex-direction: column; height: 100vh; }
#toolbar {
  padding: 15px;
  background: #1976d2;
  color: white;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 12px;
}
#toolbar button {
  background: white;
  color: #1976d2;
  padding: 12px 20px;
  border: none;
  border-radius: 30px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s ease;
}
#toolbar button:hover { background: #f0f0f0; }
#editor {
  flex: 1;
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* ‚úÖ NEW CARD STYLE */
.card {
  max-width: 90vw;
  width: 100%;
  margin: 20px auto;
  padding: 40px;
  background: white;
  border-radius: 25px;
  border: 2px solid #ccc; /* Added border for prominence */
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  font-size: 1.8em;
  line-height: 2;
  font-weight: bold;
  animation: fadeIn 1s ease;
  overflow-wrap: break-word;
  word-break: break-word;
  color: #1a237e;
  box-sizing: border-box;
  transition: all 0.3s ease-in-out; /* Smooth hover or layout changes */
}

/* Headings inside cards */
.card h2 {
  margin-top: 0;
  font-size: 2em;
  font-weight: bold;
}

/* Optional manual title colors */
.card h2.red    { color: #d81b60; }
.card h2.green  { color: #2e7d32; }
.card h2.blue   { color: #1565c0; }
.card h2.orange { color: #ef6c00; }
.card h2.purple { color: #6a1b9a; }

/* Automatic color cycling for h2s inside cards */
.card h2:nth-child(5n+1) { color: #d81b60; }
.card h2:nth-child(5n+2) { color: #2e7d32; }
.card h2:nth-child(5n+3) { color: #1565c0; }
.card h2:nth-child(5n+4) { color: #ef6c00; }
.card h2:nth-child(5n+5) { color: #6a1b9a; }

.card pre {
  white-space: pre-wrap;
  overflow-wrap: break-word;
  word-break: break-word;
  font-size: 1.6em;
  line-height: 2;
  font-weight: bold;
  color: #1a237e;
}

#status {
  padding: 15px;
  background: #388e3c;
  color: white;
  font-weight: bold;
  text-align: center;
  font-size: 16px;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}

 #toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px;
    justify-content: center;
  }

  #toolbar button {
    padding: 12px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    flex: 1 1 auto;
  }

  #toolbar button:hover {
    background: #45a049;
  }

  /* On phones ‚Üí 2 columns */
  @media (max-width: 600px) {
    #toolbar {
      display: grid;
      grid-template-columns: 1fr 1fr;
    }

    #toolbar button {
      width: 100%;
    }
  }

  .card {
    padding: 20px;
    font-size: 1.2em;
  }

  .card h2 {
    font-size: 1.4em;
  }

  .card pre {
    font-size: 1.15em;
  }

  #status {
    font-size: 15px;
    padding: 10px;
  }


/* Extra formatting helpers for lesson text */
.lesson-title {
  color: #d32f2f; /* Deep red */
  font-size: 1.2em;
  display: block;
  margin: 10px 0;
}
.subtopic {
  color: #1976d2; /* Blue */
  font-weight: bold;
  display: block;
  margin-top: 15px;
}
.question {
  color: #f57c00; /* Orange */
  font-weight: bold;
  display: block;
  margin-top: 15px;
}
.answer {
  color: #388e3c; /* Green */
  font-weight: bold;
  display: block;
  margin-top: 15px;
}
.bullet {
  color: #6a1b9a; /* Purple dot */
  margin-right: 8px;
}
.point {
  color: #1a237e;
  display: block;
  margin-left: 20px;
}

.rating {
  margin-top: 20px;
  font-size: 2em;
  color: #ccc;            /* Default gray */
  display: inline-block;
  cursor: pointer;
  user-select: none;
}


.rating span {
  display: inline-block;       /* ensures each star is separate */
  width: 1.2em;                /* adjust to your star size */
  text-align: center;           /* center the star inside its box */
  transition: color 0.3s;
  user-select: none;
}

  .rating {
  touch-action: manipulation;  /* prevents mobile from interpreting swipe/zoom */
}

  .rating span {
  line-height: 1;  /* prevents vertical area being counted as clickable */
}

  
.rating span.active {
  color: gold;   /* clicked/persisted stars */
}
.rating span.hover {
  color: orange; /* temporary preview */
}


  .timetable {
  margin-top: 12px;
  background: #f9fbff;
  padding: 8px;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.timetable h3 {
  margin: 0 0 6px;
  color: #1976d2;
  font-size: 1em;
}

.timetable table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85em; /* smaller font */
}

.timetable th {
  background: #1976d2;
  color: white;
  padding: 4px 6px; /* reduced padding */
  text-align: left;
  border: 1px solid #ccc;
}

.timetable td {
  padding: 4px 6px; /* reduced padding */
  border: 1px solid #ccc;
}

.timetable tr:nth-child(even) {
  background: #f1f6fb;
}

</style>
</head>

<body>
<div id="app">

  <!-- ‚úÖ Curriculum Selection -->
  <div id="curriculumSelect" style="text-align:center; padding:30px;">
    <h2>üìö Choose Your Curriculum</h2>
    <button onclick="chooseCurriculum('CBC')">üá∞üá™ CBC (Kenya)</button>
    <button onclick="chooseCurriculum('British')">üá¨üáß British Curriculum</button>
    <button onclick="chooseCurriculum('CBSE')">üáÆüá≥ India (CBSE)</button>
  </div>

  <!-- ‚úÖ Main Tutor Section (hidden at first) -->
  <div id="mainTutor" style="display:none;">

    <div id="toolbar">
      <button id="loginBtn">üîë Google Login</button>
      <button onclick="startTutor()">‚ñ∂Ô∏è Start Tutor</button>
      <button onclick="pauseTutor()">‚è∏Ô∏è Pause</button>
      <button onclick="resumeTutor()">‚ñ∂Ô∏è Resume</button>
      <button onclick="prevLesson()">‚¨ÖÔ∏è Back</button>
      <button onclick="nextLesson()">‚û°Ô∏è Next</button>
      <button onclick="contactWhatsApp()">üí¨ Customer Care</button>
    </div>

    <div id="editor">

      <!-- Phone Number Form -->
      <div id="phoneForm" style="display:none; text-align:center; padding:20px; margin-bottom:20px; 
           border:1px solid #ccc; border-radius:10px; background:#f9f9f9;">
        <h2>üì± Enter Your Phone Number</h2>
        <p id="studentName"></p>
        <input type="text" id="phoneInput" placeholder="e.g. 07xx xxx xxx" 
               style="padding:10px; font-size:1em; width:80%; max-width:300px; border:1px solid #aaa; border-radius:6px;">
        <br><br>
        <button onclick="savePhoneNumber()" 
                style="padding:10px 20px; font-size:1em; border:none; border-radius:8px; background:#1976d2; color:white; cursor:pointer;">
          Save & Unlock Lessons
        </button>
      </div>

      <!-- Main Tutor Card -->
      <div class="card">
        <div id="ratingMessage" style="display:none; color:#388e3c; font-weight:bold; margin-bottom:10px;"></div>
        <h2>Welcome to Smart Tutor</h2>
        <p id="selectedCurriculum"></p>
        <p>Login with Google to access live Maths lessons (Mon‚ÄìSat) with voice narration.</p>

        <!-- ‚úÖ Maths Timetable Only -->
        <div class="timetable">
          <h3>üìÖ Weekly Timetable (Kenya time)</h3>
          <table>
            <thead>
              <tr>
                <th>Day</th>
                <th>Subject</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Mon ‚Äì Fri</td>
                <td>Math</td>
                <td>5:30 PM ‚Äì 7:00 PM</td>
              </tr>
              <tr>
                <td>Saturday</td>
                <td>Math</td>
                <td>8:00 AM ‚Äì 10:00 AM</td>
              </tr>
              <tr>
                <td>Sunday</td>
                <td colspan="2">No lessons scheduled</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Rating -->
        <div class="rating" id="ratingStars">
          <p style="font-size:0.6em;margin:5px 0;">Rate this Tutor:</p>
          <span data-v="1">‚òÖ</span>
          <span data-v="2">‚òÖ</span>
          <span data-v="3">‚òÖ</span>
          <span data-v="4">‚òÖ</span>
          <span data-v="5">‚òÖ</span>
        </div>
        <p id="ratingValue" style="font-size:0.6em;color:#1976d2;margin-top:6px;">
          Average Rating: <span id="avgRating">‚Äì</span> ‚òÖ
        </p>

        <!-- Lesson Request -->
        <div style="margin-top:20px; padding:10px; border-top:1px solid #ddd;">
          <h3>‚úçÔ∏è Request Lessons for Tomorrow</h3>
          <textarea id="lessonRequest" placeholder="Type the topic you want Smart Tutor to cover‚Ä¶" 
            style="width:100%; height:80px; border-radius:6px; border:1px solid #aaa; padding:8px; font-size:0.9em;"></textarea>
          <br><br>
          <button onclick="saveLessonRequest()" 
            style="background:#28a745;color:white;padding:10px 15px;border:none;border-radius:6px;cursor:pointer;">
            üöÄ Submit Request
          </button>
          <p id="requestStatus" style="font-size:0.8em; margin-top:8px; font-weight:bold;"></p>
        </div>

        <!-- Lesson content container -->
        <div id="lessonContainer"></div>
        <div id="status">‚è≥ Ready‚Ä¶</div>
      </div>
    </div>
  </div>
</div>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-database-compat.js"></script>

<script>
/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCAiOSHmURDyAAYm5EmoomLkZ_Aud7iXIQ",
  authDomain: "cbc-general.firebaseapp.com",
  databaseURL: "https://cbc-general-default-rtdb.firebaseio.com",
  projectId: "cbc-general",
  storageBucket: "cbc-general.firebasestorage.app",
  messagingSenderId: "764732839741",
  appId: "1:764732839741:web:ab829af54839de91359754"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db   = firebase.database();

/* ---------- DOM REFS & GLOBALS ---------- */
const editor = document.getElementById("editor");
const status = document.getElementById("status");
const loginBtn = document.getElementById("loginBtn");
const avgRatingEl = document.getElementById("avgRating");

let user = null;

let currentLesson = 0;
let todayLessons = [];
let selectedVoice = null;
let utter = null;

/* ---------- LESSONS (placeholder ‚Äî replace with your full lessonsArray) ---------- */
const lessonsArray = {
  Mon: { Math: [
    `<h2>Lesson 1 ‚Äî Number Operations</h2><p>Content: Add, subtract, multiply & divide integers.</p>`,
    `<h2>Lesson 2 ‚Äî Fractions</h2><p>Content: Equivalent fractions, addition & subtraction.</p>`
  ]},
  Tue: { Math: [
    `<h2>Lesson 3 ‚Äî Decimals</h2><p>Content: Place value, rounding, operations.</p>`
  ]},
  Wed: { Math: [
    `<h2>Lesson 4 ‚Äî Ratio & Proportion</h2><p>Content: Direct & inverse proportion basics.</p>`
  ]},
  Thu: { Math: [
    `<h2>Lesson 5 ‚Äî Algebra Basics</h2><p>Content: Expressions, simple equations.</p>`
  ]},
  Fri: { Math: [
    `<h2>Lesson 6 ‚Äî Geometry Basics</h2><p>Content: Angles, triangles and perimeter.</p>`
  ]},
  Sat: { Math: [
    `<h2>Lesson 7 ‚Äî Revision & Practice</h2><p>Content: Mixed exercises and quick tests.</p>`
  ]}
};

/* ---------- TIMETABLE (Math only for CBC/British) ---------- */
const timetable = {
  Mon: [ {subject: "Math", start: "17:30", end: "19:00"} ],
  Tue: [ {subject: "Math", start: "17:30", end: "19:00"} ],
  Wed: [ {subject: "Math", start: "17:30", end: "19:00"} ],
  Thu: [ {subject: "Math", start: "16:20", end: "19:00"} ],
  Fri: [ {subject: "Math", start: "17:30", end: "19:00"} ],
  Sat: [ {subject: "Math", start: "08:00", end: "10:00"} ]
};

/* ---------- HELPER: time range ---------- */
function inTimeRange(start, end, now){
  const [sH, sM] = start.split(":").map(Number);
  const [eH, eM] = end.split(":").map(Number);
  const startTime = new Date(now); startTime.setHours(sH, sM, 0, 0);
  const endTime = new Date(now); endTime.setHours(eH, eM, 0, 0);
  return now >= startTime && now <= endTime;
}

/* ---------- VOICE ---------- */
function getVoice(){
  const voices = speechSynthesis.getVoices();
  return voices.find(v=>v.lang && v.lang.toLowerCase().startsWith("en-ke") && v.name.toLowerCase().includes("female"))
         || voices.find(v=>v.lang && v.lang.toLowerCase().startsWith("en-ke"))
         || voices.find(v=>v.lang && v.lang.toLowerCase().startsWith("en-gb"))
         || voices[0];
}

function speak(htmlOrText){
  // accept either raw text or HTML ‚Äî strip tags for speech
  const tmp = document.createElement("div");
  tmp.innerHTML = htmlOrText;
  speechSynthesis.cancel();
  utter = new SpeechSynthesisUtterance(tmp.textContent);
  if (selectedVoice) utter.voice = selectedVoice;
  utter.rate = 0.8;
  speechSynthesis.speak(utter);
}

/* ---------- LOGIN ---------- */
loginBtn.onclick = () => {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
    .then(res => {
      user = res.user;
      status.textContent = `üëã Hi ${user.displayName}`;
      db.ref("students/" + user.uid).update({
        name: user.displayName,
        email: user.email
      });
      checkPhone(user);
    })
    .catch(e => alert(e.message));
};

/* ---------- AUTH STATE (single handler, includes rating restore) ---------- */
auth.onAuthStateChanged(u => {
  user = u;
  if (u) {
    status.textContent = `üëã Hi ${u.displayName}`;

    // save profile lightly
    db.ref("students/" + u.uid).update({
      name: u.displayName,
      email: u.email
    });

    checkPhone(u);

    // restore user's rating (if any)
    db.ref("ratings/" + u.uid).once("value").then(snap => {
      if (snap.exists()) updateStars(snap.val().rating);
      else updateStars(0);
    });
  } else {
    updateStars(0);
  }
});

/* ---------- CHECK PHONE ---------- */
function checkPhone(u) {
  if (!u) return;
  db.ref("students/" + u.uid).once("value").then(snap => {
    if (!snap.exists() || !snap.val().phone) {
      const studentNameEl = document.getElementById("studentName");
      if (studentNameEl) studentNameEl.textContent = `Welcome ${u.displayName}, please enter your phone number:`;
      const pf = document.getElementById("phoneForm");
      if (pf) pf.style.display = "block";
      const card = document.querySelector(".card");
      if (card) card.style.display = "none";
    } else {
      const pf = document.getElementById("phoneForm");
      if (pf) pf.style.display = "none";
      const card = document.querySelector(".card");
      if (card) card.style.display = "block";
    }
  });
}

/* ---------- START TUTOR ---------- */
function startTutor(){
  if(!user){ alert("‚ö†Ô∏è Please login first."); return; }

  db.ref("students/" + user.uid).once("value").then(snap => {
    if(!snap.exists() || !snap.val().phone){
      alert("‚ö†Ô∏è Enter your phone number first.");
      const pf = document.getElementById("phoneForm");
      if (pf) pf.style.display = "block";
      return;
    }

    const now = new Date();
    // adjust to Kenya time (UTC+3) irrespective of user's timezone
    const kenyaTime = new Date(now.getTime() + (3*60 + now.getTimezoneOffset())*60000);
    const days = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const todayName = days[kenyaTime.getDay()];

    const slots = timetable[todayName] || [];
    const currentSlot = slots.find(slot => inTimeRange(slot.start, slot.end, kenyaTime));

    if(!currentSlot){
      if (editor) editor.innerHTML = "<div class='card'><h2>‚è≥ No active lesson right now. Check the timetable.</h2></div>";
      status.textContent = "No active lesson";
      return;
    }

    // load today's lessons for the subject (Math)
    todayLessons = (lessonsArray[todayName] && lessonsArray[todayName][currentSlot.subject]) || [`<div><h2>${currentSlot.subject} Lesson</h2><p>Lesson coming soon.</p></div>`];

    // wait for voices to be available
    const waitVoices = setInterval(()=>{
      if(speechSynthesis.getVoices().length){
        clearInterval(waitVoices);
        selectedVoice = getVoice();
        currentLesson = 0;
        showLesson();
      }
    }, 100);
  });
}

/* ---------- APP FEATURES (rotating snippets) ---------- */
const appFeatures = [
  "üéì Affordable Live Online Tuition ‚Äì From just Ksh 200 per hour",
  "üë©‚Äçüè´ Live group tuition with real tutors from top Kenyan schools",
  "ü§ñ FREE AI-Powered Virtual Tutor ‚Äì 24/7 homework & exam help",
  "üì≤ Connect with nearby tutors for physical or online tuition",
  "üìù On-Demand Homework Help with AI + human tutors",
  "üí¨ Free student academic chats & forums across Kenya",
  "üìö Access 2000+ Video Lessons & 5000+ Quizzes",
  "üìñ 30,000+ CBC, IGCSE & KCSE Past Papers with Answers",
  "üìò 200+ Ebooks for Primary & Secondary Students",
  "üèÜ Weekly National Tests & Digital Certificates",
  "‚ùì 1000+ Question & Answer Pairs from Past Exams",
  "üéÆ 3 Fun Math Games & 3 Kiswahili/English Language Games",
  "üåç Career Guidance Tools for Kenyan Teens",
  "üóìÔ∏è AI-Powered Study Timetable Generator",
  "üìù Digital Notebook, Notes Organizer & Revision Tracker",
  "üßÆ Scientific Calculator + Graph Plotting Tools",
  "üî¢ Math, Chemistry & Physics Formula Tools",
  "üìñ Digital Dictionary & Kiswahili Kamusi",
  "üí° Similes, Metaphors, Methali & Nahau Reference Tools",
  "üßç‚Äç‚ôÇÔ∏è Human, Fish & Plant 3D Anatomy Simulators",
  "üß™ Interactive Digital Periodic Table",
  "‚öõÔ∏è Physics Concepts & Mole Calculators",
  "üß¨ Chemical Equations Balancer + Organic Chemistry Guide",
  "üìê Math Tools: Area, Volume, Trigonometry, Logarithms",
  "üí∞ Financial Math Tools: Tax, Interest, Binomial, Variation",
  "üó∫Ô∏è Geography Tools: Latitude/Longitude, Errors & Approximations",
  "üìä Advanced Statistics & Matrix Solvers",
  "‚ûó Calculus: Differentiation & Integration Calculators"
];
let featureIndex = 0;

/* ---------- SHOW CURRENT LESSON ---------- */
function showLesson() {
  if (!editor) return;
  if (currentLesson >= todayLessons.length) {
    editor.innerHTML = `
      <div class="card">
        <h2>‚úÖ All lessons for this slot are done!</h2>
        <p>Keep learning with <b>Smart Tutor by Elimu Connect</b>.</p>
      </div>
    `;
    return;
  }

  const lessonHtml = todayLessons[currentLesson];

  // Pick 3 rotating features
  const f1 = appFeatures[featureIndex % appFeatures.length];
  const f2 = appFeatures[(featureIndex + 1) % appFeatures.length];
  const f3 = appFeatures[(featureIndex + 2) % appFeatures.length];
  featureIndex += 3;

  editor.innerHTML = `
    <div class="card">
      ${lessonHtml}
      <hr>
      <div style="margin-top:10px; background:#f0f8ff; padding:10px; border-radius:10px; font-size:0.9em;">
        <b>üì≤ More with Elimu Connect App:</b>
        <ul style="margin:5px 0; padding-left:20px;">
          <li>${f1}</li>
          <li>${f2}</li>
          <li>${f3}</li>
        </ul>
        <a href="https://play.google.com/store/apps/details?id=elimuconnect.tuitioncentre" target="_blank">
          <button style="background:#28a745;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
            üöÄ Install App
          </button>
        </a>
      </div>
    </div>
  `;

  speak(lessonHtml);
}

/* ---------- RATING UI & DB ---------- */
const ratingStars = document.querySelectorAll(".rating span");

// Add ratingMessage container if missing
let ratingTimeout;
let ratingMessage = document.getElementById("ratingMessage");
if (!ratingMessage) {
  ratingMessage = document.createElement("div");
  ratingMessage.id = "ratingMessage";
  ratingMessage.style.cssText = `
    display:none; 
    color:#388e3c; 
    font-weight:bold; 
    margin-bottom:10px; 
    opacity:0; 
    transform:translateY(-10px); 
    transition: all 0.5s ease;
  `;
  const firstCard = document.querySelector(".card");
  if (firstCard) firstCard.prepend(ratingMessage);
}

function updateStars(val) {
  ratingStars.forEach(s => {
    s.classList.remove("active");
    if (parseInt(s.dataset.v) <= val) {
      s.classList.add("active");
    }
  });
}

function updateAverageRating() {
  db.ref("ratings").on("value", snapshot => {
    let total = 0, count = 0;
    snapshot.forEach(child => {
      const r = child.val() && child.val().rating ? Number(child.val().rating) : 0;
      total += r;
      count++;
    });

    const avg = count ? (total / count).toFixed(1) : 0;

    if (avgRatingEl) {
      avgRatingEl.textContent = count 
        ? `${avg} (${count} students)` 
        : "No ratings yet";
    }
  });
}
updateAverageRating();

// hover + click handlers
ratingStars.forEach(star => {
  star.addEventListener("mouseover", () => {
    const val = parseInt(star.dataset.v);
    ratingStars.forEach(s => {
      s.classList.toggle("hover", parseInt(s.dataset.v) <= val);
    });
  });

  star.addEventListener("mouseout", () => {
    ratingStars.forEach(s => s.classList.remove("hover"));
    if (user) {
      db.ref("students/" + user.uid).once("value").then(snap => {
        const val = snap.exists() ? (snap.val().rating || 0) : 0;
        updateStars(val);
      });
    } else {
      updateStars(0);
    }
  });

  star.addEventListener("click", async () => {
    if (!user) return alert("‚ö†Ô∏è Login first to save rating.");
    const val = parseInt(star.dataset.v);

    // Save/update student's rating
    await db.ref("students/" + user.uid).update({
      name: user.displayName,
      email: user.email,
      rating: val,
      ratingTimestamp: Date.now()
    });

    // Save in ratings node
    await db.ref("ratings/" + user.uid).set({
      rating: val,
      timestamp: Date.now()
    });

    updateStars(val);

    if (ratingTimeout) clearTimeout(ratingTimeout);

    ratingTimeout = setTimeout(() => {
      ratingMessage.textContent = `Thanks! You rated ${val}‚≠ê`;
      ratingMessage.style.display = "block";
      setTimeout(() => {
        ratingMessage.style.opacity = 1;
        ratingMessage.style.transform = "translateY(0)";
      }, 10);

      setTimeout(() => {
        ratingMessage.style.opacity = 0;
        ratingMessage.style.transform = "translateY(-10px)";
        setTimeout(() => { ratingMessage.style.display = "none"; }, 500);
      }, 3000);

      ratingTimeout = null;
    }, 5000);
  });
});

/* ---------- PHONE SAVE (also used elsewhere) ---------- */
function savePhoneNumber() {
  const phoneEl = document.getElementById("phoneInput");
  const phone = phoneEl ? phoneEl.value.trim() : "";
  if (!phone) {
    alert("‚ö†Ô∏è Please enter your phone number.");
    return;
  }

  if (!user) {
    alert("‚ö†Ô∏è Please login first.");
    return;
  }

  db.ref("students/" + user.uid).update({
    phone: phone,
    timestamp: Date.now()
  }).then(() => {
    alert("‚úÖ Phone number saved! Lessons unlocked.");
    const pf = document.getElementById("phoneForm");
    if (pf) pf.style.display = "none";
    const card = document.querySelector(".card");
    if (card) card.style.display = "block";
    if (editor) editor.scrollIntoView({behavior: "smooth"});
  });
}

/* ---------- NAV CONTROLS ---------- */
function prevLesson(){
  if(todayLessons.length && currentLesson>0){
    currentLesson--;
    showLesson();
  }
}
function nextLesson(){
  if(todayLessons.length && currentLesson<todayLessons.length-1){
    currentLesson++;
    showLesson();
  }
}
function pauseTutor(){ speechSynthesis.pause(); if(status) status.textContent="‚è∏Ô∏è Paused"; }
function resumeTutor(){ speechSynthesis.resume(); if(status) status.textContent="‚ñ∂Ô∏è Resumed"; }
function contactWhatsApp(){ window.open("https://wa.me/254769255782","_blank"); }

/* ---------- LESSON REQUEST ---------- */
function saveLessonRequest() {
  if (!user) {
    alert("‚ö†Ô∏è Please login first to request a lesson.");
    return;
  }

  const requestText = (document.getElementById("lessonRequest") || {value:""}).value.trim();
  const statusEl = document.getElementById("requestStatus");

  if (!requestText) {
    if (statusEl) {
      statusEl.textContent = "‚ùå Please type your lesson request before submitting.";
      statusEl.style.color = "red";
    }
    return;
  }

  const requestsRef = db.ref("students/" + user.uid + "/requests").push();

  requestsRef.set({
    text: requestText,
    timestamp: Date.now()
  }).then(() => {
    if (statusEl) {
      statusEl.textContent = "‚úÖ Your request has been saved!";
      statusEl.style.color = "green";
    }
    const lr = document.getElementById("lessonRequest");
    if (lr) lr.value = "";
  }).catch(err => {
    if (statusEl) {
      statusEl.textContent = "‚ùå Error: " + err.message;
      statusEl.style.color = "red";
    }
  });
}

/* ---------- CURRICULUM ---------- */
function chooseCurriculum(curr) {
  const cs = document.getElementById("curriculumSelect");
  const mt = document.getElementById("mainTutor");
  const sel = document.getElementById("selectedCurriculum");
  if (cs) cs.style.display = "none";
  if (mt) mt.style.display = "block";
  if (sel) sel.innerText = "‚úÖ Curriculum Selected: " + curr;
}

/* ---------- VOICE ALERT: 2 minutes before lesson ---------- */
function checkLessons() {
  const now = new Date();
  // compute Kenya time
  const kenyaNow = new Date(now.getTime() + (3*60 + now.getTimezoneOffset())*60000);
  const day = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][kenyaNow.getDay()];
  const lessons = timetable[day] || [];
  
  lessons.forEach(lesson => {
    const [sH, sM] = lesson.start.split(":").map(Number);
    // alert time = lesson start minus 2 minutes
    const alertTime = new Date(kenyaNow);
    alertTime.setHours(sH, sM - 2, 0, 0);

    // allow 60s window to prevent repeated alerts
    if (kenyaNow >= alertTime && kenyaNow <= new Date(alertTime.getTime() + 60000)) {
      // ensure selectedVoice is ready
      if (!selectedVoice) {
        const waitVoices = setInterval(()=>{
          if (speechSynthesis.getVoices().length) {
            clearInterval(waitVoices);
            selectedVoice = getVoice();
            speak(`Reminder: ${lesson.subject} class starts in 2 minutes.`);
          }
        }, 100);
      } else {
        speak(`Reminder: ${lesson.subject} class starts in 2 minutes.`);
      }
    }
  });
}
setInterval(checkLessons, 60000); // check every minute

</script>

</body>
</html>
