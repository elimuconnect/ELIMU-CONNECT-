<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Elimu Connect â€¢ ShortsGen v2 (Auto WebM)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#1976d2; --math:#ef6c00; --sci:#2e7d32; --eng:#0d47a1;
    --bubble:#fff9e6; --subtitle-bg: rgba(10,25,90,0.85);
  }
  html,body{height:100%;margin:0;font-family:'Patrick Hand', ComicSans, Arial;background:linear-gradient(#e6f7ff,#ffffff);display:flex;justify-content:center;padding:12px}
  .app{width:420px;max-width:100%}
  header{display:flex;justify-content:space-between;align-items:center}
  h1{font-size:1rem;margin:0}
  .controls{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
  select,input[type="file"],button{padding:8px;border-radius:8px;border:1px solid #ddd;font-weight:bold}
  button{background:var(--accent);color:white;border:none;cursor:pointer}
  .small{font-size:.8rem;color:#444}
  #stageWrap{width:360px;height:640px;margin:12px auto;border-radius:18px;overflow:hidden;box-shadow:0 14px 36px rgba(0,0,0,.2);position:relative;background:#88c}
  /* stage is a DIV (we may fallback to screen capture) */
  #stage{width:100%;height:100%;position:relative;background-size:cover;background-position:center;display:block}
  .cloud{position:absolute;width:140px;height:72px;background:#fff;border-radius:40px;box-shadow:38px 18px 0 0 #fff;opacity:.95}
  .bubble{position:absolute;left:50%;transform:translateX(-50%);top:7%;padding:12px 18px;border-radius:22px;background:var(--bubble);color:#1a237e;font-size:20px;text-align:center;box-shadow:0 8px 22px rgba(0,0,0,.18);max-width:85%}
  .subtitle{position:absolute;left:50%;transform:translateX(-50%);bottom:10%;padding:8px 12px;border-radius:12px;background:var(--subtitle-bg);color:white;font-size:16px;box-shadow:0 6px 18px rgba(0,0,0,.2);max-width:90%}
  #lottieHolder{position:absolute;left:50%;transform:translateX(-50%);top:36%;width:220px;height:220px}
  .animal{position:absolute;bottom:12%;width:110px;pointer-events:none;border-radius:10px;background:transparent;transition:transform .3s ease}
  .logoTag{position:absolute;right:10px;bottom:10px;background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:12px;font-weight:bold;color:#111}
  .status{font-size:.9rem;margin-top:8px}
  #downloadLink{display:block;margin-top:8px}
  .row{display:flex;gap:6px;align-items:center}
  .hidden{display:none}
  .hint{font-size:.8rem;color:#555;margin-top:6px}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.6/lottie.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <h1>Elimu Connect â€¢ ShortsGen v2</h1>
      <div class="small">Auto WebM â€¢ Subtitles shown â€¢ 30/45/60s</div>
    </header>

    <div class="controls">
      <label>Duration:
        <select id="duration"><option value="30">30s</option><option value="45">45s</option><option value="60" selected>60s</option></select>
      </label>

      <label>Voice method:
        <select id="voiceMethod">
          <option value="mic">Mic live (speak during recording)</option>
          <option value="upload">Upload voice file (embed)</option>
          <option value="tts">SpeechSynthesis preview (preview only)</option>
        </select>
      </label>

      <label>Voice gender:
        <select id="voiceGender"><option value="auto">Auto</option><option value="male">Male</option><option value="female">Female</option></select>
      </label>
    </div>

    <div class="controls row">
      <input type="file" id="voiceUpload" accept="audio/*" />
      <button id="useUploadBtn">Use Upload</button>
      <button id="genBtn">ðŸŽ² Generate Preview</button>
      <button id="recordBtn">ðŸ”´ Start & Record (auto stop)</button>
    </div>

    <div id="stageWrap">
      <div id="stage" aria-live="polite" aria-label="short preview">
        <div id="cloud1" class="cloud" style="top:12%;left:-30%"></div>
        <div id="cloud2" class="cloud" style="top:24%;left:-45%;width:160px;height:84px;opacity:.9"></div>

        <div id="bubble" class="bubble">Welcome to the lesson!</div>
        <div id="lottieHolder"></div>
        <div id="subtitle" class="subtitle">Subtitles will appear here.</div>

        <img id="animalA" class="animal" src="" style="left:18%;" />
        <img id="animalB" class="animal" src="" style="left:62%;width:95px" />

        <div class="logoTag">Elimu Connect</div>
      </div>
    </div>

    <div class="controls">
      <a id="downloadLink" class="hidden"></a>
    </div>

    <div class="status" id="status">Click any button (e.g., Generate Preview) to activate audio permission. Then click Record to start automatic capture.</div>
    <div class="hint">If the browser asks to share screen, choose the current tab (recommended) to capture visuals. For best results use desktop Chrome/Edge.</div>
  </div>

<script>
/* ---------- Assets ---------- */
const BACKGROUNDS = [
  {name:'Sunny Schoolyard', url:'https://images.unsplash.com/photo-1528484701800-2b6e5b9f7f9c?auto=format&fit=crop&w=800&q=60'},
  {name:'Green Park', url:'https://images.unsplash.com/photo-1502082553048-f009c37129b9?auto=format&fit=crop&w=800&q=60'},
  {name:'Sky & Clouds', url:'https://images.unsplash.com/photo-1502082553048-5f26f4c8d3e0?auto=format&fit=crop&w=800&q=60'},
  {name:'Playground', url:'https://images.unsplash.com/photo-1507537297725-24a1c029d3ca?auto=format&fit=crop&w=800&q=60'},
  {name:'Chalkboard Classroom', url:'https://images.unsplash.com/photo-1515165562835-c15a6f7b1f88?auto=format&fit=crop&w=800&q=60'},
  {name:'Beach', url:'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=800&q=60'},
  {name:'Space (kids)', url:'https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?auto=format&fit=crop&w=800&q=60'},
  {name:'Forest Glade', url:'https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=800&q=60'},
  {name:'Rainbow Hills', url:'https://images.unsplash.com/photo-1501785888041-9f8b9485fb55?auto=format&fit=crop&w=800&q=60'},
  {name:'Science Lab', url:'https://images.unsplash.com/photo-1581091012184-7c3a7b291a46?auto=format&fit=crop&w=800&q=60'}
];

const TOPICS = [
  {title:'Counting to 3', text:'One, two, three! Letâ€™s count with apples.' , class:'math'},
  {title:'Why is the sky blue?', text:'The sky looks blue because sunlight scatters in the air.' , class:'science'},
  {title:'Simple addition', text:'One plus two equals three. Easy peasy!' , class:'math'},
  {title:'Capital letters', text:'A sentence starts with a capital letter.' , class:'english'},
  {title:'Trees help us', text:'Trees give oxygen and shade â€” be kind to trees!' , class:'science'},
  {title:'Funny riddle', text:'What has hands but cannot clap? A clock!' , class:'english'},
  {title:'Colors', text:'Red, blue and green â€” colors make the world fun!' , class:'english'},
  {title:'Square', text:'A square has four equal sides â€” can you draw one?' , class:'math'},
  {title:'Rainbows', text:'Water droplets bend light and create rainbows!' , class:'science'},
  {title:'Share a smile', text:'A smile can make someoneâ€™s day. Share one today!' , class:'english'}
];

const ANIMALS = {
  dogs:['https://cdn-icons-png.flaticon.com/512/194/194279.png','https://cdn-icons-png.flaticon.com/512/616/616408.png'],
  cats:['https://cdn-icons-png.flaticon.com/512/617/617498.png','https://cdn-icons-png.flaticon.com/512/1998/1998615.png']
};

const LOTTIES = [
  "https://assets10.lottiefiles.com/packages/lf20_tll0j4bb.json",
  "https://assets10.lottiefiles.com/packages/lf20_5ngs2ksb.json",
  "https://assets10.lottiefiles.com/packages/lf20_9p1qcihj.json",
  "https://assets10.lottiefiles.com/packages/lf20_2ks3pjua.json",
  "https://assets10.lottiefiles.com/packages/lf20_2glqweqs.json"
];

/* ---------- DOM ---------- */
const stage = document.getElementById('stage');
const bubble = document.getElementById('bubble');
const subtitle = document.getElementById('subtitle');
const cloud1 = document.getElementById('cloud1');
const cloud2 = document.getElementById('cloud2');
const animalA = document.getElementById('animalA');
const animalB = document.getElementById('animalB');
const lottieHolder = document.getElementById('lottieHolder');
const statusEl = document.getElementById('status');
const downloadLink = document.getElementById('downloadLink');

const durationSelect = document.getElementById('duration');
const voiceMethod = document.getElementById('voiceMethod');
const voiceGender = document.getElementById('voiceGender');
const voiceUpload = document.getElementById('voiceUpload');
const useUploadBtn = document.getElementById('useUploadBtn');
const genBtn = document.getElementById('genBtn');
const recordBtn = document.getElementById('recordBtn');

let currentTopic = null;
let uploadedAudioBuffer = null;
let recordedChunks = [];
let mediaRecorder = null;
let currentLottie = null;

/* ---------- AudioContext & WebAudio ---------- */
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
let audioCtx = null; // will create on first gesture
function ensureAudioCtx(){
  if(!audioCtx){
    audioCtx = new AudioContextClass();
    // master gain & destination
    audioCtx.masterGain = audioCtx.createGain();
    audioCtx.masterGain.gain.value = 1;
    audioCtx.masterDest = audioCtx.createMediaStreamDestination();
    audioCtx.masterGain.connect(audioCtx.masterDest);
    // also connect to speakers for preview
    audioCtx.masterGain.connect(audioCtx.destination);
  }
  return audioCtx;
}

/* Ensure we resume audio after a user gesture */
function userGestureInit(){
  // listen once
  const onGesture = async ()=>{
    try{ ensureAudioCtx(); if(audioCtx.state === 'suspended') await audioCtx.resume(); }catch(e){}
    document.body.removeEventListener('click', onGesture);
    document.body.removeEventListener('keydown', onGesture);
    statusEl.textContent = 'Audio unlocked â€” ready.';
  };
  document.body.addEventListener('click', onGesture);
  document.body.addEventListener('keydown', onGesture);
}
userGestureInit();

/* ---------- Background music & SFX ---------- */
let bgInterval = null, bgOscs = [];
function startBackgroundMusic(){
  const ctx = ensureAudioCtx();
  stopBackgroundMusic();
  const notes = [523.25, 659.25, 783.99, 1046.5];
  bgOscs = notes.map((n)=>{
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine'; o.frequency.value = n;
    g.gain.value = 0;
    o.connect(g); g.connect(ctx.masterGain); o.start();
    return {o,g};
  });
  bgInterval = setInterval(()=>{
    const t = ctx.currentTime;
    bgOscs.forEach((og,i)=>{
      og.g.gain.cancelScheduledValues(t);
      og.g.gain.linearRampToValueAtTime(0.06, t+0.01);
      og.g.gain.linearRampToValueAtTime(0.0, t+0.45);
    });
  }, 520);
}
function stopBackgroundMusic(){
  if(bgInterval){ clearInterval(bgInterval); bgInterval = null; }
  if(bgOscs){ bgOscs.forEach(x=>{ try{x.o.stop()}catch(e){} }); bgOscs = []; }
}
function playBoing(){ const ctx=ensureAudioCtx(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='triangle'; o.frequency.value=520; o.connect(g); g.connect(ctx.masterGain); const t=ctx.currentTime; g.gain.linearRampToValueAtTime(0.12,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.6); o.start(); o.stop(t+0.8); }
function playWow(){ const ctx=ensureAudioCtx(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sawtooth'; o.frequency.value=220; o.connect(g); g.connect(ctx.masterGain); const t=ctx.currentTime; g.gain.linearRampToValueAtTime(0.09,t+0.01); g.gain.exponentialRampToValueAtTime(0.001,t+1.0); o.start(); o.stop(t+1.1); }

/* ---------- Lottie ---------- */
let currentLottieObj = null;
function loadLottie(url){
  try{ if(currentLottieObj) currentLottieObj.destroy(); }catch(e){}
  currentLottieObj = lottie.loadAnimation({container:lottieHolder,renderer:'svg',loop:true,autoplay:true,path:url});
}

/* ---------- Helpers ---------- */
function pick(a){ return a[Math.floor(Math.random()*a.length)]; }
function chooseBackground(bg){ stage.style.backgroundImage = `url('${bg.url}')`; stage.setAttribute('data-bg', bg.name); }
function splitText(text, parts){ const words=text.split(' '); const per=Math.ceil(words.length/parts); const out=[]; for(let i=0;i<parts;i++) out.push(words.slice(i*per,(i+1)*per).join(' ')); return out; }

/* ---------- UI: preview generation ---------- */
function animateClouds(){
  [cloud1,cloud2].forEach((c,i)=>{
    const start = -40 - Math.random()*40;
    c.style.left = start + '%';
    c.style.top = (8 + i*12 + Math.random()*8) + '%';
    c.style.transition = `left ${28 + i*12 + Math.random()*12}s linear`;
    void c.offsetWidth;
    setTimeout(()=> c.style.left = '110%', 30 + i*20);
  });
}
function placeAnimals(){
  const dog = pick(ANIMALS.dogs);
  const cat = pick(ANIMALS.cats);
  animalA.src = dog; animalB.src = cat;
  [animalA, animalB].forEach((el, idx)=>{
    if(el._t) clearInterval(el._t);
    const bounce = ()=>{ el.style.transform = 'translateY(-20px) scale(1.05)'; setTimeout(()=> el.style.transform='translateY(0) scale(1)', 420); };
    setTimeout(bounce, 120 + idx*80);
    el._t = setInterval(bounce, 1500 + Math.random()*800);
  });
}

function generatePreview(){
  const bg = pick(BACKGROUNDS);
  chooseBackground(bg);
  const topic = pick(TOPICS);
  currentTopic = topic;
  bubble.textContent = topic.title;
  subtitle.textContent = topic.text;
  // set bubble color for topic
  if(topic.class === 'math'){ bubble.style.background = '#fff3e0'; bubble.style.color = '#bf360c'; }
  else if(topic.class === 'science'){ bubble.style.background = '#e8f5e9'; bubble.style.color = '#1b5e20'; }
  else { bubble.style.background = '#e3f2fd'; bubble.style.color = '#0d47a1'; }

  loadLottie(pick(LOTTIES));
  animateClouds();
  placeAnimals();
  ensureAudioCtx();
  startBackgroundMusic();
  setTimeout(()=> playBoing(), 250);
  setTimeout(()=> playWow(), 850);
  statusEl.textContent = `Preview ready â€” ${topic.title} on "${bg.name}"`;
}

/* ---------- voice upload handling ---------- */
voiceUpload.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  statusEl.textContent = 'Decoding uploaded audio...';
  const ab = await f.arrayBuffer();
  ensureAudioCtx();
  uploadedAudioBuffer = await audioCtx.decodeAudioData(ab);
  statusEl.textContent = 'Uploaded audio ready (will be embedded).';
});
useUploadBtn.addEventListener('click', ()=> {
  if(!uploadedAudioBuffer) { statusEl.textContent = 'Choose an audio file first.'; return; }
  voiceMethod.value = 'upload';
  statusEl.textContent = 'Uploaded audio selected for narration.';
});

/* ---------- Speaking preview (speechSynthesis) ---------- */
function speakPreview(text, gender){
  try{
    const voices = speechSynthesis.getVoices();
    let chosen = null;
    if(gender === 'male') chosen = voices.find(v=>/male|en-GB|en-US/i.test(v.name)) || voices[0];
    else if(gender === 'female') chosen = voices.find(v=>/female|en-GB|en-US/i.test(v.name)) || voices[0];
    else chosen = voices.find(v=>v.lang && v.lang.toLowerCase().includes('en')) || voices[0];
    const ut = new SpeechSynthesisUtterance(text);
    if(chosen) ut.voice = chosen;
    ut.rate = 0.95; ut.pitch = 1.05;
    speechSynthesis.cancel(); speechSynthesis.speak(ut);
  }catch(e){ console.warn('TTS preview error', e); }
}

/* ---------- RECORDING: captureStream fallback & automatic stop ---------- */
async function startRecordingAuto(){
  if(!currentTopic) generatePreview();
  const dur = parseInt(durationSelect.value,10) || 60;
  statusEl.textContent = 'Preparing to record â€” please allow any prompts (screen / mic) if shown.';
  ensureAudioCtx();
  // ensure audio unlocked if suspended
  if(audioCtx.state === 'suspended'){ try{ await audioCtx.resume(); }catch(e){} }

  // Try captureStream on stage (works for <canvas> but not div) â€” fallback to getDisplayMedia
  let videoStream = null;
  if(typeof stage.captureStream === 'function'){
    try{
      videoStream = stage.captureStream(30); // may not be supported on div; but try
    }catch(err){ videoStream = null; }
  }
  if(!videoStream){
    // ask for display capture (user must allow) â€” pick 'this tab' for best result
    try{
      videoStream = await navigator.mediaDevices.getDisplayMedia({ video: { frameRate: 30 }, audio: false });
      // if the returned stream includes audio track (some browsers allow system audio), we still ignore it
    }catch(err){
      statusEl.textContent = 'Screen capture denied or unavailable: ' + err.message;
      return;
    }
  }

  // Build combined stream: video tracks + (live mic tracks if needed) + WebAudio masterDest tracks
  const combined = new MediaStream();
  videoStream.getVideoTracks().forEach(t=> combined.addTrack(t));

  // Add live mic tracks (if user selected live mic)
  let liveMicStream = null;
  if(voiceMethod.value === 'mic'){
    try{
      liveMicStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      liveMicStream.getAudioTracks().forEach(t=> combined.addTrack(t));
      statusEl.textContent = 'Live mic added â€” recording will include what you speak now.';
    }catch(err){
      statusEl.textContent = 'Could not open mic for live recording: ' + err.message + '. If you uploaded a narration, it will be used instead.';
    }
  }

  // If user chose uploaded audio, queue it to play into WebAudio master (so it's captured)
  if(voiceMethod.value === 'upload' && uploadedAudioBuffer){
    const src = audioCtx.createBufferSource();
    src.buffer = uploadedAudioBuffer;
    src.connect(audioCtx.masterGain);
    src.start();
  }

  // Now add WebAudio masterDest tracks (background music + sfx + uploaded buffer if played)
  audioCtx.masterDest.stream.getAudioTracks().forEach(t=> combined.addTrack(t));

  // Prepare MediaRecorder
  recordedChunks = [];
  try{
    mediaRecorder = new MediaRecorder(combined, { mimeType: 'video/webm;codecs=vp8,opus' });
  }catch(err){
    statusEl.textContent = 'MediaRecorder creation failed: ' + err.message;
    return;
  }

  mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) recordedChunks.push(e.data); };
  mediaRecorder.onstart = () => { statusEl.textContent = 'Recording... (auto-stop after ' + dur + 's)'; };
  mediaRecorder.onstop = async ()=>{
    // stop any mic tracks we opened
    if(liveMicStream) liveMicStream.getTracks().forEach(t=> t.stop());
    // stop background music
    stopBackgroundMusic();
    // assemble blob
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);
    downloadLink.href = url;
    downloadLink.download = `elimu_short_${dur}s_${Date.now()}.webm`;
    downloadLink.textContent = 'â¬‡ï¸ Download WebM (auto)';
    downloadLink.classList.remove('hidden');
    // auto-click to download
    setTimeout(()=> {
      try{ downloadLink.click(); }catch(e){}
    }, 300);
    statusEl.textContent = 'Recording finished â€” file ready to download.';
    // stop any video tracks from getDisplayMedia if used (to release share)
    try{
      videoStream.getTracks().forEach(t=> t.stop());
    }catch(e){}
  };

  // start
  mediaRecorder.start(1000); // slice every second

  // show subtitles progressively based on dur (split into 3 parts)
  const parts = splitText(currentTopic.text || '', 3);
  parts.forEach((p,i)=>{
    setTimeout(()=> { subtitle.textContent = p; playBoing(); }, Math.floor((i+0.5)*(dur/parts.length)*1000));
  });

  // If user chose TTS preview (not embedded): speak now for preview
  if(voiceMethod.value === 'tts'){ speakPreview(currentTopic.title + '. ' + currentTopic.text, voiceGender.value); }

  // stop automatically after duration
  setTimeout(()=>{
    try{ if(mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop(); }catch(e){}
  }, dur*1000 + 400);
}

/* ---------- events ---------- */
genBtn.addEventListener('click', ()=> generatePreview());
recordBtn.addEventListener('click', async ()=>{
  // record action is a user gesture (allows audio and display prompts)
  await ensureAudioCtx();
  if(audioCtx.state === 'suspended') try{ await audioCtx.resume(); }catch(e){}
  // small delay then start
  setTimeout(()=> startRecordingAuto(), 250);
});

/* ---------- init ---------- */
window.addEventListener('load', ()=> {
  // warm voices
  speechSynthesis.getVoices();
  generatePreview();
  statusEl.textContent = 'Ready. Click Generate Preview then Record (first click unlocks audio).';
});
</script>
</body>
</html>
