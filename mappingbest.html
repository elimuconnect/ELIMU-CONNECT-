<!DOCTYPE html>
<html>
<head>
  <title>Elimu Connect ‚Äì Live Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      text-align: center;
      background: #f9f9f9;
      padding-top: 140px;
    }
    #map {
      height: 60vh;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    input, select, button {
      padding: 10px;
      width: 90%;
      margin: 5px auto;
      display: block;
      border-radius: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #45a049;
    }
    .inline {
      display: flex;
      justify-content: space-between;
      width: 90%;
      margin: auto;
    }
    .inline select { width: 48%; }
    .owner-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 5px;
    }
    .owner-buttons button {
      background-color: #e91e63;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .owner-buttons button.edit { background-color: #2196F3; }
    .notice {
      color: #b71c1c;
      font-weight: 600;
      padding: 10px;
      background: #ffe6e6;
      border: 1px solid #b71c1c;
      border-radius: 6px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      text-align: left;
      max-height: 120px;
      overflow-y: auto;
      display: none;
      box-sizing: border-box;
    }
    .leaflet-routing-container {
      max-height: 200px;
      overflow-y: auto;
      font-size: 13px;
    }
    #payDiv { margin: 10px 0; }
  </style>
</head>
<body>

<h3>üìç Elimu Connect ‚Äì Live Location Sharing</h3>

<div id="payDiv">
  <a href="https://paystack.shop/pay/2i-azr3wzx" target="_blank">
    <button>üí≥ Upgrade to Paid Tier</button>
  </a>
</div>

<input id="name" type="text" placeholder="Your Name" />
<input id="subject" type="text" placeholder="Subject" />
<input id="phone" type="text" placeholder="Phone Number" />
<select id="role">
  <option value="Student">Student</option>
  <option value="Teacher">Teacher</option>
</select>

<button id="shareBtn">üì§ Share / Update My Location</button>

<div class="inline">
  <select id="filter" onchange="loadMarkers()">
    <option value="All">All Roles</option>
    <option value="Student">Only Students</option>
    <option value="Teacher">Only Teachers</option>
  </select>

  <select id="userSelect" onchange="zoomToUser(this.value)">
    <option value="">-- Select Nearby User --</option>
  </select>
</div>

<input type="range" id="radius" min="20" max="30" value="30" oninput="updateRadiusLabel(); loadMarkers()" />
<div id="radiusValue">Showing within: 30 km</div>

<div id="map"></div>
<div id="safetyNotice" class="notice" style="display:none;"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDFOMjP0XgFCgs-iUg0HYD9DCGjsUOGofE",
  authDomain: "tutor-students-mapping.firebaseapp.com",
  databaseURL: "https://tutor-students-mapping-default-rtdb.firebaseio.com",
  projectId: "tutor-students-mapping",
  storageBucket: "tutor-students-mapping.appspot.com",
  messagingSenderId: "631567514082",
  appId: "1:631567514082:web:a0d782917914ffe403a1bb"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map, userLat, userLng, markers = [], routingControl = null;
const myPhone = localStorage.getItem("myPhone") || "";
const urlParams = new URLSearchParams(window.location.search);
const isPaidUser = urlParams.has("ref");

const radiusInput = document.getElementById("radius");
const radiusValueLabel = document.getElementById("radiusValue");
const payDiv = document.getElementById("payDiv");

// Set tier-specific behavior
if(isPaidUser){
  radiusInput.min = 1.1;
  radiusInput.max = 30;
  radiusInput.value = 30;
  payDiv.style.display = "none";
} else {
  radiusInput.min = 20;
  radiusInput.max = 30;
  radiusInput.value = 30;
  payDiv.style.display = "block";
}
radiusValueLabel.innerText = `Showing within: ${radiusInput.value} km`;

function updateRadiusLabel() {
  radiusValueLabel.innerText = `Showing within: ${radiusInput.value} km`;
}

function initMap() {
  if (!navigator.geolocation) {
    alert("‚ùå Geolocation not supported by your browser.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;

    if (!map) {
      map = L.map('map').setView([userLat, userLng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    } else {
      map.setView([userLat, userLng], 13);
    }

    if (window.selfMarker) map.removeLayer(window.selfMarker);
    window.selfMarker = L.marker([userLat, userLng]).addTo(map).bindPopup("üìç You are here");
    loadMarkers();
  }, err => {
    console.error(err);
    alert("‚ùå Location access denied. Allow location to use the map.");
  }, { enableHighAccuracy: true, maximumAge: 10000 });
}

function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function loadMarkers() {
  if(!map || !userLat || !userLng) return;
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  if(routingControl){ try{ routingControl.remove(); } catch(e){} routingControl=null; }

  const filter = document.getElementById("filter").value;
  const maxDistance = parseFloat(radiusInput.value);
  const minDistance = isPaidUser ? 1.1 : 20;
  const dropdown = document.getElementById("userSelect");
  dropdown.innerHTML = `<option value="">-- Select Nearby User --</option>`;
  const safetyArr = [];

  db.ref("locations").once("value", snapshot => {
    snapshot.forEach(child => {
      const d = child.val();
      if(!d || typeof d.lat==='undefined' || typeof d.lng==='undefined') return;
      if(filter!=="All" && d.role!==filter) return;
      const dist = getDistance(userLat, userLng, d.lat, d.lng);

      if(!isPaidUser && (dist<minDistance || dist>maxDistance)) return;
      if(isPaidUser && dist<=1){ safetyArr.push(d); return; }
      if(dist<minDistance || dist>maxDistance) return;

      const marker = L.marker([d.lat,d.lng]).addTo(map);
      let popupHtml = `<div style="text-align:left;font-size:14px;">
        <b>${escapeHtml(d.name)}</b><br/>
        üßë‚Äçüè´ ${escapeHtml(d.role)}<br/>
        üìò ${escapeHtml(d.subject||'')}<br/>
        üìè ${dist.toFixed(1)} km away<br/>
        üìû <a href="tel:${encodeURIComponent(d.phone)}">${escapeHtml(d.phone)}</a><br/>
        <a href="tel:${encodeURIComponent(d.phone)}" style="display:inline-block;padding:6px 8px;border-radius:6px;background:#1976d2;color:#fff;text-decoration:none;">üì≤ Call</a>`;

      if(String(d.phone).replace(/[^0-9]/g,'')===String(myPhone).replace(/[^0-9]/g,'')){
        popupHtml+=`<div class="owner-buttons" style="margin-top:8px;">
          <button class="edit" onclick="editMyLocation('${d.phone}')">‚úèÔ∏è Edit</button>
          <button onclick="deleteMyLocation('${d.phone}')">üóëÔ∏è Delete</button>
        </div>`;
      }
      popupHtml += `</div>`;
      marker.bindPopup(popupHtml);
      markers.push(marker);

      const opt = document.createElement("option");
      opt.value = `${d.lat},${d.lng}`;
      opt.textContent = `${d.name} (${d.role}) ‚Äì ${dist.toFixed(1)} km`;
      dropdown.appendChild(opt);
    });

    const noticeDiv = document.getElementById("safetyNotice");
    if(isPaidUser && safetyArr.length>0){
      noticeDiv.style.display="block";
      noticeDiv.innerHTML=`‚ö†Ô∏è <b>Safety Notice:</b> Users within <b>1 km</b> are hidden.`;
    } else noticeDiv.style.display="none";
  });
}

function zoomToUser(value){
  if(!value) return;
  const [lat,lng]=value.split(",");
  const latF=parseFloat(lat), lngF=parseFloat(lng);
  if(isNaN(latF)||isNaN(lngF)) return;
  const dist=getDistance(userLat,userLng,latF,lngF);
  if(isPaidUser && dist<=1){ alert("‚ö†Ô∏è Directions disabled for <=1 km"); return; }
  map.setView([latF,lngF],15);
  if(routingControl){ try{ routingControl.remove(); } catch(e){} routingControl=null; }
  if(!isPaidUser) return; // free tier: no routing
  routingControl = L.Routing.control({
    waypoints:[L.latLng(userLat,userLng),L.latLng(latF,lngF)],
    routeWhileDragging:false, show:true, collapsible:true, addWaypoints:false, draggableWaypoints:false
  }).addTo(map);
}

function shareLocation(){
  const name=document.getElementById("name").value.trim();
  const subject=document.getElementById("subject").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const role=document.getElementById("role").value;
  if(!name||!subject||!phone) return alert("Please fill all fields.");
  if(!userLat||!userLng) return alert("Location not available. Allow location and try again.");
  localStorage.setItem("myPhone",phone);
  const userId = phone.replace(/[^0-9]/g,"");
  db.ref("locations/"+userId).set({name,subject,phone,role,lat:userLat,lng:userLng})
    .then(()=>{ alert("‚úÖ Location shared!"); loadMarkers(); })
    .catch(err=>{ console.error(err); alert("Error sharing location."); });
}

function editMyLocation(phone){
  const key=phone.replace(/[^0-9]/g,'');
  db.ref("locations/"+key).once("value",snap=>{
    const data=snap.val();
    if(!data) return alert("No data found.");
    document.getElementById("name").value=data.name||"";
    document.getElementById("subject").value=data.subject||"";
    document.getElementById("phone").value=data.phone||"";
    document.getElementById("role").value=data.role||"Student";
    if(data.lat&&data.lng) map.setView([data.lat,data.lng],15);
  });
}

function deleteMyLocation(phone){
  if(!confirm("Delete your shared location?")) return;
  const key=phone.replace(/[^0-9]/g,'');
  db.ref("locations/"+key).remove().then(()=>{ alert("‚ùå Location deleted."); loadMarkers(); }).catch(err=>{ console.error(err); alert("Error deleting location."); });
}

function escapeHtml(str){ if(!str) return""; return String(str).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

document.getElementById("shareBtn").addEventListener("click", shareLocation);
document.getElementById("radius").addEventListener("change", loadMarkers);

initMap();
updateRadiusLabel();
</script>

</body>
</html>
