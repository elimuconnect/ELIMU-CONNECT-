<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fast Smart Tutor</title>
  <script src="https://unpkg.com/mathlive"></script>
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: #eef1f5;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #toolbar {
      padding: 15px;
      background: #1976d2;
      color: white;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #toolbar button {
      background: white;
      color: #1976d2;
      padding: 10px 16px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    #editor {
      flex: 1;
      padding: 30px;
      font-size: 1.6em;
      background: #fff;
      overflow-y: auto;
      outline: none;
      white-space: pre-wrap;
    }

    math-field {
      font-size: 1.4em;
      margin: 0 4px;
    }

    #status {
      padding: 10px;
      background: #388e3c;
      color: white;
      font-weight: bold;
      text-align: center;
    }

    .question { color: #333; margin-bottom: 20px; font-weight: bold; }
    .solution { color: #2e7d32; font-weight: normal; }
  </style>
</head>
<body>

<div id="app">
  <div id="toolbar">
    <button onclick="insertMath()">‚ûï Insert Math</button>
    <button onclick="speakAll()">üîä Read Now</button>
    <button onclick="pauseLesson()">‚è∏Ô∏è Pause</button>
    <button onclick="resumeLesson()">‚ñ∂Ô∏è Resume</button>
    <button onclick="repeatLesson()">üîÅ Repeat</button>
    <button onclick="skipLesson()">‚è≠Ô∏è Skip</button>
  </div>

  <div id="editor" contenteditable="true">
    <p>Smart Tutor is loading...</p>
  </div>

  <div id="status">‚è≥ Preparing lesson...</div>
</div>

<script>
  const lessons = [
    {
      question: "Q1: Solve for x: 2x + 6 = 14",
      solution: "Step 1: Subtract 6 ‚Üí 2x = 8\nStep 2: Divide by 2 ‚Üí x = 4"
    },
    {
      question: "Q2: Simplify (x + 3)(x - 1)",
      solution: "Step 1: Use expansion ‚Üí x¬≤ - x + 3x - 3\nStep 2: Combine terms ‚Üí x¬≤ + 2x - 3"
    }
  ];

  // Force voice preload immediately
  speechSynthesis.getVoices();

  const editor = document.getElementById("editor");
  const status = document.getElementById("status");

  let current = parseInt(localStorage.getItem("lessonIndex") || "0");
  let paused = false;
  let timer = null;
  let typingTimer = null;

  function insertMath() {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    const mathField = document.createElement("math-field");
    mathField.setAttribute("virtual-keyboard-mode", "onfocus");
    mathField.textContent = "x^2 + y^2 = r^2";
    range.deleteContents();
    range.insertNode(mathField);
    sel.collapseToEnd();
    mathField.focus();
  }

  function getVoice() {
    const voices = speechSynthesis.getVoices();
    const preferred = ["Google UK English Male", "en-GB", "en-IN", "en-KE"];
    return voices.find(v => preferred.includes(v.name) || preferred.includes(v.lang)) || voices[0];
  }

  function speak(text) {
    speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.voice = getVoice();
    utter.rate = 0.9;
    speechSynthesis.speak(utter);
  }

  function speakAll() {
    let combined = editor.innerText;
    const mathFields = editor.querySelectorAll("math-field");
    mathFields.forEach(field => {
      combined += " " + field.getValue("spoken-text");
    });
    speak(combined);
  }

  function typeSolution(text, callback) {
    const solutionDiv = document.createElement("div");
    solutionDiv.className = "solution";
    editor.appendChild(solutionDiv);

    let i = 0;
    typingTimer = setInterval(() => {
      if (paused) return;
      if (i >= text.length) {
        clearInterval(typingTimer);
        callback && callback();
        return;
      }
      solutionDiv.textContent += text[i];
      i++;
    }, 40); // faster pen-writing effect
  }

  function showLesson(index) {
    if (index >= lessons.length) {
      editor.innerHTML = "‚úÖ All lessons complete.";
      status.textContent = "‚úÖ Done.";
      localStorage.removeItem("lessonIndex");
      return;
    }

    const lesson = lessons[index];
    editor.innerHTML = `<div class="question">${lesson.question}</div>`;
    status.textContent = `üìñ Lesson ${index + 1}: Showing question`;
    speak(lesson.question);

    timer = setTimeout(() => {
      if (!paused) {
        status.textContent = `‚úçÔ∏è Writing solution...`;
        typeSolution(lesson.solution, () => {
          status.textContent = `‚úÖ Solution complete`;
          speak(lesson.solution);
          setTimeout(() => {
            current++;
            showLesson(current);
          }, 7000); // time to view solution before next lesson
        });
      }
    }, 10000); // reduced wait time before solution appears
  }

  function pauseLesson() {
    paused = true;
    clearTimeout(timer);
    clearInterval(typingTimer);
    speechSynthesis.cancel();
    status.textContent = "‚è∏Ô∏è Paused.";
  }

  function resumeLesson() {
    if (!paused) return;
    paused = false;
    status.textContent = "‚ñ∂Ô∏è Resuming...";
    showLesson(current);
  }

  function repeatLesson() {
    speechSynthesis.cancel();
    showLesson(current);
  }

  function skipLesson() {
    clearTimeout(timer);
    clearInterval(typingTimer);
    speechSynthesis.cancel();
    current++;
    showLesson(current);
  }

  // Start when voices are ready
  window.speechSynthesis.onvoiceschanged = () => {
    setTimeout(() => {
      showLesson(current);
    }, 1500); // short wait for smoother start
  };
</script>

</body>
</html>

