<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Math Tutor with Images & Controls</title>
  <script src="https://unpkg.com/mathlive"></script>
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f7fa;
      padding: 20px;
    }

    #toolbar button {
      padding: 8px 12px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 4px;
      margin: 5px 5px 10px 0;
      cursor: pointer;
    }

    #editor {
      min-height: 200px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    #lesson-image {
      max-width: 100%;
      margin-bottom: 10px;
      display: none;
    }

    math-field {
      font-size: 1.2em;
      margin: 0 4px;
    }

    #status {
      font-weight: bold;
      color: #2e7d32;
    }
  </style>
</head>
<body>

<h2>📚 Smart Math Tutor</h2>

<div id="toolbar">
  <button onclick="insertMath()">➕ Insert Math</button>
  <button onclick="speakAll()">🔊 Read Now</button>
  <button onclick="pauseLesson()">⏸️ Pause</button>
  <button onclick="resumeLesson()">▶️ Resume</button>
  <button onclick="repeatLesson()">🔁 Repeat</button>
  <button onclick="skipLesson()">⏭️ Skip</button>
</div>

<img id="lesson-image" src="" alt="Lesson image" />
<div id="editor" contenteditable="true"></div>
<div id="status">⏳ Loading lessons...</div>

<script>
  // LESSON DATA
  const lessons = [
    {
      content: "Lesson 1: Squares.\nThe square of 6 is 36.\nThe square root of 36 is 6.",
      delay: 5,
      image: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/25/Square_number_illustration.svg/512px-Square_number_illustration.svg.png"
    },
    {
      content: "Lesson 2: Logarithms.\nlog(100) = 2 because 10^2 = 100.",
      delay: 10,
      image: ""
    },
    {
      content: "Lesson 3: Solve for x.\nIf 3x + 2 = 11, then x = 3.",
      delay: 7,
      image: ""
    }
  ];

  const editor = document.getElementById("editor");
  const status = document.getElementById("status");
  const image = document.getElementById("lesson-image");

  let current = parseInt(localStorage.getItem("lessonIndex") || "0");
  let paused = false;
  let speaking = false;
  let pendingTimeout;

  function speakText(text) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.95;
    speaking = true;
    utterance.onend = () => speaking = false;
    speechSynthesis.speak(utterance);
  }

  function showLesson(index) {
    if (index >= lessons.length) {
      status.textContent = "✅ All lessons completed.";
      localStorage.removeItem("lessonIndex");
      return;
    }

    const lesson = lessons[index];
    editor.innerText = lesson.content;
    image.src = lesson.image;
    image.style.display = lesson.image ? "block" : "none";
    status.textContent = `📘 Lesson ${index + 1}`;

    speakText(lesson.content);
    localStorage.setItem("lessonIndex", index.toString());

    pendingTimeout = setTimeout(() => {
      if (!paused) {
        current++;
        showLesson(current);
      }
    }, lesson.delay * 1000);
  }

  function insertMath() {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    const mathField = document.createElement("math-field");
    mathField.setAttribute("virtual-keyboard-mode", "onfocus");
    mathField.textContent = "x^2 + y^2 = r^2";
    range.deleteContents();
    range.insertNode(mathField);
    sel.collapseToEnd();
    mathField.focus();
  }

  function speakAll() {
    const mathFields = editor.querySelectorAll("math-field");
    let textToSpeak = editor.innerText;
    mathFields.forEach(field => {
      textToSpeak += " " + field.getValue("spoken-text");
    });
    speakText(textToSpeak);
  }

  function pauseLesson() {
    paused = true;
    status.textContent = "⏸️ Paused.";
    clearTimeout(pendingTimeout);
    speechSynthesis.cancel();
  }

  function resumeLesson() {
    if (!paused) return;
    paused = false;
    status.textContent = "▶️ Resuming...";
    showLesson(current);
  }

  function repeatLesson() {
    speechSynthesis.cancel();
    showLesson(current);
  }

  function skipLesson() {
    speechSynthesis.cancel();
    clearTimeout(pendingTimeout);
    current++;
    showLesson(current);
  }

  // Start tutoring
  setTimeout(() => {
    showLesson(current);
  }, 3000);
</script>

</body>
</html>
