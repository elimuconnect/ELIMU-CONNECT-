<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart African Tutor</title>
  <script src="https://unpkg.com/mathlive"></script>
  <link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive.core.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: #eef1f5;
    }

    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    #toolbar {
      padding: 15px;
      background: #1976d2;
      color: white;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #toolbar button {
      background: white;
      color: #1976d2;
      padding: 10px 16px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }

    #lesson-image {
      max-width: 100%;
      margin: 0 auto;
      display: none;
    }

    #editor {
      flex: 1;
      padding: 30px;
      font-size: 1.8em;
      background: #fff;
      overflow-y: auto;
      outline: none;
    }

    math-field {
      font-size: 1.4em;
      margin: 0 4px;
    }

    #status {
      padding: 10px;
      background: #388e3c;
      color: white;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="app">
  <div id="toolbar">
    <button onclick="insertMath()">‚ûï Insert Math</button>
    <button onclick="speakAll()">üîä Read Now</button>
    <button onclick="pauseLesson()">‚è∏Ô∏è Pause</button>
    <button onclick="resumeLesson()">‚ñ∂Ô∏è Resume</button>
    <button onclick="repeatLesson()">üîÅ Repeat</button>
    <button onclick="skipLesson()">‚è≠Ô∏è Skip</button>
  </div>

  <img id="lesson-image" src="" alt="Lesson Image" />

  <div id="editor" contenteditable="true">
    <p>Welcome. Lessons will appear here and be read aloud.</p>
  </div>

  <div id="status">‚è≥ Loading lesson...</div>
</div>

<script>
  const lessons = [
    {
      content: "Lesson 1: Introduction to Numbers. Numbers can be whole or decimal. For example, 5 is a whole number. 5.2 is a decimal number.",
      delay: 5,
      image: ""
    },
    {
      content: "Lesson 2: Solving simple equations. If 2x = 8, then divide both sides by 2. x equals 4.",
      delay: 8,
      image: ""
    },
    {
      content: "Lesson 3: Understanding Fractions. One half is written as one over two. One quarter is one over four.",
      delay: 7,
      image: ""
    }
  ];

  const editor = document.getElementById("editor");
  const image = document.getElementById("lesson-image");
  const status = document.getElementById("status");

  let current = parseInt(localStorage.getItem("lessonIndex") || "0");
  let paused = false;
  let speaking = false;
  let pendingTimeout = null;

  function insertMath() {
    const sel = window.getSelection();
    if (!sel.rangeCount) return;
    const range = sel.getRangeAt(0);
    const mathField = document.createElement("math-field");
    mathField.setAttribute("virtual-keyboard-mode", "onfocus");
    mathField.textContent = "x^2 + y^2 = r^2";
    range.deleteContents();
    range.insertNode(mathField);
    sel.collapseToEnd();
    mathField.focus();
  }

  function getAfricanVoice() {
    const voices = speechSynthesis.getVoices();
    const priorityNames = [
      "Google UK English Male", // Closest to African-sounding English
      "en-IN", "en-GB", "en-KE", "English (United Kingdom)"
    ];
    return voices.find(v => priorityNames.includes(v.name) || priorityNames.includes(v.lang)) || voices[0];
  }

  function speakText(text) {
    speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-GB';
    utterance.voice = getAfricanVoice();
    utterance.rate = 0.9;
    speaking = true;
    utterance.onend = () => speaking = false;
    speechSynthesis.speak(utterance);
  }

  function speakAll() {
    const mathFields = editor.querySelectorAll("math-field");
    let combined = editor.innerText;
    mathFields.forEach(field => {
      combined += " " + field.getValue("spoken-text");
    });
    speakText(combined);
  }

  function showLesson(index) {
    if (index >= lessons.length) {
      status.textContent = "‚úÖ All lessons completed.";
      localStorage.removeItem("lessonIndex");
      return;
    }

    const lesson = lessons[index];
    editor.innerText = lesson.content;
    image.src = lesson.image;
    image.style.display = lesson.image ? "block" : "none";
    status.textContent = `üìñ Lesson ${index + 1}`;

    speakText(lesson.content);
    localStorage.setItem("lessonIndex", index.toString());

    pendingTimeout = setTimeout(() => {
      if (!paused) {
        current++;
        showLesson(current);
      }
    }, lesson.delay * 1000);
  }

  function pauseLesson() {
    paused = true;
    clearTimeout(pendingTimeout);
    speechSynthesis.cancel();
    status.textContent = "‚è∏Ô∏è Paused.";
  }

  function resumeLesson() {
    if (!paused) return;
    paused = false;
    status.textContent = "‚ñ∂Ô∏è Resuming...";
    showLesson(current);
  }

  function repeatLesson() {
    speechSynthesis.cancel();
    showLesson(current);
  }

  function skipLesson() {
    clearTimeout(pendingTimeout);
    speechSynthesis.cancel();
    current++;
    showLesson(current);
  }

  // Load voices first, then start lesson
  window.speechSynthesis.onvoiceschanged = () => {
    setTimeout(() => {
      showLesson(current);
    }, 3000);
  };
</script>

</body>
</html>

