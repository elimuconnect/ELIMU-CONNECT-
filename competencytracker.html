<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CBC Competency Tracker</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f8ff; }
    .card { background: #fff; padding: 15px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 3px 8px rgba(0,0,0,0.1);}
    h2 { color: #2c3e50; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc;}
    button { padding: 10px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;}
    button:hover { background: #2980b9;}
    table { width: 100%; border-collapse: collapse; margin-top: 20px;}
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center;}
    th { background: #3498db; color: white; }
    .guide { background: #ecf7ff; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 14px; }
    .small { font-size: 12px; color: #666; margin-top:6px;}
  </style>
</head>
<body>
 <h2>📊 CBC Competency Tracker</h2>

<!-- Teacher Section -->
<div class="card">
  <h3>Teacher Phase</h3>
  <label>School Name:</label>
  <input id="schoolName" placeholder="Enter school name">

  <label>Grade:</label>
  <input id="gradeName" placeholder="Enter grade (e.g., Grade 6)">

  <label>Student Name:</label>
  <input id="studentName" placeholder="Enter student name">

  <button onclick="registerStudent()">Register Student</button>
  <button onclick="clearSchoolGrade()">Change School/Grade</button>
  <div class="small">School and grade are saved locally for this browser until you press "Change School/Grade".</div>

  <hr>

  <!-- Student Selection -->
  <h3>Select Student</h3>
  <select id="studentSelect" onchange="teacherViewScores()">
    <option value="">-- Choose Student --</option>
  </select>
  <div class="small">Dropdown updates immediately when students are added.</div>

  <label>Competency:</label>
  <select id="competencySelect" onchange="showGuide()">
    <option>Communication and Collaboration</option>
    <option>Critical Thinking and Problem Solving</option>
    <option>Imagination and Creativity</option>
    <option>Citizenship</option>
    <option>Digital Literacy</option>
    <option>Learning to Learn</option>
    <option>Self-Efficacy</option>
  </select>

  <!-- Guide info -->
  <div id="competencyGuide" class="guide"></div>

  <label>Score (0-100):</label>
  <input type="number" id="score" min="0" max="100">

  <button onclick="addRecord()">Save Progress</button>
</div>

<!-- Student List with delete -->
<div id="studentList"></div> <!-- List of students with delete buttons -->

<!-- Teacher Score View -->
<div id="teacherScoresView" class="card">
  <h3>📖 Student Scores (Teacher View)</h3>
  <h4 id="teacherStudentName"></h4> <!-- Student name will show here -->

  <table id="teacherProgressTable">
    <thead>
      <tr><th>Competency</th><th>Score (%)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <canvas id="teacherChart" width="400" height="200"></canvas>

  <!-- Teacher Guide -->
  <div id="teacherGuide" class="guide"></div>
</div>



<!-- Parent Section -->
<div class="card">
  <h3>Parent Phase</h3>
  <label>Select Student:</label>
  <select id="parentStudent">
    <option value="">-- Choose Student --</option>
  </select>
  <button onclick="viewProgress()">View Progress</button>

  <table id="progressTable">
    <thead>
      <tr><th>Competency</th><th>Score (%)</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <canvas id="parentChart" width="400" height="200"></canvas>

  <!-- Parent Guide -->
  <div id="parentGuide" class="guide"></div>
</div>


  <script>
  // ---------- Firebase Setup ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCAiOSHmURDyAAYm5EmoomLkZ_Aud7iXIQ",
    authDomain: "cbc-general.firebaseapp.com",
    databaseURL: "https://cbc-general-default-rtdb.firebaseio.com",
    projectId: "cbc-general",
    storageBucket: "cbc-general.firebasestorage.app",
    messagingSenderId: "764732839741",
    appId: "1:764732839741:web:ab829af54839de91359754"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- Helpers ----------
  function sanitizeKey(s) {
    if (!s) return "";
    return s.toString().trim().replace(/[.#$\[\]\/]/g, "_");
  }
  function schoolPath() {
    const schoolRaw = document.getElementById("schoolName").value || localStorage.getItem("schoolName");
    const gradeRaw  = document.getElementById("gradeName").value  || localStorage.getItem("gradeName");
    const sk = sanitizeKey(schoolRaw);
    const gk = sanitizeKey(gradeRaw);
    return { schoolRaw, gradeRaw, schoolKey: sk, gradeKey: gk };
  }

  // ---------- Competency Guides ----------
  const competencyInfo = {
    "Communication and Collaboration": `
      - Expressing ideas clearly (oral, written, non-verbal)<br>
      - Active listening and teamwork<br>
      - Building respectful relationships and working with others
    `,
    "Critical Thinking and Problem Solving": `
      - Analyzing situations logically<br>
      - Making informed decisions<br>
      - Applying creativity to real-life problems
    `,
    "Imagination and Creativity": `
      - Generating original ideas<br>
      - Innovating in arts, science, and daily life<br>
      - Expressing creativity through projects and performance
    `,
    "Citizenship": `
      - Understanding rights and responsibilities<br>
      - Practicing leadership, integrity, and patriotism<br>
      - Community service and environmental conservation
    `,
    "Digital Literacy": `
      - Using technology for research and problem-solving<br>
      - Applying digital tools responsibly<br>
      - Understanding online safety and ethics
    `,
    "Learning to Learn": `
      - Managing personal learning<br>
      - Setting goals, reflecting, and self-assessing<br>
      - Building resilience and adaptability
    `,
    "Self-Efficacy": `
      - Believing in one’s ability to succeed<br>
      - Taking initiative and responsibility<br>
      - Confidence and a positive attitude toward challenges
    `
  };

  function showGuide() {
    const competency = document.getElementById("competencySelect").value;
    document.getElementById("competencyGuide").innerHTML = competencyInfo[competency] || "";
  }

  // ---------- Live refs ----------
  let teacherStudentsRef = null;
  let parentStudentsRef = null;
  let parentCompetenciesRef = null;
  let teacherCompetenciesRef = null;
  let teacherChart = null;

  // ---------- Page load ----------
  window.onload = () => {
    const savedSchool = localStorage.getItem("schoolName");
    const savedGrade = localStorage.getItem("gradeName");
    if (savedSchool) document.getElementById("schoolName").value = savedSchool;
    if (savedGrade)  document.getElementById("gradeName").value = savedGrade;

    const { schoolKey, gradeKey } = schoolPath();
    if (schoolKey && gradeKey) startStudentListeners();
    showGuide();
  };

  // ---------- Register student ----------
  function registerStudent() {
    const schoolRaw = document.getElementById("schoolName").value.trim();
    const gradeRaw = document.getElementById("gradeName").value.trim();
    const studentName = document.getElementById("studentName").value.trim();

    if (!schoolRaw || !gradeRaw || !studentName) {
      alert("Please fill school, grade and student name.");
      return;
    }

    localStorage.setItem("schoolName", schoolRaw);
    localStorage.setItem("gradeName", gradeRaw);

    const { schoolKey, gradeKey } = schoolPath();
    const path = `schools/${schoolKey}/${gradeKey}/students`;

    const newRef = db.ref(path).push();
    newRef.set({ name: studentName, competencies: {} })
      .then(() => {
        document.getElementById("studentName").value = "";
        startStudentListeners();
      })
      .catch(err => { console.error("Error adding student:", err); });
  }

  // ---------- Delete student ----------
  function deleteStudent(studentKey) {
    const { schoolKey, gradeKey } = schoolPath();
    if (!schoolKey || !gradeKey) return;
    if (!confirm("Are you sure you want to delete this student?")) return;

    db.ref(`schools/${schoolKey}/${gradeKey}/students/${studentKey}`).remove()
      .then(() => {
        alert("Student deleted.");
        startStudentListeners();
      })
      .catch(err => console.error("Delete error:", err));
  }

  // ---------- Student Listeners ----------
  function startStudentListeners() {
    loadStudentsRealtime();
    loadParentStudentsRealtime();
  }

  function loadStudentsRealtime() {
    const { schoolKey, gradeKey } = schoolPath();
    const studentSelect = document.getElementById("studentSelect");
    const studentListDiv = document.getElementById("studentList");

    if (teacherStudentsRef) teacherStudentsRef.off();
    if (!schoolKey || !gradeKey) return;

    teacherStudentsRef = db.ref(`schools/${schoolKey}/${gradeKey}/students`);
    teacherStudentsRef.on("value", snapshot => {
      studentSelect.innerHTML = "<option value=''>-- Select Student --</option>";
      studentListDiv.innerHTML = "<h3>Registered Students</h3>";
      const ul = document.createElement("ul");

      snapshot.forEach(child => {
        const data = child.val() || {};
        const name = data.name || child.key;

        // dropdown
        const opt = document.createElement("option");
        opt.value = child.key;
        opt.textContent = name;
        studentSelect.appendChild(opt);

        // list with delete
        const li = document.createElement("li");
        li.textContent = name + " ";
        const btn = document.createElement("button");
        btn.textContent = "❌ Delete";
        btn.onclick = () => deleteStudent(child.key);
        li.appendChild(btn);
        ul.appendChild(li);
      });
      studentListDiv.appendChild(ul);
    });
  }

  function loadParentStudentsRealtime() {
    const { schoolKey, gradeKey } = schoolPath();
    const parentSelect = document.getElementById("parentStudent");

    if (parentStudentsRef) parentStudentsRef.off();
    if (!schoolKey || !gradeKey) return;

    parentStudentsRef = db.ref(`schools/${schoolKey}/${gradeKey}/students`);
    parentStudentsRef.on("value", snapshot => {
      parentSelect.innerHTML = "<option value=''>-- Select Student --</option>";
      snapshot.forEach(child => {
        const data = child.val() || {};
        const name = data.name || child.key;
        const opt = document.createElement("option");
        opt.value = child.key;
        opt.textContent = name;
        parentSelect.appendChild(opt);
      });
    });
  }

  // ---------- Clear stored school/grade ----------
  function clearSchoolGrade() {
    localStorage.removeItem("schoolName");
    localStorage.removeItem("gradeName");
    document.getElementById("schoolName").value = "";
    document.getElementById("gradeName").value = "";
    if (teacherStudentsRef) { teacherStudentsRef.off(); teacherStudentsRef = null; }
    if (parentStudentsRef) { parentStudentsRef.off(); parentStudentsRef = null; }
    alert("School and grade reset.");
  }

  // ---------- Add competency ----------
  function addRecord() {
    const { schoolKey, gradeKey } = schoolPath();
    const studentKey = document.getElementById("studentSelect").value;
    const competency = document.getElementById("competencySelect").value;
    const score = document.getElementById("score").value;

    if (!studentKey) return alert("Select a student.");
    if (score === "" || isNaN(score)) return alert("Enter a numeric score.");

    db.ref(`schools/${schoolKey}/${gradeKey}/students/${studentKey}/competencies/${competency}`)
      .set(Number(score))
      .then(() => alert("Progress saved!"));
  }

 function teacherViewScores() {
  const { schoolKey, gradeKey } = schoolPath();
  const studentKey = document.getElementById("studentSelect").value;

  const nameHeading = document.getElementById("teacherStudentName");
  const tbody = document.querySelector("#teacherProgressTable tbody");
  const guideDiv = document.getElementById("teacherGuide");
  tbody.innerHTML = "";
  guideDiv.innerHTML = "";
  nameHeading.textContent = "";

  if (!studentKey) {
    if (teacherChart) { teacherChart.destroy(); teacherChart = null; }
    return;
  }

  // 🔹 fetch and display student name
  db.ref(`schools/${schoolKey}/${gradeKey}/students/${studentKey}/name`).once("value", snap => {
    nameHeading.textContent = snap.exists() ? snap.val() : "(Unnamed Student)";
  });

  // 🔹 competencies listener
  if (teacherCompetenciesRef) teacherCompetenciesRef.off();
  teacherCompetenciesRef = db.ref(`schools/${schoolKey}/${gradeKey}/students/${studentKey}/competencies`);

  teacherCompetenciesRef.on("value", snapshot => {
    tbody.innerHTML = "";
    guideDiv.innerHTML = "";
    const labels = [], scores = [];

    if (!snapshot.exists()) {
      if (teacherChart) { teacherChart.destroy(); teacherChart = null; }
      return;
    }

    snapshot.forEach(child => {
      const competency = child.key, value = child.val();
      const row = tbody.insertRow();
      const cellName = row.insertCell(0);
      const cellScore = row.insertCell(1);

      const a = document.createElement("a");
      a.href = "#";
      a.textContent = competency;
      a.onclick = (e) => {
        e.preventDefault();
        guideDiv.innerHTML = competencyInfo[competency] || "No guide.";
      };
      cellName.appendChild(a);
      cellScore.textContent = value + "%";

      labels.push(competency);
      scores.push(value || 0);
    });

    if (teacherChart) teacherChart.destroy();
    const ctx = document.getElementById("teacherChart").getContext("2d");
    teacherChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Competency Scores",
          data: scores,
          backgroundColor: "rgba(46, 204, 113, 0.6)",
          borderColor: "#27ae60",
          borderWidth: 1
        }]
      },
      options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });
  });
}


  // ---------- Parent View ----------
  let parentChart = null;
  function viewProgress() {
    const { schoolKey, gradeKey } = schoolPath();
    const studentKey = document.getElementById("parentStudent").value;
    if (!studentKey) return alert("Select a student.");

    if (parentCompetenciesRef) parentCompetenciesRef.off();
    parentCompetenciesRef = db.ref(`schools/${schoolKey}/${gradeKey}/students/${studentKey}/competencies`);

    const tbody = document.querySelector("#progressTable tbody");
    tbody.innerHTML = "";
    document.getElementById("parentGuide").innerHTML = "";

    parentCompetenciesRef.on("value", snapshot => {
      tbody.innerHTML = "";
      const labels = [], scores = [];

      if (!snapshot.exists()) {
        if (parentChart) { parentChart.destroy(); parentChart = null; }
        return;
      }

      snapshot.forEach(child => {
        const competency = child.key, value = child.val();
        const row = tbody.insertRow();
        const cellName = row.insertCell(0);
        const cellScore = row.insertCell(1);

        const a = document.createElement("a");
        a.href = "#";
        a.textContent = competency;
        a.onclick = (e) => {
          e.preventDefault();
          document.getElementById("parentGuide").innerHTML = competencyInfo[competency] || "No guide.";
        };
        cellName.appendChild(a);
        cellScore.textContent = value + "%";

        labels.push(competency);
        scores.push(value || 0);
      });

      if (parentChart) parentChart.destroy();
      const ctx = document.getElementById("parentChart").getContext("2d");
      parentChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "Competency Scores",
            data: scores,
            backgroundColor: "rgba(52, 152, 219, 0.6)",
            borderColor: "#2980b9",
            borderWidth: 1
          }]
        },
        options: { scales: { y: { beginAtZero: true, max: 100 } } }
      });
    });
  }
</script>

</body>
</html>
