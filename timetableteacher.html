<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Timetable Voice Assistant</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    body { font-family: Arial; padding: 2em; text-align: center; }
    input, button { padding: 10px; margin: 8px; font-size: 16px; }
    #status { margin-top: 1em; font-weight: bold; color: green; }
    #preview { margin-top: 2em; max-width: 600px; margin-left: auto; margin-right: auto; text-align: left; border: 1px solid #ccc; padding: 1em; white-space: pre-line; background: #f9f9f9; }
  </style>
</head>
<body>
  <h2>📚 Teacher Timetable Voice Assistant</h2>
  <input type="file" id="fileInput" accept=".pdf,.docx"><br>
  <input type="text" id="teacherName" placeholder="Enter your full name (e.g. Solomon Ndegwa)"><br>
  <button onclick="startAssistant()">Start Assistant</button>
  <button onclick="downloadTimetable()">Download My Timetable</button>
  <div id="status"></div>
  <div id="preview"></div>

  <script>
    let fullText = "";
    let personalLessons = [];
    let teacherCleanName = "";

    function say(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "en-KE";
      speechSynthesis.speak(msg);
    }

    function normalizeName(name) {
      return name.replace(/(Tr\.?|Mr\.?|Ms\.?|Mrs\.?|Teacher)/gi, "").trim().toLowerCase();
    }

    function startAssistant() {
      const file = document.getElementById("fileInput").files[0];
      const teacherInput = document.getElementById("teacherName").value.trim();
      teacherCleanName = teacherInput;

      if (!file || !teacherInput) {
        alert("Please upload a .pdf or .docx file and enter your name.");
        return;
      }

      const fileName = file.name.toLowerCase();
      if (fileName.endsWith(".pdf")) {
        parsePDF(file, teacherInput);
      } else if (fileName.endsWith(".docx")) {
        parseDOCX(file, teacherInput);
      } else {
        alert("Unsupported file type. Upload a .pdf or .docx file.");
      }
    }

    function parsePDF(file, teacherInput) {
      const reader = new FileReader();
      reader.onload = async function () {
        const typedarray = new Uint8Array(reader.result);
        const pdf = await pdfjsLib.getDocument({ data: typedarray }).promise;

        fullText = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          fullText += content.items.map(item => item.str).join(" ") + "\n";
        }

        finishParsing(teacherInput);
      };
      reader.readAsArrayBuffer(file);
    }

    function parseDOCX(file, teacherInput) {
      const reader = new FileReader();
      reader.onload = function (event) {
        mammoth.extractRawText({ arrayBuffer: event.target.result }).then(function (result) {
          fullText = result.value;
          finishParsing(teacherInput);
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function finishParsing(teacherInput) {
      const name = normalizeName(teacherInput);
      const lines = fullText.split("\n");
      let sectionFound = false;
      let collecting = false;
      personalLessons = [];
      let previewText = "";
      const previewDiv = document.getElementById("preview");
      previewDiv.innerHTML = "";

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        const normalizedLine = normalizeName(line);

        // Match if name is anywhere in the line
        if (!collecting && normalizedLine.includes(name)) {
          sectionFound = true;
          collecting = true;
          previewText += "🧑 Timetable for: " + teacherCleanName + "\n\n";
          continue;
        }

        if (collecting && (line.match(/^(Tr\.|Teacher|Mr\.|Ms\.)/i) || line === "")) {
          break; // End of this teacher's block
        }

        if (collecting) {
          previewText += line + "\n";

          const match = line.match(/([0-9]{1,2}:[0-9]{2}).*?(Form\s*\w+|[1-4][A-Z]?)?.*?\b([A-Z]{3,}|Math|Eng|Kisw|Bio|Chem|Hist|KISW|ENGL|MAT|PHY|BIO|CRE|AGR|BST)\b/i);
          if (match) {
            personalLessons.push({
              time: match[1],
              form: match[2] || "Class",
              subject: match[3]
            });
          }
        }
      }

      if (sectionFound && personalLessons.length > 0) {
        previewDiv.innerText = previewText;
        document.getElementById("status").textContent = "✅ Monitoring your lessons with voice alerts...";
        monitorTime();
      } else {
        document.getElementById("status").textContent = "❌ No timetable found for " + teacherCleanName;
      }
    }

    function monitorTime() {
      setInterval(() => {
        const now = new Date();
        const currentHH = now.getHours();
        const currentMM = now.getMinutes();

        for (let lesson of personalLessons) {
          const [hh, mm] = lesson.time.split(":").map(n => parseInt(n));
          let alertHH = hh;
          let alertMM = mm - 2;

          if (alertMM < 0) {
            alertHH -= 1;
            alertMM = 60 + alertMM;
          }

          if (
            alertHH === currentHH &&
            alertMM === currentMM
          ) {
            say(`${teacherCleanName}, in 2 minutes go to ${lesson.form}, ${lesson.subject}`);
          }
        }
      }, 60000); // every minute
    }

    function downloadTimetable() {
      if (personalLessons.length === 0) {
        alert("No timetable found to download.");
        return;
      }

      let text = `Timetable for: ${teacherCleanName}\n\n`;
      personalLessons.forEach(lesson => {
        text += `${lesson.time} - ${lesson.form} - ${lesson.subject}\n`;
      });

      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${teacherCleanName.replace(/\s+/g, "_")}_timetable.txt`;
      a.click();
    }
  </script>
</body>
</html>

      
