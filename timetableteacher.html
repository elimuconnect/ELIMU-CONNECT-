<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Timetable Voice Alert</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #eef6ff;
      text-align: center;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
    }
    #editor {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
      overflow-x: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    td, th {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
      vertical-align: top;
    }
    #status {
      font-weight: bold;
      color: green;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>ðŸ“˜ Smart Timetable Voice Alert</h2>

  <input type="text" id="teacherName" placeholder="Enter your full name (e.g. Solomon Ndegwa)">
  <br>
  <input type="file" id="lessonFile" accept=".docx">
  <br>
  <button onclick="loadTimetable()">ðŸ“¥ Load Timetable</button>

  <div id="status"></div>
  <div id="editor"></div>

  <script>
   function normalize(text) {
      return (text || "")
        .replace(/(Tr\.?|Mr\.?|Ms\.?|Mrs\.?|Teacher)/gi, "")
        .trim()
        .toLowerCase();
    }

    let extractedRows = [];
    let teacherFullName = "";

    function loadTimetable() {
      const fileInput = document.getElementById("lessonFile");
      const file = fileInput.files[0];
      const inputName = document.getElementById("teacherName").value.trim();
      teacherFullName = inputName;

      if (!file || !file.name.endsWith(".docx")) {
        alert("Please upload a .docx file.");
        return;
      }
      if (!inputName) {
        alert("Enter your full name.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result }).then(result => {
          const rawHTML = result.value;
          const parser = new DOMParser();
          const doc = parser.parseFromString(rawHTML, "text/html");
          const elements = Array.from(doc.body.children);
          const normalizedInput = normalize(inputName);
          let found = false;

          for (let i = 0; i < elements.length; i++) {
            const el = elements[i];
            const elText = normalize(el.textContent || "");
            console.log("Checking:", el.textContent);

            if (elText.includes(normalizedInput)) {
              for (let j = i + 1; j < elements.length; j++) {
                if (elements[j].tagName === "TABLE") {
                  document.getElementById("editor").innerHTML = elements[j].outerHTML;
                  document.getElementById("status").textContent = "âœ… Timetable found and loaded for " + teacherFullName;

                  const rows = elements[j].querySelectorAll("tr");
                  extractedRows = Array.from(rows).map(row =>
                    Array.from(row.querySelectorAll("td,th")).map(cell => cell.textContent.trim())
                  );

                  found = true;
                  return;
                }
              }
            }
          }

          if (!found) {
            document.getElementById("status").textContent = "âŒ No timetable found. Showing full document.";
            document.getElementById("editor").innerHTML = rawHTML;
          }
        }).catch(err => {
          console.error("âŒ Mammoth error:", err);
          alert("Error reading file: " + err.message);
        });
      };

      reader.readAsArrayBuffer(file);
    }
	
	
    const dayMap = {
      mo: "monday", mon: "monday",
      tu: "tuesday", tue: "tuesday",
      we: "wednesday", wed: "wednesday",
      th: "thursday", thu: "thursday", thur: "thursday",
      fr: "friday", fri: "friday"
    };
  
    function downloadTimetable() {
      if (extractedRows.length === 0) return;
      const lines = extractedRows.map(r => r.join(" | "));
      const blob = new Blob([lines.join("\n")], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${teacherFullName.replace(/\s+/g, "_")}_timetable.txt`;
      a.click();
    }

    function startMonitoring() {
      setInterval(() => {
        const now = new Date();
        const today = now.toLocaleDateString("en-KE", { weekday: 'long' }).toLowerCase();
        const currentHH = now.getHours();
        const currentMM = now.getMinutes();

        // Start from row 2 assuming first two rows are time headers
        for (let r = 2; r < extractedRows.length; r++) {
          const row = extractedRows[r];
          const dayName = normalizeDay(row[0]);
          if (dayName !== today) continue;

          for (let c = 1; c < row.length; c++) {
            const time = extractedRows[0][c] || extractedRows[1][c] || "";
            const cellContent = row[c];
            if (!cellContent || /BREAK|PREPS|GAMES|CLUB/i.test(cellContent)) continue;

            const match = time.match(/(\d{1,2})[:.](\d{2})/);
            if (!match) continue;

            let [hh, mm] = [parseInt(match[1]), parseInt(match[2])];
            let alertHH = hh;
            let alertMM = mm - 2;
            if (alertMM < 0) {
              alertHH -= 1;
              alertMM += 60;
            }

            if (currentHH === alertHH && currentMM === alertMM) {
              const sayText = `Teacher ${teacherFullName}, in 2 minutes go to ${cellContent.replace(/\n/g, ", ")}`;
              speakText(sayText);
            }
          }
        }
      }, 60000);
    }

    function speakText(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = "en-KE";
      speechSynthesis.speak(msg);
    }
  </script>
</body>
</html>
