<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Timetable Voice Alert</title>

  <!-- Mammoth for .docx -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #eef6ff; text-align: center; }
    input, button { padding: 10px; font-size: 16px; margin: 5px; }
    #editor { margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ccc;
              max-width: 900px; margin-left: auto; margin-right: auto; text-align: left; overflow-x: auto; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #999; padding: 8px; text-align: center; vertical-align: top; }
    #status { font-weight: bold; color: green; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>📘 Smart Timetable Voice Alert</h2>

  <input type="text" id="teacherName" placeholder="Enter your full name (e.g. Solomon Ndegwa)">
  <br>
  <input type="file" id="lessonFile" accept=".docx">
  <br>
  <button onclick="loadTimetable()">📥 Load Timetable</button>
  <button onclick="speakText('Test alert. Your timetable is working.')">🔊 Test Alert</button>

  <div id="status"></div>
  <div id="editor"></div>

  <script>
    function normalize(text) {
      return (text || "").replace(/(Tr\.?|Mr\.?|Ms\.?|Mrs\.?|Teacher)/gi, "").trim().toLowerCase();
    }

    let extractedRows = [];
    let teacherFullName = "";

    function loadTimetable() {
      const fileInput = document.getElementById("lessonFile");
      const file = fileInput.files[0];
      teacherFullName = document.getElementById("teacherName").value.trim();

      if (!file || !file.name.endsWith(".docx")) {
        alert("Please upload a .docx file only.");
        return;
      }
      if (!teacherFullName) {
        alert("Enter your full name.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result }).then(result => {
          const rawHTML = result.value;
          const parser = new DOMParser();
          const doc = parser.parseFromString(rawHTML, "text/html");
          const elements = Array.from(doc.body.children);
          const normalizedInput = normalize(teacherFullName);
          let found = false;

          for (let i = 0; i < elements.length; i++) {
            const el = elements[i];
            const elText = normalize(el.textContent || "");
            if (elText.includes(normalizedInput)) {
              for (let j = i + 1; j < elements.length; j++) {
                if (elements[j].tagName === "TABLE") {
                  loadTable(elements[j].outerHTML);
                  found = true;
                  return;
                }
              }
            }
          }

          if (!found) {
            document.getElementById("status").textContent = "❌ No timetable found. Showing full document.";
            document.getElementById("editor").innerHTML = rawHTML;
          }
        }).catch(err => {
          console.error("❌ Mammoth error:", err);
          alert("Error reading file: " + err.message);
        });
      };
      reader.readAsArrayBuffer(file);
    }

    function loadTable(html) {
      document.getElementById("editor").innerHTML = html;
      document.getElementById("status").textContent = "✅ Timetable loaded for " + teacherFullName;

      const table = document.querySelector("#editor table");
      const rows = table.querySelectorAll("tr");

      extractedRows = Array.from(rows).map(row =>
        Array.from(row.querySelectorAll("td,th")).map(cell => cell.textContent.trim())
      );

      // Expand double lessons → split into two
      extractedRows = extractedRows.map(row => row.flatMap(cell => {
        if (/DOUBLE|80\s*MIN/i.test(cell)) {
          return [
            cell.replace(/DOUBLE|80\s*MIN/i, "").trim(), // first part
            cell.trim() // repeat subject for 2nd period
          ];
        }
        return [cell];
      }));

      startMonitoring();
    }

    const periodToTimeMap = {
      "1": "07:10", "REG": "07:50", "2": "08:00", "3": "08:40",
      "SB": "09:20", "4": "09:35", "5": "10:15", "TB": "10:55",
      "6": "11:18", "7": "12:16"
    };

    function normalizeDay(text) {
      if (!text) return "";
      const short = text.trim().slice(0, 2).toLowerCase();
      const dayMap = { mo: "monday", tu: "tuesday", we: "wednesday", th: "thursday", fr: "friday" };
      return dayMap[short] || "";
    }

    function startMonitoring() {
      setInterval(() => {
        const now = new Date();
        const today = now.toLocaleDateString("en-KE", { weekday: 'long' }).toLowerCase();
        const HH = now.getHours(), MM = now.getMinutes();

        for (let r = 2; r < extractedRows.length; r++) {
          const row = extractedRows[r];
          const rowDay = normalizeDay(row[0]);
          if (!rowDay || rowDay !== today) continue;

          for (let c = 1; c < row.length; c++) {
            let timeLabel = extractedRows[0][c]?.trim() || extractedRows[1][c]?.trim() || "";
            const lesson = row[c];
            if (!lesson || /BREAK|PREPS|GAMES|CLUB/i.test(lesson)) continue;

            if (!periodToTimeMap[timeLabel]) continue;
            const [hh, mm] = periodToTimeMap[timeLabel].split(":").map(Number);

            let alertHH = hh, alertMM = mm - 2;
            if (alertMM < 0) { alertHH -= 1; alertMM += 60; }

            if (HH === alertHH && MM === alertMM) {
              const sayText = `Teacher ${teacherFullName}, in 2 minutes go to ${lesson}`;
              alert("🔔 " + sayText);
              speakText(sayText);
            }
          }
        }
      }, 60000);
    }

    function speakText(text) {
      if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "en-US";
        msg.rate = 0.95;
        speechSynthesis.speak(msg);
      }
    }
  </script>
</body>
</html>

