<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Redox Titration Simulator</title>
<style>
* { box-sizing:border-box;margin:0;padding:0; }
body {
  font-family: "Segoe UI", Arial, sans-serif;
  display:flex; flex-direction:column; align-items:center; padding:18px;
  background:#f7fbff; color:#042;
}
h1 { margin-bottom:6px; }
.controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:12px; }
label { background:#fff; padding:8px 10px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
input[type=number], select { padding:6px; border-radius:6px; border:1px solid #cce; width:100px; }
canvas {
  display:block;
  width:100%;
  height:auto;
  max-width:760px;
  aspect-ratio: 760 / 520;
  border-radius:8px;
  border:2px solid #bfe;
  box-shadow:0 6px 18px rgba(10,40,60,0.06);
  background:#fff;
  margin:12px auto;
}
.card { background:#fff; padding:14px 16px; border-radius:10px; box-shadow:0 4px 20px rgba(0,0,0,0.08); width:100%; max-width:760px; margin:10px 0; }
.controls-card .controls label { margin-bottom:6px; }
.canvas-card { display:flex; justify-content:center; align-items:center; overflow:hidden; }
.info { width:100%; max-width:760px; margin-top:10px; background:#fff; padding:10px; border-radius:8px; border:1px solid #e6f2ff; }
.row { display:flex; gap:12px; flex-wrap:wrap; }
.btn { background:#0078d7; color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
.small { font-size:0.9rem; color:#045; }
output { font-weight:700; }
.legend { display:flex; gap:8px; align-items:center; margin-top:8px; }
.swatch { width:20px; height:14px; border-radius:3px; border:1px solid #999; }
@media(max-width:520px){ .controls{flex-direction:column;align-items:stretch} label{width:100%} }
@keyframes pulseGlow {
  0% { box-shadow:0 0 8px #0078D7; }
  50% { box-shadow:0 0 18px #00aaff; }
  100% { box-shadow:0 0 8px #0078D7; }
}
a.proceed {
  display:none; position:fixed; top:10px; left:50%; transform:translateX(-50%);
  background:#0078D7; color:#fff; padding:10px 20px; border-radius:6px;
  text-decoration:none; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.2);
  font-family:Segoe UI, sans-serif; animation:pulseGlow 1.5s infinite; z-index:999;
}
</style>
</head>
<body>

<h1>Redox Titration Simulator</h1>
<p class="small">Default: oxidant in burette (acidified where required). Click canvas to add drops (0.5 mL)</p>
<a id="proceedCalcBtn" class="proceed" href="https://elimuconnect.github.io/ELIMU-CONNECT-/titrations">Proceed to Calculations ➜</a>

<div class="card controls-card">
  <div class="controls">
    <label>Mode:
      <select id="modeSelect">
        <option value="oxidant_buret">Oxidant in burette</option>
        <option value="reductant_buret">Reductant in burette</option>
      </select>
    </label>
    <label>Oxidant:
      <select id="oxidantSelect">
        <option value="KMnO4">KMnO₄</option>
        <option value="K2Cr2O7">K₂Cr₂O₇</option>
        <option value="I2">I₂</option>
        <option value="Ce4">Ce⁴⁺</option>
      </select>
    </label>
    <label>Reductant:
      <select id="reductantSelect">
        <option value="Fe2">Fe²⁺</option>
        <option value="S2O3">S₂O₃²⁻</option>
        <option value="Oxalate">C₂O₄²⁻</option>
      </select>
    </label>
    <label>Analyte Vol (mL): <input id="analyteVol" type="number" value="25" step="1"></label>
    <label>Analyte Conc (M): <input id="analyteConc" type="number" value="0.100" step="0.001"></label>
    <label>Titrant Conc (M): <input id="titrantConc" type="number" value="0.100" step="0.001"></label>
    <label>Acid:
      <select id="acidSelect">
        <option value="H2SO4">H₂SO₄</option>
        <option value="HCl">HCl</option>
        <option value="none">None</option>
      </select>
    </label>
    <button id="calcBtn" class="btn">Calculate</button>
    <button id="resetBtn" class="btn" style="background:#6c757d">Reset</button>
  </div>
</div>

<div class="card canvas-card">
  <canvas id="simCanvas" width="760" height="520"></canvas>
</div>

<div class="card info-card">
  <div class="info">
    <div class="row">
      <div class="small">Reaction: <span id="reactionText">—</span></div>
    </div>
    <div class="row" style="margin-top:8px;gap:18px">
      <div class="small">Analyte moles: <output id="analyteMoles">—</output></div>
      <div class="small">Titrant moles needed: <output id="titrantMoles">—</output></div>
      <div class="small">Added: <output id="addedVol">0.00</output> mL</div>
    </div>
    <div style="margin-top:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <button id="addDropBtn" class="btn">Add drop (0.5 mL)</button>
      <input id="autoAdd" type="checkbox"> <label class="small" for="autoAdd">Auto titrate</label>
    </div>
    <div class="legend">
      <div style="display:flex;gap:6px;align-items:center"><div class="swatch" id="swatchAnalyte"></div><div class="small">Analyte</div></div>
      <div style="display:flex;gap:6px;align-items:center"><div class="swatch" id="swatchTitrant"></div><div class="small">Titrant</div></div>
      <div style="display:flex;gap:6px;align-items:center"><div class="swatch" id="swatchEndpoint"></div><div class="small">Endpoint</div></div>
    </div>
  </div>
</div>

<script>
// ---------- Data ----------
const COLORS = {
  KMnO4:'#7b1fa2', KMnO4_end:'#ffd7e5',
  K2Cr2O7:'#ff8c00', K2Cr2O7_end:'#2e8b57',
  I2:'#5c3a21', starch_blue:'#00008b',
  Ce4:'#ffd700', Ce4_end:'#ffffff',
  Fe2:'#98fb98', Fe3:'#a0522d',
  S2O3:'#ffffff', Oxalate:'#ffffff'
};

const STOICH = {
  KMnO4:{ Fe2:5, Oxalate:5 },
  K2Cr2O7:{ Fe2:6 },
  I2:{ S2O3:2 },
  Ce4:{ Fe2:1 }
};

const REACTIONS = {
  KMnO4:'MnO₄⁻ + 5 Fe²⁺ + 8 H⁺ → Mn²⁺ + 5 Fe³⁺ + 4 H₂O',
  K2Cr2O7:'Cr₂O₇²⁻ + 6 Fe²⁺ + 14 H⁺ → 2 Cr³⁺ + 6 Fe³⁺ + 7 H₂O',
  I2:'I₂ + 2 S₂O3²⁻ → 2 I⁻ + S₄O6²⁻',
  Ce4:'Ce⁴⁺ + Fe²⁺ → Ce³⁺ + Fe³⁺'
};

// ---------- UI ----------
const modeSelect=document.getElementById('modeSelect'),
      oxidantSel=document.getElementById('oxidantSelect'),
      reductantSel=document.getElementById('reductantSelect'),
      analyteVolEl=document.getElementById('analyteVol'),
      analyteConcEl=document.getElementById('analyteConc'),
      titrantConcEl=document.getElementById('titrantConc'),
      acidSel=document.getElementById('acidSelect'),
      reactionText=document.getElementById('reactionText'),
      analyteMolesOut=document.getElementById('analyteMoles'),
      titrantMolesOut=document.getElementById('titrantMoles'),
      addedVolOut=document.getElementById('addedVol'),
      swatchAnalyte=document.getElementById('swatchAnalyte'),
      swatchTitrant=document.getElementById('swatchTitrant'),
      swatchEndpoint=document.getElementById('swatchEndpoint'),
      addDropBtn=document.getElementById('addDropBtn'),
      calcBtn=document.getElementById('calcBtn'),
      resetBtn=document.getElementById('resetBtn'),
      autoAdd=document.getElementById('autoAdd'),
      proceedBtn=document.getElementById('proceedCalcBtn'),
      canvas=document.getElementById('simCanvas');

const ctx=canvas.getContext('2d');

let analyteMoles=0, titrantMolesNeeded=0, addedVol=0, titrantVolNeeded=0, dropVolume=0.5, drops=[], autoInterval=null, scaleFactor=1;

// ---------- Helpers ----------
function toSF4(x){ return isFinite(x)?Number(Number(x).toPrecision(4)): '—'; }

// ---------- Compute ----------
function computeValues(){
  const mode = modeSelect.value;
  const titrantKey = (mode==='oxidant_buret')? oxidantSel.value : reductantSel.value;
  const analyteKey = (mode==='oxidant_buret')? reductantSel.value : oxidantSel.value;
  const pair = STOICH[titrantKey];
  if(!pair || !pair[analyteKey]) {
    reactionText.textContent='Pair not supported';
    analyteMolesOut.textContent=titrantMolesOut.textContent='—';
    return false;
  }
  analyteMoles = (parseFloat(analyteConcEl.value)||0) * (parseFloat(analyteVolEl.value)||0)/1000;
  titrantMolesNeeded = analyteMoles / pair[analyteKey];
  titrantVolNeeded = titrantMolesNeeded / (parseFloat(titrantConcEl.value)||1) *1000;

  analyteMolesOut.textContent = toSF4(analyteMoles);
  titrantMolesOut.textContent = toSF4(titrantMolesNeeded);
  reactionText.textContent = REACTIONS[titrantKey]||'Reaction';

  swatchAnalyte.style.background = COLORS[analyteKey]||'#fff';
  swatchTitrant.style.background = COLORS[titrantKey]||'#ddd';
  swatchEndpoint.style.background = (titrantKey==='KMnO4')? COLORS.KMnO4_end:
                                   (titrantKey==='K2Cr2O7')? COLORS.K2Cr2O7_end:
                                   (titrantKey==='I2')? COLORS.starch_blue:
                                   (titrantKey==='Ce4')? COLORS.Ce4_end:'#fff';

  addedVol=0; addedVolOut.textContent='0.00'; drops=[];
  proceedBtn.style.display='none';
  draw();
}

// ---------- Canvas Resize ----------
function resizeCanvas(){
  const pixelRatio = window.devicePixelRatio||1;
  const availableWidth = Math.min(window.innerWidth-40,760);
  scaleFactor = availableWidth/760;
  canvas.width = 760*scaleFactor*pixelRatio;
  canvas.height = 520*scaleFactor*pixelRatio;
  canvas.style.width = 760*scaleFactor+'px';
  canvas.style.height = 520*scaleFactor+'px';
  ctx.setTransform(pixelRatio*scaleFactor,0,0,pixelRatio*scaleFactor,0,0);
  draw();
}

// ---------- Draw ----------
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const scale = scaleFactor;
  const centerX = 380; // 760/2

  // Burette
  const buretteTop=40*scale, buretteHeight=300*scale, radiusX=26*scale, radiusY=10*scale;
  ctx.lineWidth=1.5; ctx.strokeStyle='#000'; ctx.fillStyle='#f8ffffaa';
  ctx.beginPath(); ctx.ellipse(centerX,buretteTop,radiusX,radiusY,0,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(centerX-radiusX,buretteTop); ctx.lineTo(centerX-radiusX,buretteTop+buretteHeight);
  ctx.moveTo(centerX+radiusX,buretteTop); ctx.lineTo(centerX+radiusX,buretteTop+buretteHeight); ctx.stroke();
  ctx.beginPath(); ctx.ellipse(centerX,buretteTop+buretteHeight,radiusX,radiusY,0,0,Math.PI*2); ctx.stroke();

  // Burette liquid
  const mode = modeSelect.value;
  const titrantKey = (mode==='oxidant_buret')? oxidantSel.value : reductantSel.value;
  ctx.fillStyle=COLORS[titrantKey]||'#cfc'; ctx.globalAlpha=0.18;
  ctx.fillRect(centerX-radiusX+3,buretteTop+5*scale,2*(radiusX-3),buretteHeight-8*scale);
  ctx.globalAlpha=1;

  // Burette ticks
  ctx.strokeStyle='#000'; ctx.fillStyle='#000'; ctx.font=`${13*scale}px Arial`;
  for(let i=0;i<=50;i++){
    const y=buretteTop+i*buretteHeight/50, tickLen=(i%5===0)?12:6;
    ctx.beginPath(); ctx.moveTo(centerX-radiusX-tickLen*scale,y); ctx.lineTo(centerX-radiusX,y); ctx.stroke();
    if(i%5===0) ctx.fillText(Math.round(i/50*50)+' cm³',centerX-radiusX-55*scale,y+4);
  }

  // Tap
  ctx.fillStyle='#888'; ctx.fillRect(centerX-25*scale,buretteTop+buretteHeight-10*scale,50*scale/1.2,10*scale/1.2);
  ctx.strokeStyle='#000'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(centerX+35*scale,buretteTop+buretteHeight-10*scale);
  ctx.lineTo(centerX+3*scale,buretteTop+buretteHeight+10*scale); ctx.stroke();

  // Flask
  const fw=200*scale, fh=230*scale, fx=centerX-fw/2, fy=buretteTop+buretteHeight-10*scale;
  ctx.strokeStyle='#000'; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(fx+25*scale,fy+fh); ctx.lineTo(fx+fw-25*scale,fy+fh);
  ctx.lineTo(fx+fw-55*scale,fy+50*scale); ctx.lineTo(fx+55*scale,fy+50*scale); ctx.closePath(); ctx.stroke();

  // Flask liquid
  const analyteKey = (mode==='oxidant_buret')? reductantSel.value : oxidantSel.value;
  const startColor = COLORS[analyteKey]||'#fff';
  const endColor = swatchEndpoint.style.backgroundColor;
  const frac = Math.min(1,addedVol/(titrantVolNeeded||Infinity));
  function hexToRgb(h){ const c=h.replace('#',''); return [parseInt(c.substr(02,2),16),parseInt(c.substr(2,2),16),parseInt(c.substr(4,2),16)]; }
  function interp(a,b,f){ return `rgb(${Math.round(a[0]+(b[0]-a[0])*f)},${Math.round(a[1]+(b[1]-a[1])*f)},${Math.round(a[2]+(b[2]-a[2])*f)})`; }
  const flaskColor=interp(hexToRgb(startColor),hexToRgb(endColor),frac);
  const liquidHeight=Math.min(1,(parseFloat(analyteVolEl.value)||25)/250)*fh;
  ctx.fillStyle=flaskColor; ctx.globalAlpha=0.8;
  ctx.beginPath();
  ctx.moveTo(fx+55*scale,fy+fh-liquidHeight);
  ctx.lineTo(fx+fw-55*scale,fy+fh-liquidHeight);
  ctx.lineTo(fx+fw-55*scale,fy+fh);
  ctx.lineTo(fx+55*scale,fy+fh); ctx.closePath(); ctx.fill();
  ctx.globalAlpha=1;

  // Drops
  ctx.fillStyle=titrantKey? COLORS[titrantKey]:'#00f';
  drops.forEach(d=>ctx.beginPath(),ctx.arc(d.x,d.y,4*scale,0,Math.PI*2),ctx.fill());
}

// ---------- Add drop ----------
function addDrop(){
  const scale=scaleFactor;
  const centerX=380; const buretteTop=40*scale; const buretteHeight=300*scale;
  drops.push({ x:centerX, y:buretteTop+buretteHeight+10*scale, vx:0, vy:0 });
  addedVol+=dropVolume; addedVolOut.textContent=addedVol.toFixed(2);
  if(addedVol>=titrantVolNeeded) proceedBtn.style.display='block';
}

// ---------- Animate drops ----------
function animateDrops(){
  const scale=scaleFactor;
  const fw=200*scale, fh=230*scale, fx=380-fw/2, fy=40*scale+300*scale-10*scale;
  for(let i=drops.length-1;i>=0;i--){
    let d=drops[i]; d.vy+=0.6; d.y+=d.vy; d.x+=d.vx;
    if(d.y>=fy) drops.splice(i,1);
  }
  draw();
  requestAnimationFrame(animateDrops);
}

// ---------- Events ----------
addDropBtn.onclick=()=>addDrop();
calcBtn.onclick=()=>computeValues();
resetBtn.onclick=()=>computeValues();
window.onresize=()=>resizeCanvas();
autoAdd.onchange=function(){
  if(this.checked) autoInterval=setInterval(()=>addDrop(),300);
  else clearInterval(autoInterval);
};
canvas.onclick=()=>addDrop();

// ---------- Init ----------
computeValues(); resizeCanvas(); animateDrops();

</script>

</body>
</html>
