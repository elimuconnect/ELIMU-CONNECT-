<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Lesson Tutor</title>

<!-- External libraries -->
<script defer src="https://unpkg.com/mathlive"></script>
<script defer src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mespeak/1.0.1/mespeak.min.js"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; background-color: #f0f4f8; }
textarea, .ML__textarea { width:100%; height:150px; margin:10px 0; font-size:16px; padding:10px; border-radius:6px; border:1px solid #ccc; }
button { margin:5px; padding:10px 20px; font-size:16px; border:none; background-color:#0077cc; color:white; border-radius:5px; cursor:pointer; }
button:hover { background-color:#005fa3; }
#editor { margin-top:20px; padding:15px; border:1px solid #ccc; background-color:#fff; border-radius:8px; min-height:150px; }
#status { margin-top:15px; font-weight:bold; color:green; }
.math { font-family: 'Courier New', monospace; background-color:#eef; padding:3px 6px; border-radius:4px; color:#004080; display:inline-block; }
.highlight-note { background-color:#fff8dc; border-left:5px solid #f0ad4e; padding:6px 10px; margin:5px 0; border-radius:4px; font-weight:bold; color:#5a4500; }
img { max-width:100%; margin:10px 0; }
label { font-weight:bold; }
select { margin:0 10px 15px 5px; padding:6px 10px; font-size:16px; border-radius:5px; border:1px solid #ccc; }
</style>
</head>
<body>

<h2>üìò Tutor Lesson Loader</h2>

<label for="lessonText">Paste your custom lesson content here:</label>
<textarea id="lessonText" placeholder="Lesson 1: Intro to Math..."></textarea>
<button id="parseLessonsBtn">üìñ Parse Pasted Lessons</button>
<br><br>

<input type="file" id="lessonFile" accept=".docx">
<button id="loadWordBtn">üì• Load Word Lesson (.docx)</button>

<div id="editor" contenteditable="true"></div>
<math-field id="mathInput" virtual-keyboard-mode="onfocus" style="margin-top: 10px;"></math-field>
<div id="status"></div>
<br>

<input type="file" id="imageUpload" accept="image/*">

<label for="voiceLang">Select voice language:</label>
<select id="voiceLang">
  <option value="en" selected>English</option>
  <option value="sw">Swahili (fallback to English)</option>
</select>
<br>

<button id="prevLessonBtn">‚¨ÖÔ∏è Previous Lesson</button>
<button id="nextLessonBtn">‚û°Ô∏è Next Lesson</button>
<button id="readAloudBtn">üîä Read Aloud</button>
<button id="pauseSpeechBtn">‚è∏Ô∏è Pause</button>
<button id="resumeSpeechBtn">‚ñ∂Ô∏è Resume</button>
<button id="printLessonBtn">üñ®Ô∏è Print</button>
<button id="downloadLessonBtn">üì• Download</button>

<script>
let lessonsArray = [];
let currentLesson = 0;
let tutorStarted = false;
let ocrTexts = [];
let speechQueue = [];
let speakingIndex = 0;
let pausedSpeech = false;

// ====== meSpeak setup ======
meSpeak.loadConfig("https://cdnjs.cloudflare.com/ajax/libs/mespeak/1.0.1/mespeak_config.json");
meSpeak.loadVoice("https://cdnjs.cloudflare.com/ajax/libs/mespeak/1.0.1/voices/en/en-us.json");

// ====== Lesson Parsing ======
function parseLessonBlocks(text) {
    const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
    const parsed = [];
    let block = "";
    for (let line of lines) {
        if (line.toLowerCase().startsWith("lesson")) {
            if (block) parsed.push(block.trim());
            block = line;
        } else {
            block += "\n" + line;
        }
    }
    if (block) parsed.push(block.trim());
    return parsed;
}

function showLesson(index) {
    if (index >= 0 && index < lessonsArray.length) {
        const editor = document.getElementById("editor");
        const lines = lessonsArray[index].split(/\r?\n/).filter(line => line.trim() !== "");
        const htmlList = lines.map(line => {
            let html = line.trim();
            const mdImageMatch = html.match(/!\[.*?\]\((.*?)\)/);
            if (mdImageMatch) html = `<img src="${mdImageMatch[1]}" alt="Lesson Image" style="max-width:100%; margin:10px 0;">`;
            if (/[=+\-^‚àö*\/]/.test(html) && !/^lesson/i.test(html)) html = `<span class="math">${html}</span>`;
            const keywordPatterns = ["Definition", "Example", "Note", "Theorem", "Important"];
            const matchedKeyword = keywordPatterns.find(k => html.toLowerCase().startsWith(k.toLowerCase()));
            if (matchedKeyword) html = `<div class="highlight-note"><strong>${html}</strong></div>`;
            return `<li>${html}</li>`;
        }).join("");
        editor.innerHTML = `<ul>${htmlList}</ul>`;
        document.getElementById("status").textContent = `üü¢ Showing Lesson ${index + 1} of ${lessonsArray.length}`;
        currentLesson = index;
        localStorage.setItem("currentLesson", currentLesson);
    }
}

function saveLessons() {
    localStorage.setItem("lessonsArray", JSON.stringify(lessonsArray));
    localStorage.setItem("currentLesson", currentLesson);
}

function parsePastedLessons() {
    const text = document.getElementById("lessonText").value.trim();
    if (!text) return alert("Please paste a lesson.");
    lessonsArray = parseLessonBlocks(text);
    tutorStarted = true;
    currentLesson = 0;
    saveLessons();
    showLesson(currentLesson);
}

// ====== Word Loader ======
function loadCustomLesson() {
    const fileInput = document.getElementById("lessonFile");
    const file = fileInput.files[0];
    if (!file || !file.name.endsWith(".docx")) return alert("Select a .docx file.");
    const reader = new FileReader();
    reader.onload = function(e) {
        mammoth.convertToHtml({ arrayBuffer: e.target.result }).then(result => {
            const html = result.value.replace(/<ul>|<\/ul>|<li>|<\/li>/g, '');
            document.getElementById("editor").innerHTML = html;
            lessonsArray = [html];
            tutorStarted = true;
            currentLesson = 0;
            saveLessons();
        }).catch(()=>alert("Failed to load .docx"));
    };
    reader.readAsArrayBuffer(file);
}

// ====== Lesson Navigation ======
function prevLesson() { if(!tutorStarted) return alert("Load lessons first."); if(currentLesson>0) showLesson(currentLesson-1); }
function nextLesson() { if(!tutorStarted) return alert("Load lessons first."); if(currentLesson<lessonsArray.length-1) showLesson(currentLesson+1); }

// ====== Text-to-Speech ======
function readLessonAloud() {
    if(!tutorStarted || lessonsArray.length===0) return alert("No lesson loaded.");
    const editorText = document.getElementById("editor").innerText;
    const mathText = document.getElementById("mathInput")?.getValue?.() || "";
    const combined = [
        editorText,
        mathText ? ("Math expression: " + mathText) : "",
        ocrTexts.length ? ("Text from images: " + ocrTexts.join(". ")) : ""
    ].filter(Boolean).join("\n");

    speechQueue = combined.split(/(?<=[.!?])\s+/);
    speakingIndex = 0;
    pausedSpeech = false;
    speakNext();
}

function speakNext() {
    if(speakingIndex >= speechQueue.length || pausedSpeech) return;
    meSpeak.speak(speechQueue[speakingIndex], { amplitude:100, pitch:50, speed:150 }, ()=>{
        speakingIndex++;
        speakNext();
    });
}

function pauseSpeech() { pausedSpeech = true; meSpeak.speakStop(); }
function resumeSpeech() { if(pausedSpeech){ pausedSpeech=false; speakNext(); } }

// ====== Print & Download ======
function printLesson() {
    if(!tutorStarted) return alert("Load a lesson first.");
    const printWindow = window.open('','_blank');
    printWindow.document.write('<html><head><title>Print Lesson</title></head><body>');
    printWindow.document.write(document.getElementById("editor").innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

function downloadLesson() {
    if(!tutorStarted) return alert("Load a lesson first.");
    const blob = new Blob([document.getElementById("editor").innerHTML],{type:"text/html"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `lesson_${currentLesson+1}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ====== Load saved lessons ======
window.addEventListener('DOMContentLoaded', ()=>{
    const savedLessons = localStorage.getItem("lessonsArray");
    const savedCurrent = localStorage.getItem("currentLesson");
    if(savedLessons) { lessonsArray = JSON.parse(savedLessons); tutorStarted=true; currentLesson = savedCurrent ? parseInt(savedCurrent,10):0; showLesson(currentLesson); }

    document.getElementById("parseLessonsBtn").addEventListener("click", parsePastedLessons);
    document.getElementById("loadWordBtn").addEventListener("click", loadCustomLesson);
    document.getElementById("prevLessonBtn").addEventListener("click", prevLesson);
    document.getElementById("nextLessonBtn").addEventListener("click", nextLesson);
    document.getElementById("readAloudBtn").addEventListener("click", readLessonAloud);
    document.getElementById("pauseSpeechBtn").addEventListener("click", pauseSpeech);
    document.getElementById("resumeSpeechBtn").addEventListener("click", resumeSpeech);
    document.getElementById("printLessonBtn").addEventListener("click", printLesson);
    document.getElementById("downloadLessonBtn").addEventListener("click", downloadLesson);

    document.getElementById("imageUpload").addEventListener("change", e=>{
        const file=e.target.files[0];
        if(!file) return;
        const reader=new FileReader();
        reader.onload=function(){
            const img=new Image();
            img.src=reader.result;
            img.onload=()=>{ 
                Tesseract.recognize(img,'eng',{logger:m=>console.log(m)})
                    .then(({data:{text}})=>{ if(text.trim()) {ocrTexts.push(text.trim()); alert("OCR Result:\n"+text.trim()); }});
            };
        };
        reader.readAsDataURL(file);
    });

    document.getElementById("voiceLang").addEventListener("change", ()=>{
        const lang = document.getElementById("voiceLang").value;
        if(lang==='sw') alert("Swahili voice not loaded yet, defaulting to English.");
    });
});
</script>

</body>
</html>
